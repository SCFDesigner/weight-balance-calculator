<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Weight & Balance Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            margin: 0;
            padding: 0;
            position: relative;
            overflow: hidden;
        }

        /* Hyperspace Canvas Background */
        #hyperspace-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        /* Normal Space Canvas Background (Floating Stars) */
        #normalspace-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        /* Lightspeed Mode Control */
        body.lightspeed-off #hyperspace-canvas {
            display: none;
        }

        body.lightspeed-off #normalspace-canvas {
            display: block;
        }

        body.lightspeed-on #hyperspace-canvas {
            display: block;
        }

        body.lightspeed-on #normalspace-canvas {
            display: none;
        }

        /* Mobile lightspeed-off background fix */
        @media (max-width: 768px) {
            body.lightspeed-off html,
            body.lightspeed-off {
                background-color: transparent !important;
            }
        }

        /* Lightspeed Mode Indicator */
        body.lightspeed-on #lightspeed-toggle {
            color: #00ff88 !important;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        body.lightspeed-off #lightspeed-toggle {
            color: #666 !important;
        }

        /* Ensure panels are above background */
        .desktop-layout,
        .mobile-layout {
            position: relative;
            z-index: 2;
        }

        .left-panel {
            width: 340px;
            min-width: 340px;
            padding: 20px;
            background-color: transparent;
            overflow-y: auto;
            overflow-x: hidden;
            height: 100vh;
            box-sizing: border-box;
        }

        .input-section {
            background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        /* Time panel styling */
        .time-panel {
            background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            box-sizing: border-box;
            width: 100%;
            min-height: fit-content;
            height: auto;
        }

        .time-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%;
        }

        .time-item {
            background-color: #4a4a4a;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            box-sizing: border-box;
        }

        .time-label {
            font-size: 11px;
            color: #ccc;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .time-value {
            font-size: 14px;
            color: #4CAF50;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        .input-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .input-group:last-child {
            margin-bottom: 0;
        }

        .input-label {
            font-size: 14px;
            font-weight: 500;
            color: #e0e0e0;
            min-width: 120px;
        }

        .input-field {
            background-color: #4a4a4a;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 8px 12px;
            color: #ffffff;
            font-size: 14px;
            min-width: 110px;
            max-width: 110px;
            width: 110px;
            -webkit-appearance: textfield;
            -moz-appearance: textfield;
            appearance: textfield;
        }

        .input-field::-webkit-outer-spin-button,
        .input-field::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .input-field:focus {
            outline: none;
            border-color: #007acc;
            background-color: #505050;
            box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
        }

        .input-field::placeholder {
            color: #888;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            background-color: transparent;
            overflow-y: auto;
        }

        .section-divider {
            height: 1px;
            background-color: #555;
            margin: 15px 0;
        }

        .right-panel {
            background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #444;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .tail-number-display {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .calculator-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            color: #4CAF50;
            margin-bottom: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }

        .data-table th {
            background-color: #4a4a4a;
            color: #ffffff;
            padding: 8px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            border: 1px solid #555;
        }

        .data-table td {
            background-color: #2a2a2a;
            color: #e0e0e0;
            padding: 8px 12px;
            border: 1px solid #555;
            font-size: 14px;
        }

        .data-table tr:nth-child(even) td {
            background-color: #404040;
        }

        .panel-title {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            color: #4CAF50;
            margin-bottom: 15px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #404040;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        .info-label {
            color: #e0e0e0;
            font-weight: 500;
        }

        .info-value {
            color: #ffffff;
            font-weight: 600;
        }

        .airspeed-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .airspeed-item {
            background-color: #404040;
            padding: 6px 8px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
            color: #e0e0e0;
        }

        .time-panel {
            background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .time-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 15px;
        }

        .time-item {
            text-align: center;
            background-color: #404040;
            padding: 12px;
            border-radius: 8px;
        }

        .time-label {
            font-size: 12px;
            color: #cccccc;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .time-value {
            font-size: 18px;
            color: #ffffff;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .select-field {
            background-color: #4a4a4a;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 8px 12px;
            color: #ffffff;
            font-size: 14px;
            min-width: 110px;
            max-width: 110px;
            width: 110px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpath d='m6 9 6 6 6 6-6'/%3e%3cpath d='m18 15-6-6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 12px;
            padding-right: 36px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .select-field:focus {
            border-color: #007acc;
            box-shadow: 0 0 8px rgba(0, 122, 204, 0.3);
        }

        /* Bottom Navigation - Floating Style */
        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
            display: flex;
            justify-content: space-around;
            padding: 15px 10px;
            border-radius: 50px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            border: 1px solid #555;
            backdrop-filter: blur(10px);
        }

        .nav-button {
            background: none;
            border: none;
            color: #cccccc;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 16px;
            cursor: pointer;
            transition: color 0.3s ease;
            font-size: 12px;
            min-height: 44px;
            min-width: 44px;
        }

        .nav-button:hover {
            color: #4CAF50;
        }

        .nav-button.active {
            color: #4CAF50;
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 2px;
        }

        /* Tab Content Areas */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Performance Calculation Tooltips */
        .performance-tooltip {
            position: relative;
            cursor: help;
        }
        
        .performance-tooltip .tooltip-content {
            visibility: hidden;
            width: 300px;
            background-color: #2a2a2a;
            color: #ffffff;
            border: 1px solid #555;
            border-radius: 6px;
            padding: 12px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-size: 11px;
            line-height: 1.4;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .performance-tooltip .tooltip-content::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #2a2a2a transparent transparent transparent;
        }
        
        .performance-tooltip:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }
        
        .tooltip-title {
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .tooltip-formula {
            background-color: #1a1a1a;
            padding: 6px;
            border-radius: 4px;
            margin: 4px 0;
            font-family: 'Courier New', monospace;
            font-size: 10px;
        }
        
        .tooltip-note {
            color: #cccccc;
            font-style: italic;
            margin-top: 6px;
        }

        /* Right Column (Second Column) */
        .right-column {
            flex: 1;
            padding: 20px;
            padding-bottom: 120px; /* Extra bottom padding for mobile nav clearance */
            background-color: transparent;
            overflow-y: auto;
            height: 100vh;
            min-width: 400px;
        }

        /* Risk Assessment Column (Third Column) */
        .risk-column {
            width: 650px;
            min-width: 650px;
            padding: 20px;
            display: none; /* Hidden by default on web version */
            background-color: transparent;
            overflow-y: auto;
            height: 100vh;
            flex-shrink: 0;
        }

        /* CG Chart container with 16:10 aspect ratio */
        .cg-chart-container {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 62.5%; /* 16:10 aspect ratio (10/16 = 0.625) */
            background-color: #1a1a1a;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #333;
        }

        .cg-chart-container canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
        }

        /* Brain Panel Styling */
        .brain-panel {
            width: 350px;
            min-width: 350px;
            flex-shrink: 0;
            background-color: transparent;
            border-radius: 0;
            margin-bottom: 0;
            transition: all 0.3s ease;
        }

        .mnemonic-item {
            margin-bottom: 10px;
            border: 1px solid #444;
            border-radius: 6px;
            overflow: hidden;
            background-color: #333;
        }

        .mnemonic-title {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
            color: #e0e0e0;
            font-weight: bold;
            transition: background-color 0.2s ease;
        }

        .mnemonic-title:hover {
            background-color: rgba(76, 175, 80, 0.2);
        }

        .expand-icon {
            font-size: 18px;
            font-weight: bold;
            color: #4CAF50;
        }

        .mnemonic-detail {
            padding: 15px;
            background-color: #1a1a1a;
            border-top: 1px solid #444;
            color: #ccc;
            line-height: 1.6;
        }

        .mnemonic-detail p {
            margin: 8px 0;
        }

        .mnemonic-detail strong {
            color: #4CAF50;
        }

        .mnemonic-detail hr {
            border: none;
            border-top: 1px solid #555;
            margin: 15px 0;
        }

        .mnemonic-detail em {
            color: #aaa;
            font-style: italic;
        }

        /* Settings Panel (Third Column) */
        .settings-panel {
            width: 350px;
            min-width: 350px;
            padding: 20px;
            background-color: transparent;
            overflow-y: auto;
            height: 100vh;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        /* Hidden settings panel */
        .settings-panel.settings-hidden {
            display: none;
        }

        /* Desktop layout when settings are collapsed */
        .desktop-layout.settings-collapsed .right-column {
            flex: 1;
            max-width: none;
        }

        /* Floating Settings Toggle */
        .settings-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: #4CAF50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .settings-toggle:hover {
            background-color: #45a049;
            transform: scale(1.1);
        }

        /* Risk Assessment Styles */
        .risk-panel {
            background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .risk-panel-title {
            color: #4CAF50;
            font-size: 18px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            text-align: center;
            margin-bottom: 15px;
        }

        .risk-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 10px;
        }

        .risk-numbers {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            gap: 4px;
            flex: 1;
            font-weight: bold;
            color: #ccc;
        }

        .risk-numbers span {
            text-align: center;
            font-size: 14px;
        }

        .risk-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px 0;
        }

        .risk-row.stacked {
            flex-direction: column;
            align-items: stretch;
        }

        .risk-row.stacked .risk-label {
            margin-bottom: 8px;
            min-width: auto;
            text-align: left;
        }

        .risk-row.stacked .risk-content {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 0;
        }

        .risk-row.stacked .risk-buttons {
            margin-left: 160px; /* Same as risk-label min-width to maintain alignment */
            margin-right: auto;
        }

        .risk-row.stacked .risk-total {
            margin-left: auto;
        }

        .risk-label {
            font-size: 14px;
            color: #e0e0e0;
            min-width: 160px;
            flex-shrink: 0;
        }

        .risk-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            gap: 4px;
            flex: 1;
            align-items: center;
        }

        .risk-btn {
            min-width: 60px;
            height: 34px;
            border: 1px solid #555;
            border-radius: 6px;
            background: linear-gradient(135deg, #404040 0%, #2a2a2a 100%);
            color: #ccc;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px 6px;
            text-align: center;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .risk-btn:disabled {
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            color: #555;
            cursor: not-allowed;
            border-color: #333;
        }

        .risk-btn:hover {
            border-color: #007acc;
            transform: scale(1.05);
        }

        .risk-btn.selected-1 {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3) 0%, rgba(76, 175, 80, 0.1) 100%);
            color: white;
            border: 2px solid #4CAF50;
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }

        .risk-btn.selected-2 {
            background: linear-gradient(135deg, rgba(139, 195, 74, 0.3) 0%, rgba(139, 195, 74, 0.1) 100%);
            color: white;
            border: 2px solid #8BC34A;
            box-shadow: 0 4px 8px rgba(139, 195, 74, 0.3);
        }

        .risk-btn.selected-3 {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.3) 0%, rgba(255, 193, 7, 0.1) 100%);
            color: white;
            border: 2px solid #FFC107;
            box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
        }

        .risk-btn.selected-4 {
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.3) 0%, rgba(255, 152, 0, 0.1) 100%);
            color: white;
            border: 2px solid #FF9800;
            box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3);
        }

        .risk-btn.selected-5 {
            background: linear-gradient(135deg, rgba(255, 87, 34, 0.3) 0%, rgba(255, 87, 34, 0.1) 100%);
            color: white;
            border: 2px solid #FF5722;
            box-shadow: 0 4px 8px rgba(255, 87, 34, 0.3);
        }

        .risk-total {
            font-weight: bold;
            color: #4CAF50;
            min-width: 50px;
            text-align: center;
            flex-shrink: 0;
        }

        .grand-total {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            margin-top: 10px;
        }

        .grand-total.green {
            background-color: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            border: 2px solid #4CAF50;
        }

        .grand-total.yellow {
            background-color: rgba(255, 193, 7, 0.2);
            color: #FFC107;
            border: 2px solid #FFC107;
        }

        .grand-total.red {
            background-color: rgba(244, 67, 54, 0.2);
            color: #f44336;
            border: 2px solid #f44336;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            html, body {
                margin: 0;
                padding: 0;
                height: 100vh;
                overflow: hidden;
                background-color: transparent !important;
            }

            /* Override desktop column widths on mobile */
            .risk-column {
                width: calc(100% - 40px) !important;
                min-width: calc(100% - 40px) !important;
                max-width: 95% !important;
            }

            /* Desktop layout becomes mobile column container */
            .desktop-layout {
                display: flex !important;
                height: calc(100vh - 80px);
                overflow: hidden;
                transition: transform 0.3s ease;
                width: 90vw; /* Reduced to show background on sides */
                position: relative;
                margin: 0 auto; /* Center the layout */
                left: 0; /* Remove conflicting offset */
            }

            /* Hide all columns by default on mobile */
            .left-panel,
            .right-column,
            .settings-panel,
            .brain-panel {
                display: none;
                width: calc(100% - 40px); /* Responsive width with margins */
                height: 100%;
                position: absolute;
                top: 0;
                left: 50%; /* Center horizontally */
                transform: translateX(-50%); /* Center the panel */
                z-index: 5;
                overflow-y: auto;
                border-radius: 12px; /* Add rounded corners */
                margin: 0; /* Remove margin */
                max-width: 95%; /* Ensure it doesn't exceed screen */
                box-sizing: border-box;
            }

            /* Show mobile navigation only on mobile */
            .mobile-nav {
                display: flex !important;
            }

            /* Compact mobile panel spacing */
            .left-panel .input-section,
            .right-column .input-section {
                padding: 12px;
                margin-bottom: 10px;
            }

            .left-panel .input-group,
            .right-column .input-group {
                margin-bottom: 8px;
            }

            .left-panel .right-panel,
            .right-column .right-panel {
                margin-bottom: 12px;
                padding: 12px;
            }

            .left-panel .panel-title,
            .right-column .panel-title {
                font-size: 16px;
                margin-bottom: 8px;
            }

            /* Compact settings panel for mobile */
            .settings-panel {
                padding: 8px !important;
            }

            .settings-panel .input-section {
                padding: 10px;
                margin-bottom: 8px;
            }

            .settings-panel .input-group {
                margin-bottom: 6px;
            }

            .settings-panel h2 {
                font-size: 16px !important;
                margin-bottom: 12px !important;
            }

            .settings-panel button {
                padding: 8px 12px !important;
                font-size: 12px !important;
                margin: 2px !important;
            }

            /* Compact data tables on mobile */
            .data-table {
                font-size: 11px;
                margin-bottom: 10px;
            }

            .data-table th,
            .data-table td {
                padding: 4px 6px;
            }

            /* Compact info grids on mobile */
            .info-grid {
                gap: 6px;
                margin-bottom: 8px;
            }

            .info-item {
                padding: 6px 8px;
            }

            .info-label,
            .info-value {
                font-size: 11px;
            }

            /* Compact airspeed grid on mobile */
            .airspeed-grid {
                gap: 6px;
                margin-bottom: 8px;
            }

            .airspeed-item {
                padding: 6px 8px;
            }

            .airspeed-label,
            .airspeed-value {
                font-size: 11px;
            }

            /* Responsive time panel on mobile */
            .time-panel {
                margin-bottom: 10px;
                padding: 10px;
                width: 100%;
                max-width: 100%;
                height: auto;
                min-height: fit-content;
            }

            .time-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                width: 100%;
            }

            .time-item {
                padding: 8px 6px;
                background-color: #4a4a4a;
                border-radius: 6px;
                text-align: center;
                min-width: 0;
                box-sizing: border-box;
            }

            .time-label {
                font-size: 9px;
                color: #ccc;
                margin-bottom: 2px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .time-value {
                font-size: 11px;
                font-weight: bold;
                color: #4CAF50;
                font-family: 'Courier New', monospace;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* Responsive chart container */
            .chart-container {
                height: 200px !important;
                margin-bottom: 10px;
            }

            .chart-container canvas {
                max-width: 100%;
                height: 100% !important;
            }

            /* CG Chart responsive on mobile */
            .cg-chart-container {
                padding-bottom: 62.5%; /* Maintain 16:10 aspect ratio */
                margin-bottom: 15px;
            }

            /* Responsive data table */
            .data-table-container {
                overflow-x: auto;
                margin-bottom: 10px;
            }

            .data-table {
                min-width: 300px;
                width: 100%;
            }

            /* Compact button layouts */
            .button-row {
                display: flex;
                flex-wrap: wrap;
                gap: 4px;
                margin-bottom: 8px;
            }

            .button-row button {
                flex: 1;
                min-width: 80px;
                padding: 6px 8px;
                font-size: 11px;
            }

            /* Show specific columns based on mobile state */
            .desktop-layout.mobile-show-left .left-panel {
                display: block !important;
                position: absolute;
                top: 0;
                left: 50%; /* Center horizontally */
                transform: translateX(-50%); /* Center the panel */
                z-index: 10;
                width: calc(100% - 40px); /* Responsive width with margins */
                height: 100%;
                overflow-y: auto;
                overflow-x: hidden;
                padding: 10px;
                box-sizing: border-box;
                border-radius: 12px;
                max-width: 95%; /* Ensure it doesn't exceed screen */
            }

            .desktop-layout.mobile-show-left .right-column,
            .desktop-layout.mobile-show-left .risk-column,
            .desktop-layout.mobile-show-left .settings-panel {
                display: none !important;
            }

            .desktop-layout.mobile-show-right .right-column {
                display: block !important;
                position: absolute;
                top: 0;
                left: 50%; /* Center horizontally */
                transform: translateX(-50%); /* Center the panel */
                z-index: 10;
                width: calc(100% - 40px); /* Responsive width with margins */
                height: 100%;
                overflow-y: auto;
                overflow-x: hidden;
                padding: 10px;
                box-sizing: border-box;
                border-radius: 12px;
                max-width: 95%; /* Ensure it doesn't exceed screen */
            }

            .desktop-layout.mobile-show-right .left-panel,
            .desktop-layout.mobile-show-right .risk-column,
            .desktop-layout.mobile-show-right .settings-panel {
                display: none !important;
            }

            .desktop-layout.mobile-show-risk .risk-column {
                display: block !important;
                position: absolute;
                top: 0;
                left: 50%; /* Center horizontally */
                transform: translateX(-50%); /* Center the panel */
                z-index: 10;
                width: calc(100% - 40px); /* Responsive width with margins */
                height: 100%;
                overflow-y: auto;
                overflow-x: hidden;
                padding: 10px;
                box-sizing: border-box;
                border-radius: 12px;
                max-width: 95%; /* Ensure it doesn't exceed screen */
            }

            .desktop-layout.mobile-show-risk .left-panel,
            .desktop-layout.mobile-show-risk .right-column,
            .desktop-layout.mobile-show-risk .settings-panel {
                display: none !important;
            }

            .desktop-layout.mobile-show-settings .settings-panel {
                display: block !important;
                position: absolute;
                top: 0;
                left: 50%; /* Center horizontally */
                transform: translateX(-50%); /* Center the panel */
                z-index: 10;
                width: calc(100% - 40px); /* Responsive width with margins */
                height: 100%;
                overflow-y: auto;
                overflow-x: hidden;
                padding: 10px;
                box-sizing: border-box;
                border-radius: 12px;
                max-width: 95%; /* Ensure it doesn't exceed screen */
            }

            .desktop-layout.mobile-show-settings .left-panel,
            .desktop-layout.mobile-show-settings .right-column,
            .desktop-layout.mobile-show-settings .risk-column {
                display: none !important;
            }

            .desktop-layout.mobile-show-brain .brain-panel {
                display: block !important;
                position: absolute;
                top: 0;
                left: 50%; /* Center horizontally */
                transform: translateX(-50%); /* Center the panel */
                z-index: 10;
                width: calc(100% - 40px); /* Responsive width with margins */
                height: 100%;
                overflow-y: auto;
                overflow-x: hidden;
                padding: 10px;
                box-sizing: border-box;
                border-radius: 12px;
                max-width: 95%; /* Ensure it doesn't exceed screen */
            }

            .desktop-layout.mobile-show-brain .left-panel,
            .desktop-layout.mobile-show-brain .right-column,
            .desktop-layout.mobile-show-brain .risk-column,
            .desktop-layout.mobile-show-brain .settings-panel {
                display: none !important;
            }

            /* Mobile Risk Assessment Panel Adjustments */
            @media (max-width: 768px) {
                .risk-panel {
                    margin-bottom: 15px;
                    padding: 8px;
                }
                
                .risk-panel-title {
                    font-size: 16px;
                    margin-bottom: 8px;
                    text-align: center;
                }
                
                .risk-label {
                    font-size: 12px;
                    min-width: 100px;
                    flex-shrink: 0;
                }
                
                .risk-btn {
                    min-width: 40px;
                    height: 28px;
                    font-size: 9px;
                    padding: 2px 3px;
                    margin: 0 1px;
                }
                
                .risk-total {
                    min-width: 30px;
                    font-size: 12px;
                    flex-shrink: 0;
                }
                
                .risk-numbers {
                    gap: 2px;
                }
                
                .risk-numbers span {
                    font-size: 11px;
                    text-align: center;
                }
                
                .risk-row {
                    margin-bottom: 8px;
                    padding: 4px 0;
                }
                
                .risk-buttons {
                    gap: 2px;
                }
                
                .risk-row.stacked .risk-label {
                    margin-bottom: 6px;
                    text-align: left;
                }
                
                .risk-row.stacked .risk-buttons {
                    margin-left: 100px; /* Adjusted for mobile label width */
                }
                
                .risk-row.stacked .risk-content {
                    gap: 0;
                }
            }

            /* Mobile Layout Adjustments */
            @media (max-width: 768px) {
                .desktop-layout {
                    padding-bottom: 100px; /* Add padding to prevent content cutoff by nav bar */
                }
                
                .left-panel, .right-column {
                    gap: 0;
                }
            }

            /* Hide column resizers on mobile */
            .column-resizer {
                display: none !important;
            }

            /* Mobile Navigation - Panel Style */
            .mobile-nav {
                display: flex !important;
                position: fixed !important;
                bottom: 15px !important; /* Floating above bottom */
                left: 15px !important;
                right: 15px !important;
                background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
                height: 70px;
                z-index: 1000;
                border-radius: 15px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 
                           0 0 0 1px rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                border: 1px solid #444;
                gap: 8px;
                padding: 8px;
            }

            /* Hide settings, brain, and risk toggle on mobile */
            .settings-toggle,
            .brain-toggle,
            .risk-toggle {
                display: none !important;
            }

            .mobile-nav-btn {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                background: linear-gradient(135deg, #404040 0%, #2a2a2a 100%);
                border: 1px solid #555;
                border-radius: 10px;
                color: #cccccc;
                cursor: pointer;
                padding: 8px 4px;
                transition: all 0.3s ease;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            }

            .mobile-nav-btn.active {
                background: rgba(76, 175, 80, 0.2);
                color: white;
                border: 2px solid #4CAF50;
                box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
            }

            .mobile-nav-btn:hover {
                background: rgba(76, 175, 80, 0.2);
                color: white;
                border: 2px solid #4CAF50;
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
            }

            .nav-icon {
                font-size: 18px;
                margin-bottom: 2px;
            }
            
            .mobile-nav-btn div:last-child {
                font-size: 11px;
                font-weight: 500;
            }

            /* Ensure mobile columns scale properly */
            .left-panel,
            .right-column,
            .settings-panel {
                font-size: 14px;
            }

            .input-field, .select-field {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 12px;
                min-height: 44px; /* iOS touch target minimum */
            }
        }

        /* Desktop Layout (min-width: 769px) */
        @media (min-width: 769px) {
            /* Hide mobile navigation on desktop */
            .mobile-nav {
                display: none !important;
            }

            /* Show floating toggle buttons on desktop */
            .settings-toggle,
            .brain-toggle,
            .risk-toggle {
                display: flex !important;
            }

            .column-resizer {
                width: 6px;
                background-color: #555;
                cursor: col-resize;
                position: relative;
                flex-shrink: 0;
                transition: background-color 0.2s ease;
                z-index: 10;
            }
            
            /* Show all columns on desktop except risk column (hidden by default) */
            .left-panel,
            .right-column,
            .settings-panel,
            .brain-panel {
                display: block !important;
            }

            /* Fixed layout to prevent overflow - ensure all columns fit within viewport */
            .desktop-layout {
                max-width: 100vw;
                overflow-x: hidden;
            }
            
            .left-panel {
                flex: 0 0 16.67%;
                min-width: 200px;
                max-width: 300px;
                padding: 20px;
                background-color: transparent;
                overflow-y: auto;
                overflow-x: hidden;
                height: 100vh;
                box-sizing: border-box;
            }

            .right-column {
                flex: 1 1 33.33%;
                min-width: 300px;
                max-width: calc(100vw - 600px); /* Ensure space for other columns */
                padding: 20px;
                background-color: transparent;
                overflow-y: auto;
                overflow-x: hidden;
                height: 100vh;
                box-sizing: border-box;
            }

            .risk-column {
                flex: 0 0 auto;
                min-width: 650px;
                max-width: 750px;
                padding: 20px;
                background-color: transparent;
                overflow-y: auto;
                overflow-x: hidden;
                height: 100vh;
                box-sizing: border-box;
                width: auto;
            }

            .settings-panel {
                flex: 0 0 auto;
                min-width: 300px;
                max-width: 450px;
                width: auto;
                padding: 20px;
                background-color: transparent;
                overflow-y: auto;
                overflow-x: hidden;
                height: 100vh;
                box-sizing: border-box;
            }

            .brain-panel {
                flex: 0 0 auto;
                min-width: 300px;
                max-width: 450px;
                width: auto;
                padding: 20px;
                background-color: transparent;
                overflow-y: auto;
                overflow-x: hidden;
                height: 100vh;
                box-sizing: border-box;
            }

            /* When settings are hidden, expand right column */
            .desktop-layout.settings-collapsed .settings-panel {
                display: none !important;
            }

            .desktop-layout.settings-collapsed .right-column {
                flex: 1 !important;
                max-width: none !important;
                width: auto !important;
            }

            /* When brain is hidden, hide brain panel */
            .desktop-layout.brain-collapsed .brain-panel {
                display: none !important;
            }

            .brain-panel.brain-hidden {
                display: none !important;
            }

            .brain-panel.brain-visible {
                display: block !important;
            }

            /* When risk is hidden, hide risk panel */
            .desktop-layout.risk-collapsed .risk-column {
                display: none !important;
            }

            .risk-column.risk-hidden {
                display: none !important;
            }

            .risk-column.risk-visible {
                display: block !important;
            }

            /* Reset mobile classes for desktop */
            .desktop-layout.mobile-show-left .left-panel,
            .desktop-layout.mobile-show-right .right-column,
            .desktop-layout.mobile-show-settings .settings-panel {
                display: block !important;
            }
        }

        /* Landscape orientation adjustments */
        @media (max-width: 768px) and (orientation: landscape) {
            .time-grid {
                grid-template-columns: 1fr 1fr 1fr 1fr;
            }

            .chart-container {
                height: 200px;
            }
        }

        /* Very narrow screen adjustments */
        @media (max-width: 480px) {
            .time-panel {
                padding: 8px;
                margin: 10px 0;
                height: auto;
                min-height: fit-content;
            }

            .time-grid {
                gap: 6px;
            }

            .time-item {
                padding: 6px 4px;
            }

            .time-label {
                font-size: 8px;
            }

            .time-value {
                font-size: 10px;
            }
        }

        /* Extra narrow screen - stack time items vertically */
        @media (max-width: 320px) {
            .time-panel {
                padding: 10px;
                margin: 8px 0;
                height: auto;
                min-height: fit-content;
            }

            .time-grid {
                grid-template-columns: 1fr;
                gap: 6px;
            }

            .time-item {
                padding: 10px;
                width: 100%;
            }

            .time-label {
                font-size: 9px;
            }

            .time-value {
                font-size: 11px;
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .input-field:focus,
            .select-field:focus {
                transform: scale(1.02);
                transition: transform 0.2s ease;
            }

            /* Larger touch targets */
            button, .input-field, .select-field {
                min-height: 44px;
                min-width: 44px;
            }
        }
    </style>
</head>
<body>
    <!-- Hyperspace Canvas Background -->
    <canvas id="hyperspace-canvas"></canvas>
    
    <!-- Normal Space Canvas Background (Floating Stars) -->
    <canvas id="normalspace-canvas"></canvas>
    
    <!-- Desktop Layout -->
    <div class="desktop-layout" style="display: flex; width: 100%; height: 100vh;">
        <div class="left-panel">
        <!-- Airport Code Section -->
        <div class="input-section">
            <div class="input-group">
                <label class="input-label">Airport Code</label>
                <input type="text" class="input-field" id="airportCode" placeholder="KDFW" maxlength="4" style="text-transform: uppercase;" onchange="fetchWeatherData(this.value)">
            </div>
        </div>

        <!-- Aircraft Type Section -->
        <div class="input-section">
            <div class="input-group">
                <label class="input-label">Aircraft Type</label>
                <select class="select-field" id="aircraftType" onchange="populateAircraftSpecificValues(this.value)">
                    <option value="">Select Aircraft</option>
                    <option value="C-152">C-152</option>
                    <option value="C-172">C-172</option>
                    <option value="P2006T">P2006T</option>
                    <option value="CUSTOM">Custom Aircraft</option>
                </select>
            </div>
        </div>

        <!-- Custom Aircraft Section -->
        <div class="input-section">
            <div class="input-group">
                <button type="button" onclick="showCustomAircraftBuilder()" style="width: 100%; background: rgba(76, 175, 80, 0.2); color: white; border: 2px solid #4CAF50; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);" onmouseover="this.style.background='rgba(76, 175, 80, 0.3)'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(76, 175, 80, 0.3)';" onmouseout="this.style.background='rgba(76, 175, 80, 0.2)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(76, 175, 80, 0.2)';">üõ†Ô∏è Custom Aircraft</button>
            </div>
        </div>

        <!-- Section 1: Tail Number -->
        <div class="input-section">
            <div class="input-group">
                <label class="input-label"><a href="https://app.flightschedulepro.com/" target="_blank" style="color: #2196F3; text-decoration: none;">Tail Number</a></label>
                <input type="text" class="input-field" id="tailNumber" placeholder="">
            </div>
        </div>

        <!-- Section 2: Weight & Personal Info -->
        <div class="input-section">
            <div class="input-group">
                <label class="input-label">Weight</label>
                <input type="number" class="input-field" id="weight" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">Arm</label>
                <input type="number" class="input-field" id="arm" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">Moment</label>
                <input type="number" class="input-field" id="moment" placeholder="">
            </div>
            <div class="section-divider"></div>
            <div class="input-group">
                <label class="input-label">My Weight</label>
                <input type="number" class="input-field" id="myWeight" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">My Bag</label>
                <input type="number" class="input-field" id="myBag" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">Instructor Weight</label>
                <input type="number" class="input-field" id="instructorWeight" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">Instructor Bag</label>
                <input type="number" class="input-field" id="instructorBag" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">Baggage 1</label>
                <input type="number" class="input-field" id="baggage1" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">Baggage 2</label>
                <input type="number" class="input-field" id="baggage2" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">Fuel</label>
                <input type="number" class="input-field" id="fuel" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">Time</label>
                <input type="text" class="input-field" id="time" placeholder="">
            </div>
        </div>

        <!-- Section 3: Maintenance -->
        <div class="input-section">
            <div class="input-group">
                <label class="input-label">50 Hr</label>
                <input type="text" class="input-field" id="hr50" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">100 Hr</label>
                <input type="text" class="input-field" id="hr100" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">AD</label>
                <input type="text" class="input-field" id="ad1" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">AD</label>
                <input type="text" class="input-field" id="ad2" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">Annual</label>
                <input type="text" class="input-field" id="annual" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">Regist</label>
                <input type="text" class="input-field" id="regist" placeholder="">
            </div>
        </div>

        <!-- Section 4: Weather -->
        <div class="input-section">
            <div class="input-group">
                <label class="input-label"><a href="https://www.1800wxbrief.com" target="_blank" style="color: #4CAF50; text-decoration: none;">Weather Observation</a></label>
                <input type="text" class="input-field" id="weatherObs" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">Wind Direction</label>
                <input type="number" class="input-field" id="windDirection" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">Wind Speed</label>
                <input type="number" class="input-field" id="windSpeed" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">Visibility</label>
                <input type="number" class="input-field" id="visibility" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">Weather</label>
                <input type="text" class="input-field" id="weather" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">Temperature</label>
                <input type="number" class="input-field" id="temperature" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">Dewpoint</label>
                <input type="number" class="input-field" id="dewpoint" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">Altimeter</label>
                <input type="number" class="input-field" id="altimeter" placeholder="" step="0.01">
            </div>
            <div class="input-group">
                <label class="input-label">Headwind</label>
                <input type="number" class="input-field" id="headwind" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">Crosswind</label>
                <input type="number" class="input-field" id="crosswind" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">Field Elevation</label>
                <input type="number" class="input-field" id="fieldElevation" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">Pressure Altitude</label>
                <input type="number" class="input-field" id="pressureAltitude" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">Density Altitude</label>
                <input type="number" class="input-field" id="densityAltitude" placeholder="">
            </div>
        </div>

        <!-- Section 5: Runway & Performance -->
        <div class="input-section">
            <div class="input-group">
                <label class="input-label">Rwy Hdg</label>
                <input type="number" class="input-field" id="runwayHeading" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">Takeoff GR</label>
                <input type="number" class="input-field" id="takeoffGR" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">T/O Dist. (50')</label>
                <input type="number" class="input-field" id="fiftyFtObst" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">RW Length</label>
                <input type="number" class="input-field" id="runwayLength" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">Landing GR</label>
                <input type="number" class="input-field" id="landingGR" placeholder="">
            </div>
            <div class="input-group">
                <label class="input-label">LDG Dist. (50')</label>
                <input type="number" class="input-field" id="landingDist50" placeholder="">
            </div>
        </div>

    </div>

    <!-- Column Resizer between Left Panel and Right Column -->
    <div class="column-resizer" data-resize="left-right"></div>

    <!-- Right Column Container -->
    <div class="right-column">
        <!-- Zulu Time Calculator Panel -->
        <div class="time-panel">
            <div class="time-grid">
                <div class="time-item">
                    <div class="time-label">Local Time</div>
                    <div class="time-value" id="localTime">--:--:--</div>
                </div>
                <div class="time-item">
                    <div class="time-label">Zulu Time (UTC)</div>
                    <div class="time-value" id="zuluTime">--:--:--</div>
                </div>
                <div class="time-item">
                    <div class="time-label">Local Date</div>
                    <div class="time-value" id="localDate">--/--/----</div>
                </div>
                <div class="time-item">
                    <div class="time-label">Zulu Date</div>
                    <div class="time-value" id="zuluDate">--/--/----</div>
                </div>
            </div>
        </div>

        <!-- Weight & Balance Calculator Panel -->
        <div class="right-panel">
            <div class="tail-number-display" id="tailNumberDisplay">N</div>
            <div class="calculator-title">Weight & Balance Calculator - <span id="aircraftTypeDisplay" style="color: #cccccc;"></span></div>
            
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Weight (Lbs)</th>
                        <th>Arm</th>
                        <th>Moment</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td data-label="Item">Basic Empty Weight</td>
                        <td data-label="Weight (lbs)"></td>
                        <td data-label="Arm (in)"></td>
                        <td data-label="Moment (in-lbs)"></td>
                    </tr>
                    <tr>
                        <td data-label="Item">Front Seats</td>
                        <td data-label="Weight (lbs)"></td>
                        <td data-label="Arm (in)"></td>
                        <td data-label="Moment (in-lbs)"></td>
                    </tr>
                    <tr>
                        <td data-label="Item">Rear Seats</td>
                        <td data-label="Weight (lbs)"></td>
                        <td data-label="Arm (in)"></td>
                        <td data-label="Moment (in-lbs)"></td>
                    </tr>
                    <tr>
                        <td data-label="Item">Baggage 1</td>
                        <td data-label="Weight (lbs)"></td>
                        <td data-label="Arm (in)"></td>
                        <td data-label="Moment (in-lbs)"></td>
                    </tr>
                    <tr>
                        <td data-label="Item">Baggage 2</td>
                        <td data-label="Weight (lbs)"></td>
                        <td data-label="Arm (in)"></td>
                        <td data-label="Moment (in-lbs)"></td>
                    </tr>
                    <tr>
                        <td data-label="Item">Zero Fuel Weight</td>
                        <td data-label="Weight (lbs)"></td>
                        <td data-label="Arm (in)"></td>
                        <td data-label="Moment (in-lbs)"></td>
                    </tr>
                    <tr>
                        <td data-label="Item">Fuel</td>
                        <td data-label="Weight (lbs)"></td>
                        <td data-label="Arm (in)"></td>
                        <td data-label="Moment (in-lbs)"></td>
                    </tr>
                    <tr>
                        <td data-label="Item">Ramp Weight</td>
                        <td data-label="Weight (lbs)"></td>
                        <td data-label="Arm (in)"></td>
                        <td data-label="Moment (in-lbs)"></td>
                    </tr>
                    <tr>
                        <td data-label="Item">Grnd Fuel Use</td>
                        <td data-label="Weight (lbs)"></td>
                        <td data-label="Arm (in)"></td>
                        <td data-label="Moment (in-lbs)"></td>
                    </tr>
                    <tr>
                        <td data-label="Item">T/O Weight</td>
                        <td data-label="Weight (lbs)"></td>
                        <td data-label="Arm (in)"></td>
                        <td data-label="Moment (in-lbs)"></td>
                    </tr>
                    <tr>
                        <td data-label="Item">Est. Fuel Burn (+25%)</td>
                        <td data-label="Weight (lbs)"></td>
                        <td data-label="Arm (in)"></td>
                        <td data-label="Moment (in-lbs)"></td>
                    </tr>
                    <tr>
                        <td data-label="Item">Est. Landing Weight</td>
                        <td data-label="Weight (lbs)"></td>
                        <td data-label="Arm (in)"></td>
                        <td data-label="Moment (in-lbs)"></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Limits Panel -->
        <div class="right-panel">
            <div class="panel-title">Limits</div>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Max T/O Weight</span>
                    <span class="info-value"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Max LDG Weight</span>
                    <span class="info-value"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">T/O CG fwd/aft</span>
                    <span class="info-value">/</span>
                </div>
                <div class="info-item">
                    <span class="info-label">LDG CG fwd/aft</span>
                    <span class="info-value">/</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Zero Fuel CG fwd/aft</span>
                    <span class="info-value">/</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Demo Crosswind</span>
                    <span class="info-value"></span>
                </div>
            </div>
            
            <!-- CG Envelope Toggle Button -->
            <div style="margin-top: 15px; text-align: center;">
                <button id="cgEnvelopeToggle" onclick="toggleCGEnvelope()" style="
                    background: linear-gradient(135deg, rgba(76, 175, 80, 0.3) 0%, rgba(76, 175, 80, 0.1) 100%);
                    color: white;
                    border: 1px solid #4CAF50;
                    padding: 8px 16px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 12px;
                    font-weight: bold;
                    box-shadow: 0 2px 4px rgba(76, 175, 80, 0.2);
                ">Show CG Envelope</button>
            </div>
            
            <!-- CG Chart Container (Initially Hidden) -->
            <div id="cgChartContainer" style="display: none; margin-top: 15px;">
                <canvas id="cgChart" width="300" height="200" style="
                    border: 1px solid #444;
                    border-radius: 4px;
                    background-color: #1a1a1a;
                    width: 100%;
                    height: auto;
                "></canvas>
            </div>
        </div>

        <!-- METAR Panel -->
        <div class="right-panel" id="metarPanel">
            <div id="metarDisplay" style="font-family: 'Courier New', monospace; font-size: 12px; color: #4CAF50; background-color: #1a1a1a; padding: 10px; border-radius: 6px; word-wrap: break-word; line-height: 1.4;">
                No METAR data available
            </div>
        </div>

        <!-- Weather Panel -->
        <div class="right-panel">
            <div class="panel-title">Current Conditions</div>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Aprt. Wx. Observation</span>
                    <span class="info-value" data-field="wxObs"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Crosswind</span>
                    <span class="info-value" data-field="crosswind"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Surface Wind</span>
                    <span class="info-value" data-field="surfaceWind"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Headwind</span>
                    <span class="info-value" data-field="headwind"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Vis/Weather</span>
                    <span class="info-value" data-field="visWeather"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Airport Elevation</span>
                    <span class="info-value" data-field="airportElevation"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Temp/Dew Pt.</span>
                    <span class="info-value" data-field="tempDewPt"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Pressure Altitude</span>
                    <span class="info-value" data-field="pressureAltitude"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Altimeter Setting</span>
                    <span class="info-value" data-field="altimeterSetting"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Density Altitude</span>
                    <span class="info-value" data-field="densityAltitude"></span>
                </div>
            </div>
        </div>

        <!-- Performance Data Panel -->
        <div class="right-panel">
            <div class="panel-title">Performance Data</div>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Expected Runway</span>
                    <span class="info-value" data-field="expectedRunway"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Runway Length</span>
                    <span class="info-value" data-field="runwayLength"></span>
                </div>
                <div class="info-item performance-tooltip">
                    <span class="info-label">T/O Grnd Roll</span>
                    <span class="info-value" data-field="takeoffGR"></span>
                    <div class="tooltip-content">
                        <div class="tooltip-title">Takeoff Ground Roll Calculation</div>
                        <div class="tooltip-formula">Base Distance √ó Headwind Correction</div>
                        <div class="tooltip-formula">C-152: -8ft per knot headwind</div>
                        <div class="tooltip-formula">P2006T: -8ft per knot headwind</div>
                        <div class="tooltip-note">Interpolated from POH data tables based on temperature, pressure altitude, and aircraft weight. Headwind reduces required ground roll distance.</div>
                    </div>
                </div>
                <div class="info-item performance-tooltip">
                    <span class="info-label">LDG Grnd Roll</span>
                    <span class="info-value" data-field="landingGR"></span>
                    <div class="tooltip-content">
                        <div class="tooltip-title">Landing Ground Roll Calculation</div>
                        <div class="tooltip-formula">Base Distance √ó Headwind Correction</div>
                        <div class="tooltip-formula">C-152: +8ft per knot headwind</div>
                        <div class="tooltip-formula">P2006T: +8ft per knot headwind</div>
                        <div class="tooltip-note">Interpolated from POH landing data tables. Headwind increases landing distance due to float effect.</div>
                    </div>
                </div>
                <div class="info-item performance-tooltip">
                    <span class="info-label">T/O Dist. (50')</span>
                    <span class="info-value" data-field="takeoffDist50"></span>
                    <div class="tooltip-content">
                        <div class="tooltip-title">Takeoff Distance to 50ft Obstacle</div>
                        <div class="tooltip-formula">Ground Roll + Obstacle Clearance Distance</div>
                        <div class="tooltip-note">Total distance required to clear 50ft obstacle. Includes ground roll plus climb to 50ft altitude. Same headwind corrections as ground roll.</div>
                    </div>
                </div>
                <div class="info-item performance-tooltip">
                    <span class="info-label">LDG Dist. (50')</span>
                    <span class="info-value" data-field="landingDist50"></span>
                    <div class="tooltip-content">
                        <div class="tooltip-title">Landing Distance from 50ft Obstacle</div>
                        <div class="tooltip-formula">Obstacle Distance + Ground Roll</div>
                        <div class="tooltip-note">Total distance required from 50ft altitude to full stop on runway. Includes approach and landing roll.</div>
                    </div>
                </div>
                
                <!-- P2006T Specific Performance Data -->
                <div id="p2006t-performance" style="display: none;">
                    <div class="info-item performance-tooltip">
                        <span class="info-label">Accelerate/Stop Dist</span>
                        <span class="info-value" data-field="accelerateStopDist"></span>
                        <div class="tooltip-content">
                            <div class="tooltip-title">Accelerate/Stop Distance Calculation</div>
                            <div class="tooltip-formula">|Takeoff GR - Landing GR|</div>
                            <div class="tooltip-note">Absolute difference between takeoff ground roll and landing ground roll. Represents total runway distance needed to accelerate to takeoff speed and then stop abort.</div>
                        </div>
                    </div>
                    <div class="info-item performance-tooltip">
                        <span class="info-label">SE Service Ceiling</span>
                        <span class="info-value" data-field="seServiceCeiling"></span>
                        <div class="tooltip-content">
                            <div class="tooltip-title">Single-Engine Service Ceiling</div>
                            <div class="tooltip-formula">Altitude where ROC = 50 fpm</div>
                            <div class="tooltip-formula">Interpolated from P2006T SE Performance Tables</div>
                            <div class="tooltip-formula">Based on: Weight, Temperature, Pressure Altitude</div>
                            <div class="tooltip-note">Maximum altitude at which aircraft can maintain 50 feet per minute climb rate with one engine inoperative. Uses weight category interpolation and temperature-based ROC selection.</div>
                        </div>
                    </div>
                    <div class="info-item performance-tooltip">
                        <span class="info-label">SE Climb Rate</span>
                        <span class="info-value" data-field="seClimbRate"></span>
                        <div class="tooltip-content">
                            <div class="tooltip-title">Single-Engine Rate of Climb</div>
                            <div class="tooltip-formula">Interpolated from P2006T SE Performance Tables</div>
                            <div class="tooltip-formula">Temperature Column: -25¬∞C, 0¬∞C, 25¬∞C, 50¬∞C, ISA</div>
                            <div class="tooltip-formula">Weight Categories: 2050, 2381, 2601 lbs</div>
                            <div class="tooltip-note">Rate of climb in feet per minute with one engine inoperative at current pressure altitude and temperature. Linear interpolation between table data points.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Maintenance Data Panel -->
        <div class="right-panel">
            <div class="panel-title">Maintenance Data</div>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">50Hr</span>
                    <span class="info-value" data-field="mx50Hr"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">100Hr</span>
                    <span class="info-value" data-field="mx100Hr"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">AD</span>
                    <span class="info-value" data-field="mxAD"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">AD</span>
                    <span class="info-value" data-field="mxAD2"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Annual</span>
                    <span class="info-value" data-field="mxAnnual"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Registration</span>
                    <span class="info-value" data-field="mxRegistration"></span>
                </div>
            </div>
        </div>

        <!-- Airspeeds Panel -->
        <div class="right-panel">
            <div class="panel-title">Aircraft Reference Speeds</div>
            <div class="airspeed-grid">
                <div class="airspeed-item">Vr</div>
                <div class="airspeed-item">Vxse</div>
                <div class="airspeed-item">Vle</div>
                <div class="airspeed-item">Vg</div>
                <div class="airspeed-item">Vr 50'</div>
                <div class="airspeed-item">Vyse</div>
                <div class="airspeed-item">Vlo</div>
                <div class="airspeed-item">Vmc</div>
                <div class="airspeed-item">Vx</div>
                <div class="airspeed-item">Vs0</div>
                <div class="airspeed-item">Va</div>
                <div class="airspeed-item">Vapp Short</div>
                <div class="airspeed-item">Vy</div>
                <div class="airspeed-item">Vs1</div>
                <div class="airspeed-item">Va Max</div>
                <div class="airspeed-item">Vapp Normal</div>
                <div class="airspeed-item">Vcc</div>
                <div class="airspeed-item">Vfe</div>
                <div class="airspeed-item">Vne</div>
                <div class="airspeed-item">Vapp Flapless</div>
            </div>
        </div>

    </div>

    <!-- Column Resizer between Right Column and Risk Column -->
    <div class="column-resizer" data-resize="right-risk"></div>

    <!-- Risk Assessment Column (Column C) -->
    <div class="risk-column">
        <!-- Pilot Panel -->
        <div class="risk-panel">
            <div class="risk-panel-title">Pilot</div>
            <div class="risk-header">
                <div class="risk-label"></div>
                <div class="risk-numbers">
                    <span>1</span>
                    <span>2</span>
                    <span>3</span>
                    <span>4</span>
                    <span>5</span>
                </div>
                <div class="risk-total">Total</div>
            </div>
            
            <div class="risk-row stacked">
                <div class="risk-label">Illness</div>
                <div class="risk-content">
                    <div class="risk-buttons">
                        <button class="risk-btn" onclick="selectRisk('pilot-illness', 1)" data-value="1">no</button>
                        <button class="risk-btn" disabled data-value="2"></button>
                        <button class="risk-btn" onclick="selectRisk('pilot-illness', 3)" data-value="3">minor</button>
                        <button class="risk-btn" disabled data-value="4"></button>
                        <button class="risk-btn" onclick="selectRisk('pilot-illness', 5)" data-value="5">major</button>
                    </div>
                    <div class="risk-total" id="pilot-illness-total">0</div>
                </div>
            </div>
            
            <div class="risk-row stacked">
                <div class="risk-label">Medication</div>
                <div class="risk-content">
                    <div class="risk-buttons">
                        <button class="risk-btn" onclick="selectRisk('pilot-medication', 1)" data-value="1">no</button>
                        <button class="risk-btn" disabled data-value="2"></button>
                        <button class="risk-btn" onclick="selectRisk('pilot-medication', 3)" data-value="3">yes</button>
                        <button class="risk-btn" disabled data-value="4"></button>
                        <button class="risk-btn" disabled data-value="5"></button>
                    </div>
                    <div class="risk-total" id="pilot-medication-total">0</div>
                </div>
            </div>
            
            <div class="risk-row stacked">
                <div class="risk-label">Stress</div>
                <div class="risk-content">
                    <div class="risk-buttons">
                        <button class="risk-btn" onclick="selectRisk('pilot-stress', 1)" data-value="1">no</button>
                        <button class="risk-btn" onclick="selectRisk('pilot-stress', 2)" data-value="2">low</button>
                        <button class="risk-btn" onclick="selectRisk('pilot-stress', 3)" data-value="3">med</button>
                        <button class="risk-btn" onclick="selectRisk('pilot-stress', 4)" data-value="4">high</button>
                        <button class="risk-btn" onclick="selectRisk('pilot-stress', 5)" data-value="5">severe</button>
                    </div>
                    <div class="risk-total" id="pilot-stress-total">0</div>
                </div>
            </div>
            
            <div class="risk-row stacked">
                <div class="risk-label">Alcohol (last 24 hrs)</div>
                <div class="risk-content">
                    <div class="risk-buttons">
                        <button class="risk-btn" onclick="selectRisk('pilot-alcohol', 1)" data-value="1">no</button>
                        <button class="risk-btn" onclick="selectRisk('pilot-alcohol', 2)" data-value="2">>20hr</button>
                        <button class="risk-btn" onclick="selectRisk('pilot-alcohol', 3)" data-value="3">>18hr</button>
                        <button class="risk-btn" onclick="selectRisk('pilot-alcohol', 4)" data-value="4">>12hr</button>
                        <button class="risk-btn" onclick="selectRisk('pilot-alcohol', 5)" data-value="5">‚â•12hr</button>
                    </div>
                    <div class="risk-total" id="pilot-alcohol-total">0</div>
                </div>
            </div>
            
            <div class="risk-row stacked">
                <div class="risk-label">Fatigue (hrs of sleep)</div>
                <div class="risk-content">
                    <div class="risk-buttons">
                        <button class="risk-btn" onclick="selectRisk('pilot-fatigue', 1)" data-value="1">>8</button>
                        <button class="risk-btn" onclick="selectRisk('pilot-fatigue', 2)" data-value="2">6-8</button>
                        <button class="risk-btn" onclick="selectRisk('pilot-fatigue', 3)" data-value="3">5-6</button>
                        <button class="risk-btn" onclick="selectRisk('pilot-fatigue', 4)" data-value="4">4-5</button>
                        <button class="risk-btn" onclick="selectRisk('pilot-fatigue', 5)" data-value="5"><6</button>
                    </div>
                    <div class="risk-total" id="pilot-fatigue-total">0</div>
                </div>
            </div>
            
            <div class="risk-row stacked">
                <div class="risk-label">Eating (hrs since last)</div>
                <div class="risk-content">
                    <div class="risk-buttons">
                        <button class="risk-btn" onclick="selectRisk('pilot-eating', 1)" data-value="1"><2</button>
                        <button class="risk-btn" onclick="selectRisk('pilot-eating', 2)" data-value="2">2-4</button>
                        <button class="risk-btn" onclick="selectRisk('pilot-eating', 3)" data-value="3">4-5</button>
                        <button class="risk-btn" onclick="selectRisk('pilot-eating', 4)" data-value="4">5-6</button>
                        <button class="risk-btn" onclick="selectRisk('pilot-eating', 5)" data-value="5">>6</button>
                    </div>
                    <div class="risk-total" id="pilot-eating-total">0</div>
                </div>
            </div>
            
            <div class="risk-row stacked">
                <div class="risk-label">Emotion</div>
                <div class="risk-content">
                    <div class="risk-buttons">
                        <button class="risk-btn" onclick="selectRisk('pilot-emotion', 1)" data-value="1">low</button>
                        <button class="risk-btn" disabled data-value="2"></button>
                        <button class="risk-btn" onclick="selectRisk('pilot-emotion', 3)" data-value="3">med</button>
                        <button class="risk-btn" disabled data-value="4"></button>
                        <button class="risk-btn" onclick="selectRisk('pilot-emotion', 5)" data-value="5">high</button>
                    </div>
                    <div class="risk-total" id="pilot-emotion-total">0</div>
                </div>
            </div>
            
            <div class="risk-row stacked">
                <div class="risk-label">Days in a row at Academy</div>
                <div class="risk-content">
                    <div class="risk-buttons">
                        <button class="risk-btn" onclick="selectRisk('pilot-academy', 1)" data-value="1">‚â§2</button>
                        <button class="risk-btn" onclick="selectRisk('pilot-academy', 2)" data-value="2">3</button>
                        <button class="risk-btn" onclick="selectRisk('pilot-academy', 3)" data-value="3">4</button>
                        <button class="risk-btn" onclick="selectRisk('pilot-academy', 4)" data-value="4">5</button>
                        <button class="risk-btn" onclick="selectRisk('pilot-academy', 5)" data-value="5">‚â•6</button>
                    </div>
                    <div class="risk-total" id="pilot-academy-total">0</div>
                </div>
            </div>
            
            <div class="risk-row stacked">
                <div class="risk-label">Currency for Flt (days)</div>
                <div class="risk-content">
                    <div class="risk-buttons">
                        <button class="risk-btn" onclick="selectRisk('pilot-currency', 1)" data-value="1"><1</button>
                        <button class="risk-btn" onclick="selectRisk('pilot-currency', 2)" data-value="2"><15</button>
                        <button class="risk-btn" onclick="selectRisk('pilot-currency', 3)" data-value="3"><30</button>
                        <button class="risk-btn" onclick="selectRisk('pilot-currency', 4)" data-value="4"><45</button>
                        <button class="risk-btn" onclick="selectRisk('pilot-currency', 5)" data-value="5"><60</button>
                    </div>
                    <div class="risk-total" id="pilot-currency-total">0</div>
                </div>
            </div>
            
            <div class="risk-row" style="border-top: 1px solid #555; padding-top: 15px; margin-top: 15px;">
                <div class="risk-label" style="font-weight: bold;">Pilot Total:</div>
                <div></div>
                <div class="risk-total" style="font-size: 18px;" id="pilot-section-total">0</div>
            </div>
        </div>

        <!-- Aircraft Panel -->
        <div class="risk-panel">
            <div class="risk-panel-title">Aircraft</div>
            <div class="risk-header">
                <div class="risk-label"></div>
                <div class="risk-numbers">
                    <span>1</span>
                    <span>2</span>
                    <span>3</span>
                    <span>4</span>
                    <span>5</span>
                </div>
                <div class="risk-total">Total</div>
            </div>
            
            <div class="risk-row stacked">
                <div class="risk-label">Single eng. Aircraft (fpm)</div>
                <div class="risk-content">
                    <div class="risk-buttons">
                        <button class="risk-btn" onclick="selectRisk('aircraft-single', 1)" data-value="1">‚â•550</button>
                        <button class="risk-btn" onclick="selectRisk('aircraft-single', 2)" data-value="2">‚â•450</button>
                        <button class="risk-btn" onclick="selectRisk('aircraft-single', 3)" data-value="3">‚â•350</button>
                        <button class="risk-btn" onclick="selectRisk('aircraft-single', 4)" data-value="4">‚â•250</button>
                        <button class="risk-btn" onclick="selectRisk('aircraft-single', 5)" data-value="5"><250</button>
                    </div>
                    <div class="risk-total" id="aircraft-single-total">0</div>
                </div>
            </div>
            
            <div class="risk-row stacked">
                <div class="risk-label">Multi Eng. W/ OEI (fpm)</div>
                <div class="risk-content">
                    <div class="risk-buttons">
                        <button class="risk-btn" onclick="selectRisk('aircraft-multi', 1)" data-value="1">‚â•200</button>
                        <button class="risk-btn" onclick="selectRisk('aircraft-multi', 2)" data-value="2">‚â•150</button>
                        <button class="risk-btn" onclick="selectRisk('aircraft-multi', 3)" data-value="3">‚â•100</button>
                        <button class="risk-btn" onclick="selectRisk('aircraft-multi', 4)" data-value="4">‚â•50</button>
                        <button class="risk-btn" onclick="selectRisk('aircraft-multi', 5)" data-value="5"><50</button>
                    </div>
                    <div class="risk-total" id="aircraft-multi-total">0</div>
                </div>
            </div>
            
            <div class="risk-row stacked">
                <div class="risk-label">T/O or LDG Over 50' Obstacle</div>
                <div class="risk-content">
                    <div class="risk-buttons">
                        <button class="risk-btn" onclick="selectRisk('aircraft-obstacle', 1)" data-value="1">No</button>
                        <button class="risk-btn" disabled data-value="2"></button>
                        <button class="risk-btn" disabled data-value="3"></button>
                        <button class="risk-btn" onclick="selectRisk('aircraft-obstacle', 4)" data-value="4">Yes</button>
                        <button class="risk-btn" disabled data-value="5"></button>
                    </div>
                    <div class="risk-total" id="aircraft-obstacle-total">0</div>
                </div>
            </div>
            
            <div class="risk-row stacked">
                <div class="risk-label">Time to Next MX (hrs)</div>
                <div class="risk-content">
                    <div class="risk-buttons">
                        <button class="risk-btn" onclick="selectRisk('aircraft-mx', 1)" data-value="1">>10</button>
                        <button class="risk-btn" onclick="selectRisk('aircraft-mx', 2)" data-value="2">10-8</button>
                        <button class="risk-btn" onclick="selectRisk('aircraft-mx', 3)" data-value="3">8-5</button>
                        <button class="risk-btn" onclick="selectRisk('aircraft-mx', 4)" data-value="4">5-1.5</button>
                        <button class="risk-btn" onclick="selectRisk('aircraft-mx', 5)" data-value="5"><1.5</button>
                    </div>
                    <div class="risk-total" id="aircraft-mx-total">0</div>
                </div>
            </div>
            
            <div class="risk-row" style="border-top: 1px solid #555; padding-top: 15px; margin-top: 15px;">
                <div class="risk-label" style="font-weight: bold;">Aircraft Total:</div>
                <div></div>
                <div class="risk-total" style="font-size: 18px;" id="aircraft-section-total">0</div>
            </div>
        </div>

        <!-- Environment Panel -->
        <div class="risk-panel">
            <div class="risk-panel-title">enVironment</div>
            <div class="risk-header">
                <div class="risk-label"></div>
                <div class="risk-numbers">
                    <span>1</span>
                    <span>2</span>
                    <span>3</span>
                    <span>4</span>
                    <span>5</span>
                </div>
                <div class="risk-total">Total</div>
            </div>
            
            <div class="risk-row stacked">
                <div class="risk-label">Mission Duration >3hrs</div>
                <div class="risk-content">
                    <div class="risk-buttons">
                        <button class="risk-btn" onclick="selectRisk('env-duration', 1)" data-value="1">no</button>
                        <button class="risk-btn" disabled data-value="2"></button>
                        <button class="risk-btn" onclick="selectRisk('env-duration', 3)" data-value="3">yes</button>
                        <button class="risk-btn" disabled data-value="4"></button>
                        <button class="risk-btn" disabled data-value="5"></button>
                    </div>
                    <div class="risk-total" id="env-duration-total">0</div>
                </div>
            </div>
            
            <div class="risk-row stacked">
                <div class="risk-label">Back to Back Flights</div>
                <div class="risk-content">
                    <div class="risk-buttons">
                        <button class="risk-btn" onclick="selectRisk('env-backtoback', 1)" data-value="1">no</button>
                        <button class="risk-btn" disabled data-value="2"></button>
                        <button class="risk-btn" onclick="selectRisk('env-backtoback', 3)" data-value="3">yes</button>
                        <button class="risk-btn" disabled data-value="4"></button>
                        <button class="risk-btn" disabled data-value="5"></button>
                    </div>
                    <div class="risk-total" id="env-backtoback-total">0</div>
                </div>
            </div>
            
            <div class="risk-row stacked">
                <div class="risk-label">Going to new airport</div>
                <div class="risk-content">
                    <div class="risk-buttons">
                        <button class="risk-btn" onclick="selectRisk('env-newairport', 1)" data-value="1">no</button>
                        <button class="risk-btn" disabled data-value="2"></button>
                        <button class="risk-btn" onclick="selectRisk('env-newairport', 3)" data-value="3">yes</button>
                        <button class="risk-btn" disabled data-value="4"></button>
                        <button class="risk-btn" disabled data-value="5"></button>
                    </div>
                    <div class="risk-total" id="env-newairport-total">0</div>
                </div>
            </div>
            
            <div class="risk-row stacked">
                <div class="risk-label">Departure visibility (sm)</div>
                <div class="risk-content">
                    <div class="risk-buttons">
                        <button class="risk-btn" onclick="selectRisk('env-depvis', 1)" data-value="1">‚â•6 sm</button>
                        <button class="risk-btn" onclick="selectRisk('env-depvis', 2)" data-value="2">5 sm</button>
                        <button class="risk-btn" onclick="selectRisk('env-depvis', 3)" data-value="3">4 sm</button>
                        <button class="risk-btn" onclick="selectRisk('env-depvis', 4)" data-value="4">3 sm</button>
                        <button class="risk-btn" onclick="selectRisk('env-depvis', 5)" data-value="5"><3 sm</button>
                    </div>
                    <div class="risk-total" id="env-depvis-total">0</div>
                </div>
            </div>
            
            <div class="risk-row stacked">
                <div class="risk-label">Departure Ceiling (ft)</div>
                <div class="risk-content">
                    <div class="risk-buttons">
                        <button class="risk-btn" onclick="selectRisk('env-depceil', 1)" data-value="1">‚â•5000</button>
                        <button class="risk-btn" onclick="selectRisk('env-depceil', 2)" data-value="2">‚â•3000</button>
                        <button class="risk-btn" onclick="selectRisk('env-depceil', 3)" data-value="3">‚â•1500</button>
                        <button class="risk-btn" onclick="selectRisk('env-depceil', 4)" data-value="4">‚â•800</button>
                        <button class="risk-btn" onclick="selectRisk('env-depceil', 5)" data-value="5"><800</button>
                    </div>
                    <div class="risk-total" id="env-depceil-total">0</div>
                </div>
            </div>
            
            <div class="risk-row stacked">
                <div class="risk-label">Destination Visibility (sm)</div>
                <div class="risk-content">
                    <div class="risk-buttons">
                        <button class="risk-btn" onclick="selectRisk('env-destvis', 1)" data-value="1">‚â•6 sm</button>
                        <button class="risk-btn" onclick="selectRisk('env-destvis', 2)" data-value="2">5 sm</button>
                        <button class="risk-btn" onclick="selectRisk('env-destvis', 3)" data-value="3">4 sm</button>
                        <button class="risk-btn" onclick="selectRisk('env-destvis', 4)" data-value="4">3 sm</button>
                        <button class="risk-btn" onclick="selectRisk('env-destvis', 5)" data-value="5"><3 sm</button>
                    </div>
                    <div class="risk-total" id="env-destvis-total">0</div>
                </div>
            </div>
            
            <div class="risk-row stacked">
                <div class="risk-label">Destination Ceiling (ft)</div>
                <div class="risk-content">
                    <div class="risk-buttons">
                        <button class="risk-btn" onclick="selectRisk('env-destceil', 1)" data-value="1">‚â•5000</button>
                        <button class="risk-btn" onclick="selectRisk('env-destceil', 2)" data-value="2">‚â•3000</button>
                        <button class="risk-btn" onclick="selectRisk('env-destceil', 3)" data-value="3">‚â•1500</button>
                        <button class="risk-btn" onclick="selectRisk('env-destceil', 4)" data-value="4">‚â•800</button>
                        <button class="risk-btn" onclick="selectRisk('env-destceil', 5)" data-value="5"><800</button>
                    </div>
                    <div class="risk-total" id="env-destceil-total">0</div>
                </div>
            </div>
            
            <div class="risk-row stacked">
                <div class="risk-label">X-wind as % of max</div>
                <div class="risk-content">
                    <div class="risk-buttons">
                        <button class="risk-btn" onclick="selectRisk('env-xwind', 1)" data-value="1"><20%</button>
                        <button class="risk-btn" onclick="selectRisk('env-xwind', 2)" data-value="2">20-49%</button>
                        <button class="risk-btn" onclick="selectRisk('env-xwind', 3)" data-value="3">50-79%</button>
                        <button class="risk-btn" onclick="selectRisk('env-xwind', 4)" data-value="4">80-99%</button>
                        <button class="risk-btn" onclick="selectRisk('env-xwind', 5)" data-value="5">‚â•100%</button>
                    </div>
                    <div class="risk-total" id="env-xwind-total">0</div>
                </div>
            </div>
            
            <div class="risk-row" style="border-top: 1px solid #555; padding-top: 15px; margin-top: 15px;">
                <div class="risk-label" style="font-weight: bold;">Environment Total:</div>
                <div></div>
                <div class="risk-total" style="font-size: 18px;" id="environment-section-total">0</div>
            </div>
        </div>

        <!-- External Pressures Panel -->
        <div class="risk-panel">
            <div class="risk-panel-title">External Pressures</div>
            <div class="risk-header">
                <div class="risk-label"></div>
                <div class="risk-numbers">
                    <span>1</span>
                    <span>2</span>
                    <span>3</span>
                    <span>4</span>
                    <span>5</span>
                </div>
                <div class="risk-total">Total</div>
            </div>
            
            <div class="risk-row stacked">
                <div class="risk-label">Recent death of friend/family</div>
                <div class="risk-content">
                    <div class="risk-buttons">
                        <button class="risk-btn" onclick="selectRisk('ext-death', 1)" data-value="1">no</button>
                        <button class="risk-btn" disabled data-value="2"></button>
                        <button class="risk-btn" disabled data-value="3"></button>
                        <button class="risk-btn" disabled data-value="4"></button>
                        <button class="risk-btn" onclick="selectRisk('ext-death', 5)" data-value="5">yes</button>
                    </div>
                    <div class="risk-total" id="ext-death-total">0</div>
                </div>
            </div>
            
            <div class="risk-row stacked">
                <div class="risk-label">Pressure to complete mission</div>
                <div class="risk-content">
                    <div class="risk-buttons">
                        <button class="risk-btn" onclick="selectRisk('ext-pressure', 1)" data-value="1">no</button>
                        <button class="risk-btn" disabled data-value="2"></button>
                        <button class="risk-btn" onclick="selectRisk('ext-pressure', 3)" data-value="3">yes</button>
                        <button class="risk-btn" disabled data-value="4"></button>
                        <button class="risk-btn" disabled data-value="5"></button>
                    </div>
                    <div class="risk-total" id="ext-pressure-total">0</div>
                </div>
            </div>
            
            <div class="risk-row stacked">
                <div class="risk-label">Illness/Emergency w/ friend/family</div>
                <div class="risk-content">
                    <div class="risk-buttons">
                        <button class="risk-btn" onclick="selectRisk('ext-emergency', 1)" data-value="1">no</button>
                        <button class="risk-btn" disabled data-value="2"></button>
                        <button class="risk-btn" disabled data-value="3"></button>
                        <button class="risk-btn" onclick="selectRisk('ext-emergency', 4)" data-value="4">yes</button>
                        <button class="risk-btn" disabled data-value="5"></button>
                    </div>
                    <div class="risk-total" id="ext-emergency-total">0</div>
                </div>
            </div>
            
            <div class="risk-row stacked">
                <div class="risk-label">Mission # for the day</div>
                <div class="risk-content">
                    <div class="risk-buttons">
                        <button class="risk-btn" onclick="selectRisk('ext-mission', 1)" data-value="1">1st</button>
                        <button class="risk-btn" onclick="selectRisk('ext-mission', 2)" data-value="2">2nd</button>
                        <button class="risk-btn" onclick="selectRisk('ext-mission', 3)" data-value="3">3rd</button>
                        <button class="risk-btn" onclick="selectRisk('ext-mission', 4)" data-value="4">4th</button>
                        <button class="risk-btn" onclick="selectRisk('ext-mission', 5)" data-value="5">5th</button>
                    </div>
                    <div class="risk-total" id="ext-mission-total">0</div>
                </div>
            </div>
            
            <div class="risk-row stacked">
                <div class="risk-label">Mission type</div>
                <div class="risk-content">
                    <div class="risk-buttons">
                        <button class="risk-btn" onclick="selectRisk('ext-type', 1)" data-value="1">Dual</button>
                        <button class="risk-btn" onclick="selectRisk('ext-type', 2)" data-value="2">Solo</button>
                        <button class="risk-btn" onclick="selectRisk('ext-type', 3)" data-value="3">Night</button>
                        <button class="risk-btn" onclick="selectRisk('ext-type', 4)" data-value="4">IMC</button>
                        <button class="risk-btn" onclick="selectRisk('ext-type', 5)" data-value="5">LIFR</button>
                    </div>
                    <div class="risk-total" id="ext-type-total">0</div>
                </div>
            </div>
            
            <div class="risk-row" style="border-top: 1px solid #555; padding-top: 15px; margin-top: 15px;">
                <div class="risk-label" style="font-weight: bold;">External Pressures Total:</div>
                <div></div>
                <div class="risk-total" style="font-size: 18px;" id="external-section-total">0</div>
            </div>
        </div>

        <!-- Grand Total Panel -->
        <div class="risk-panel">
            <div class="risk-panel-title">GRAND TOTAL</div>
            <div class="grand-total green" id="grand-total-display">0</div>
            <div id="risk-message" style="text-align: center; margin-top: 15px; font-weight: bold; color: #ccc;">
                SP solos require IP sign off
            </div>
        </div>
    </div>

    <!-- Column Resizer between Risk Column and Settings Panel -->
    <div class="column-resizer" data-resize="risk-settings"></div>

    <!-- Settings Panel (Column D) -->
    <div class="settings-panel" style="padding: 20px; overflow-y: auto; height: 100vh;">
        <h2 id="lightspeed-toggle" style="color: #4CAF50; margin-bottom: 20px; font-size: 18px; cursor: pointer; user-select: none; transition: color 0.3s ease;" title="Secret lightspeed mode toggle">Settings</h2>
        
        <!-- User Profile Section -->
        <div class="input-section">
            <h3 style="color: #e0e0e0; margin-bottom: 15px; font-size: 16px;">User Profile</h3>
            <div class="input-group">
                <label class="input-label">My Weight (lbs)</label>
                <input type="number" class="input-field" id="userWeight" placeholder="Enter weight">
            </div>
            <div class="input-group">
                <label class="input-label">Flight Bag (lbs)</label>
                <input type="number" class="input-field" id="userBagWeight" placeholder="Enter bag weight">
            </div>
            <div class="input-group">
                <label class="input-label">Default Airport</label>
                <input type="text" class="input-field" id="defaultAirport" placeholder="KDFW" maxlength="4" style="text-transform: uppercase;">
            </div>
            <div class="input-group">
                <label class="input-label">Default Aircraft</label>
                <select class="select-field" id="defaultAircraft">
                    <option value="">No Default Selected</option>
                </select>
            </div>
            <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 15px;">
                <button onclick="saveUserProfile()" style="background: rgba(76, 175, 80, 0.2); color: white; border: 2px solid #4CAF50; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 14px; width: 100%; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);" onmouseover="this.style.background='rgba(76, 175, 80, 0.3)'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(76, 175, 80, 0.3)';" onmouseout="this.style.background='rgba(76, 175, 80, 0.2)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(76, 175, 80, 0.2)';">üíæ Save Profile</button>
                <button onclick="loadUserProfile()" style="background: rgba(33, 150, 243, 0.2); color: white; border: 2px solid #2196F3; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 14px; width: 100%; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);" onmouseover="this.style.background='rgba(33, 150, 243, 0.3)'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(33, 150, 243, 0.3)';" onmouseout="this.style.background='rgba(33, 150, 243, 0.2)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(33, 150, 243, 0.2)';">üìÇ Load Profile</button>
                <button onclick="clearUserProfile()" style="background: rgba(244, 67, 54, 0.2); color: white; border: 2px solid #f44336; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 14px; width: 100%; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(244, 67, 54, 0.2);" onmouseover="this.style.background='rgba(244, 67, 54, 0.3)'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(244, 67, 54, 0.3)';" onmouseout="this.style.background='rgba(244, 67, 54, 0.2)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(244, 67, 54, 0.2)';">üóëÔ∏è Clear Data</button>
            </div>
            <div id="settingsStatus" style="margin-top: 10px; padding: 8px; border-radius: 4px; font-size: 12px; display: none;"></div>
        </div>

        <!-- Aircraft Management Section -->
        <div class="input-section">
            <h3 style="color: #e0e0e0; margin-bottom: 15px; font-size: 16px;">Aircraft Management</h3>
            <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px;">
                <button onclick="saveCurrentAircraft()" style="background: rgba(76, 175, 80, 0.2); color: white; border: 2px solid #4CAF50; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 14px; width: 100%; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);" onmouseover="this.style.background='rgba(76, 175, 80, 0.3)'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(76, 175, 80, 0.3)';" onmouseout="this.style.background='rgba(76, 175, 80, 0.2)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(76, 175, 80, 0.2)';">‚úàÔ∏è Save Current Aircraft</button>
                <button onclick="showAircraftManager()" style="background: rgba(255, 152, 0, 0.2); color: white; border: 2px solid #FF9800; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 14px; width: 100%; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2);" onmouseover="this.style.background='rgba(255, 152, 0, 0.3)'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(255, 152, 0, 0.3)';" onmouseout="this.style.background='rgba(255, 152, 0, 0.2)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(255, 152, 0, 0.2)';">üìã Manage Aircraft</button>
                <button onclick="showCustomAircraftManager()" style="background: rgba(96, 125, 139, 0.2); color: white; border: 2px solid #607D8B; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 14px; width: 100%; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(96, 125, 139, 0.2);" onmouseover="this.style.background='rgba(96, 125, 139, 0.3)'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(96, 125, 139, 0.3)';" onmouseout="this.style.background='rgba(96, 125, 139, 0.2)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(96, 125, 139, 0.2)';">üß∞ Manage Custom Aircraft</button>
                <button onclick="showCustomAircraftBuilder()" style="background: rgba(76, 175, 80, 0.2); color: white; border: 2px solid #4CAF50; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 14px; width: 100%; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);" onmouseover="this.style.background='rgba(76, 175, 80, 0.3)'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(76, 175, 80, 0.3)';" onmouseout="this.style.background='rgba(76, 175, 80, 0.2)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(76, 175, 80, 0.2)';">üõ†Ô∏è Custom Aircraft Builder</button>
            </div>
            
            <!-- Aircraft Manager Modal -->
            <div id="aircraftManager" style="display: none; background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%); border-radius: 8px; padding: 15px; margin-top: 10px; border: 1px solid #555;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="color: #e0e0e0; margin: 0;">Saved Aircraft</h4>
                    <button onclick="hideAircraftManager()" style="background: none; border: none; color: #ccc; font-size: 18px; cursor: pointer;">√ó</button>
                </div>
                <div id="aircraftList"></div>
            </div>

            <div id="customAircraftManager" style="display: none; background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%); border-radius: 8px; padding: 15px; margin-top: 10px; border: 1px solid #555;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="color: #e0e0e0; margin: 0;">Custom Aircraft</h4>
                    <button onclick="hideCustomAircraftManager()" style="background: none; border: none; color: #ccc; font-size: 18px; cursor: pointer;">√ó</button>
                </div>
                <div id="customAircraftList"></div>
            </div>
            
            <!-- Custom Aircraft Builder Modal -->
            <div id="customAircraftBuilder" style="display: none; background-color: #1a1a1a; border-radius: 8px; padding: 15px; margin-top: 10px; border: 1px solid #555; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #555;">
                    <h3 style="color: #4CAF50; margin: 0; font-size: 16px;">üõ†Ô∏è Custom Aircraft Builder</h3>
                    <button onclick="hideCustomAircraftBuilder()" style="background: none; border: none; color: #ccc; font-size: 20px; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
                </div>
                <input type="hidden" id="customAircraftOriginalName" value="">
                
                <!-- Basic Information Section -->
                <div class="input-section">
                    <div class="input-group">
                        <label class="input-label">Aircraft Name</label>
                        <input type="text" class="input-field" id="customAircraftName" placeholder="e.g., My Custom Cessna">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Model/Type</label>
                        <input type="text" class="input-field" id="customAircraftModel" placeholder="e.g., C-172N">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Number of Seats</label>
                        <select class="select-field" id="customSeats" onchange="updateSeatConfiguration()">
                            <option value="2">2 Seats</option>
                            <option value="4" selected>4 Seats</option>
                        </select>
                    </div>
                </div>

                <!-- Station Arms Section -->
                <div class="input-section">
                    <div class="input-group">
                        <label class="input-label">Front Seat Arm (in)</label>
                        <input type="number" class="input-field" id="customPilotArm" placeholder="37.0" step="0.1">
                    </div>
                    <div class="input-group" id="rearSeatGroup">
                        <label class="input-label">Rear Seat Arm (in)</label>
                        <input type="number" class="input-field" id="customRearArm" placeholder="73.0" step="0.1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Baggage 1 Arm (in)</label>
                        <input type="number" class="input-field" id="customBaggage1Arm" placeholder="95.0" step="0.1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Baggage 2 Arm (in)</label>
                        <input type="number" class="input-field" id="customBaggage2Arm" placeholder="123.0" step="0.1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Fuel Arm (in)</label>
                        <input type="number" class="input-field" id="customFuelArm" placeholder="48.0" step="0.1">
                    </div>
                </div>

                <!-- Fuel Configuration Section -->
                <div class="input-section">
                    <div class="input-group">
                        <label class="input-label">Fuel Burn (Gal/hr)</label>
                        <input type="number" class="input-field" id="customFuelBurn" placeholder="8.5" step="0.1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Number of Fuel Tanks</label>
                        <input type="number" class="input-field" id="customFuelTanks" placeholder="2" min="1" max="6" onchange="updateCustomFuelTanks()">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Fuel Weight (lbs/gal)</label>
                        <input type="number" class="input-field" id="customFuelWeight" placeholder="6.0" step="0.1" value="6.0">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Ground Fuel Use (gal)</label>
                        <input type="number" class="input-field" id="customGroundFuelUse" placeholder="1.0" step="0.1">
                    </div>
                    <div id="customFuelTankInputs"></div>
                </div>

                <!-- Weight & Balance Limits Section -->
                <div class="input-section">
                    <div class="input-group">
                        <label class="input-label">Forward CG Limit (in)</label>
                        <input type="number" class="input-field" id="customForwardCG" placeholder="35.0" step="0.1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Aft CG Limit (in)</label>
                        <input type="number" class="input-field" id="customAftCG" placeholder="47.3" step="0.1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Max Takeoff Weight (lbs)</label>
                        <input type="number" class="input-field" id="customMaxWeight" placeholder="2400" step="0.1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Max Landing Weight (lbs)</label>
                        <input type="number" class="input-field" id="customMaxLandingWeight" placeholder="2400" step="0.1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Max Crosswind (kts)</label>
                        <input type="number" class="input-field" id="customMaxCrosswind" placeholder="15" step="1">
                    </div>
                </div>
                <!-- V-Speeds Section -->
                <div class="input-section">
                    <div class="input-group">
                        <label class="input-label">Vr (kts)</label>
                        <input type="number" class="input-field" id="customVr" placeholder="55" step="1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Vxse (kts)</label>
                        <input type="number" class="input-field" id="customVxse" placeholder="" step="1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Vle (kts)</label>
                        <input type="number" class="input-field" id="customVle" placeholder="" step="1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Vg (kts)</label>
                        <input type="number" class="input-field" id="customVg" placeholder="" step="1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Vr 50' (kts)</label>
                        <input type="number" class="input-field" id="customVr50" placeholder="" step="1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Vyse (kts)</label>
                        <input type="number" class="input-field" id="customVyse" placeholder="88" step="1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Vlo (kts)</label>
                        <input type="number" class="input-field" id="customVlo" placeholder="" step="1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Vmc (kts)</label>
                        <input type="number" class="input-field" id="customVmc" placeholder="" step="1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Vx (kts)</label>
                        <input type="number" class="input-field" id="customVx" placeholder="62" step="1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Vs0 (kts)</label>
                        <input type="number" class="input-field" id="customVs0" placeholder="40" step="1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Va (kts)</label>
                        <input type="number" class="input-field" id="customVa" placeholder="105" step="1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Vapp Short (kts)</label>
                        <input type="number" class="input-field" id="customVappShort" placeholder="" step="1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Vy (kts)</label>
                        <input type="number" class="input-field" id="customVy" placeholder="79" step="1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Vs1 (kts)</label>
                        <input type="number" class="input-field" id="customVs1" placeholder="48" step="1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Va Max (kts)</label>
                        <input type="number" class="input-field" id="customVaMax" placeholder="" step="1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Vapp Normal (kts)</label>
                        <input type="number" class="input-field" id="customVappNormal" placeholder="" step="1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Vcc (kts)</label>
                        <input type="number" class="input-field" id="customVcc" placeholder="122" step="1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Vfe (kts)</label>
                        <input type="number" class="input-field" id="customVfe" placeholder="85" step="1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Vne (kts)</label>
                        <input type="number" class="input-field" id="customVne" placeholder="163" step="1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Vapp Flapless (kts)</label>
                        <input type="number" class="input-field" id="customVappFlapless" placeholder="" step="1">
                    </div>
                </div>

                <!-- CG Envelope Section -->
                <div class="input-section">
                    <h4 style="color: #4CAF50; margin-bottom: 10px; font-size: 14px;">CG Envelope Points</h4>
                    <p style="color: #ccc; font-size: 11px; margin-bottom: 15px;">Define the CG envelope by entering coordinate points (CG position, Weight). Points will be connected in order to form the envelope.</p>
                    
                    <div id="cgEnvelopePoints">
                        <div class="cg-point-row" style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                            <div style="flex: 1;">
                                <label class="input-label" style="font-size: 11px;">CG Position</label>
                                <input type="number" class="input-field cg-position" placeholder="31.0" step="0.1" style="font-size: 12px; padding: 6px;">
                            </div>
                            <div style="flex: 1;">
                                <label class="input-label" style="font-size: 11px;">Weight (lbs)</label>
                                <input type="number" class="input-field cg-weight" placeholder="1000" step="1" style="font-size: 12px; padding: 6px;">
                            </div>
                            <button type="button" onclick="removeCGPoint(this)" style="background-color: #f44336; color: white; border: none; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">√ó</button>
                        </div>
                        <div class="cg-point-row" style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                            <div style="flex: 1;">
                                <label class="input-label" style="font-size: 11px;">CG Position</label>
                                <input type="number" class="input-field cg-position" placeholder="31.0" step="0.1" style="font-size: 12px; padding: 6px;">
                            </div>
                            <div style="flex: 1;">
                                <label class="input-label" style="font-size: 11px;">Weight (lbs)</label>
                                <input type="number" class="input-field cg-weight" placeholder="1350" step="1" style="font-size: 12px; padding: 6px;">
                            </div>
                            <button type="button" onclick="removeCGPoint(this)" style="background-color: #f44336; color: white; border: none; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">√ó</button>
                        </div>
                        <div class="cg-point-row" style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                            <div style="flex: 1;">
                                <label class="input-label" style="font-size: 11px;">CG Position</label>
                                <input type="number" class="input-field cg-position" placeholder="32.6" step="0.1" style="font-size: 12px; padding: 6px;">
                            </div>
                            <div style="flex: 1;">
                                <label class="input-label" style="font-size: 11px;">Weight (lbs)</label>
                                <input type="number" class="input-field cg-weight" placeholder="1670" step="1" style="font-size: 12px; padding: 6px;">
                            </div>
                            <button type="button" onclick="removeCGPoint(this)" style="background-color: #f44336; color: white; border: none; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">√ó</button>
                        </div>
                        <div class="cg-point-row" style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                            <div style="flex: 1;">
                                <label class="input-label" style="font-size: 11px;">CG Position</label>
                                <input type="number" class="input-field cg-position" placeholder="36.5" step="0.1" style="font-size: 12px; padding: 6px;">
                            </div>
                            <div style="flex: 1;">
                                <label class="input-label" style="font-size: 11px;">Weight (lbs)</label>
                                <input type="number" class="input-field cg-weight" placeholder="1670" step="1" style="font-size: 12px; padding: 6px;">
                            </div>
                            <button type="button" onclick="removeCGPoint(this)" style="background-color: #f44336; color: white; border: none; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">√ó</button>
                        </div>
                        <div class="cg-point-row" style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                            <div style="flex: 1;">
                                <label class="input-label" style="font-size: 11px;">CG Position</label>
                                <input type="number" class="input-field cg-position" placeholder="36.5" step="0.1" style="font-size: 12px; padding: 6px;">
                            </div>
                            <div style="flex: 1;">
                                <label class="input-label" style="font-size: 11px;">Weight (lbs)</label>
                                <input type="number" class="input-field cg-weight" placeholder="1000" step="1" style="font-size: 12px; padding: 6px;">
                            </div>
                            <button type="button" onclick="removeCGPoint(this)" style="background-color: #f44336; color: white; border: none; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">√ó</button>
                        </div>
                    </div>
                    
                    <button type="button" onclick="addCGPoint()" style="width: 100%; background-color: #2196F3; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 10px;">+ Add Point</button>
                    
                    <!-- Axis Configuration -->
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #555;">
                        <h5 style="color: #4CAF50; margin-bottom: 10px; font-size: 12px;">Chart Axis Configuration</h5>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <label class="input-label" style="font-size: 11px;">X-Axis Range (CG positions, comma-separated)</label>
                                <input type="text" class="input-field" id="customXAxisRange" placeholder="10,20,30,40,50,60" style="font-size: 12px; padding: 6px;">
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <div style="flex: 1;">
                                <label class="input-label" style="font-size: 11px;">Y-Axis Range (Weights, comma-separated)</label>
                                <input type="text" class="input-field" id="customYAxisRange" placeholder="1000,1100,1200,1300,1500,1600" style="font-size: 12px; padding: 6px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Data Section -->
                <div class="input-section">
                    <div class="input-group">
                        <label class="input-label">Service Ceiling (ft)</label>
                        <input type="number" class="input-field" id="customServiceCeiling" placeholder="14200" step="1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Rate of Climb (fpm)</label>
                        <input type="number" class="input-field" id="customRateOfClimb" placeholder="715" step="1">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Total Fuel Capacity (gal)</label>
                        <input type="number" class="input-field" id="customFuelCapacity" placeholder="56" step="0.1">
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="input-section" style="border-top: 1px solid #555; padding-top: 15px; margin-top: 20px;">
                    <div style="display: flex; gap: 10px; justify-content: space-between;">
                        <button type="button" onclick="clearCustomAircraftForm()" style="flex: 1; background-color: #666; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-size: 14px;">Clear</button>
                        <button type="button" onclick="loadCustomAircraftTemplate()" style="flex: 1; background-color: #2196F3; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-size: 14px;">Template</button>
                        <button type="button" onclick="saveCustomAircraft()" style="flex: 2; background-color: #4CAF50; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-size: 14px;">üíæ Save Aircraft</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- App Information Section -->
        <div class="input-section">
            <h3 style="color: #e0e0e0; margin-bottom: 15px; font-size: 16px;">About</h3>
            <p style="color: #ccc; font-size: 12px; line-height: 1.4;">
                Weight & Balance Calculator<br>
                Version 2.0<br>
                Supports C-152, C-172, P2006T, and custom aircraft<br>
                <br>
                Features:<br>
                ‚Ä¢ Real-time W&B calculations<br>
                ‚Ä¢ Performance data interpolation<br>
                ‚Ä¢ Aircraft profile management<br>
                ‚Ä¢ Custom aircraft builder<br>
                ‚Ä¢ Mobile-responsive design
            </p>
        </div>
    </div>

    <!-- Column Resizer between Settings Panel and Brain Column -->
    <div class="column-resizer" data-resize="settings-brain"></div>

    <!-- Brain Column (Column E) -->
    <div class="brain-panel brain-hidden" style="padding: 20px; overflow-y: auto; height: 100vh; display: none;">
        <h2 style="color: #4CAF50; margin-bottom: 20px; font-size: 18px;">üß† Brain</h2>
        
        <!-- Mnemonics Section -->
        <div class="input-section">
            <button onclick="toggleMnemonics()" style="
                background: linear-gradient(135deg, rgba(76, 175, 80, 0.3) 0%, rgba(76, 175, 80, 0.1) 100%);
                color: white;
                border: 1px solid #4CAF50;
                padding: 12px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                font-weight: bold;
                width: 100%;
                margin-bottom: 15px;
                box-shadow: 0 2px 4px rgba(76, 175, 80, 0.2);
            ">üìö Mnemonics</button>
            
            <div id="mnemonicsContainer" style="display: none;">
                <!-- Required Aircraft Documents -->
                <div class="mnemonic-item">
                    <div class="mnemonic-title" onclick="toggleMnemonicDetail('aircraft-docs')">
                        <span>‚úàÔ∏è Required Aircraft Documents (ARROW)</span>
                        <span class="expand-icon">+</span>
                    </div>
                    <div id="aircraft-docs" class="mnemonic-detail" style="display: none;">
                        <p><strong>A</strong> ‚Äì Airworthiness Certificate</p>
                        <p><strong>R</strong> ‚Äì Registration</p>
                        <p><strong>R</strong> ‚Äì Radio Operators License (International flights)</p>
                        <p><strong>O</strong> ‚Äì Operating Limitations</p>
                        <p><strong>W</strong> ‚Äì Weight and Balance Information</p>
                    </div>
                </div>

                <!-- Required Equipment for Day VFR -->
                <div class="mnemonic-item">
                    <div class="mnemonic-title" onclick="toggleMnemonicDetail('day-vfr')">
                        <span>‚òÄÔ∏è Required Equipment for Day VFR (91.205b) (ATOMS2 FLEAF)</span>
                        <span class="expand-icon">+</span>
                    </div>
                    <div id="day-vfr" class="mnemonic-detail" style="display: none;">
                        <p><strong>A</strong> ‚Äì Airspeed Indicator</p>
                        <p><strong>A</strong> ‚Äì Altimeter</p>
                        <p><strong>T</strong> ‚Äì Temperature Gauge (each liquid cooled engine)</p>
                        <p><strong>T</strong> ‚Äì Tachometer (each engine)</p>
                        <p><strong>O</strong> ‚Äì Oil Temperature Gauge (each air cooled engine)</p>
                        <p><strong>O</strong> ‚Äì Oil Pressure Gauge (each engine using the pressure system)</p>
                        <p><strong>M</strong> ‚Äì Manifold Pressure Gauge (each altitude engine)</p>
                        <p><strong>M</strong> ‚Äì Magnetic Compass</p>
                        <p><strong>S</strong> ‚Äì Seatbelt</p>
                        <p><strong>S</strong> ‚Äì Shoulder Harness (man. after July 18, 1978)</p>
                        <p><strong>F</strong> ‚Äì Fuel Quantity Indicator (each tank)</p>
                        <p><strong>L</strong> ‚Äì Landing Gear Position Indicator</p>
                        <p><strong>E</strong> ‚Äì Emergency Locator Transmitter (ELT)</p>
                        <p><strong>A</strong> ‚Äì Anti-Collision Lights (man. after March 11, 1996)</p>
                        <p><strong>F</strong> ‚Äì Flotation Device (for hire beyond power off glide distance from shore)</p>
                    </div>
                </div>

                <!-- Required Equipment for IFR Flight -->
                <div class="mnemonic-item">
                    <div class="mnemonic-title" onclick="toggleMnemonicDetail('ifr-equipment')">
                        <span>üõ©Ô∏è Required Equipment for IFR Flight (91.205d) (GRAB CARD)</span>
                        <span class="expand-icon">+</span>
                    </div>
                    <div id="ifr-equipment" class="mnemonic-detail" style="display: none;">
                        <p><strong>G</strong> ‚Äì Generator / Alternator</p>
                        <p><strong>R</strong> ‚Äì Radios (two-way) and Nav. Equipment</p>
                        <p><strong>A</strong> ‚Äì Altimeter (pressure sensitive)</p>
                        <p><strong>B</strong> ‚Äì Ball (Inclonometer)</p>
                        <p><strong>C</strong> ‚Äì Clock (must have sweeping seconds or digital display and must be installed in a/c)</p>
                        <p><strong>R</strong> ‚Äì Rate of Turn Indicator</p>
                        <p><strong>A</strong> ‚Äì Attitude Indicator</p>
                        <p><strong>D</strong> ‚Äì Direction Gyro</p>
                        <p><strong>D</strong> ‚Äì DME (above FL240)</p>
                    </div>
                </div>

                <!-- Required Inspections -->
                <div class="mnemonic-item">
                    <div class="mnemonic-title" onclick="toggleMnemonicDetail('inspections')">
                        <span>üîß Required Inspections (GAVIATES)</span>
                        <span class="expand-icon">+</span>
                    </div>
                    <div id="inspections" class="mnemonic-detail" style="display: none;">
                        <p><strong>G</strong> ‚Äì GPS (every 28 days)</p>
                        <p><strong>A</strong> ‚Äì Annual (every 12 calendar months)</p>
                        <p><strong>V</strong> ‚Äì VOR (every 30 days for IFR)</p>
                        <p><strong>I</strong> ‚Äì 100-hour Inspection (for hire)</p>
                        <p><strong>A</strong> ‚Äì Altimeter (every 24 calendar months for IFR)</p>
                        <p><strong>T</strong> ‚Äì Transponder (every 24 calendar months)</p>
                        <p><strong>E</strong> ‚Äì ELT (every 12 calendar months)</p>
                        <p><strong>S</strong> ‚Äì Static/Pitot System (every 24 calendar months for IFR)</p>
                        <p><strong>A</strong> ‚Äì Airworthiness Directives (as required)</p>
                    </div>
                </div>

                <!-- Pre-Flight Action -->
                <div class="mnemonic-item">
                    <div class="mnemonic-title" onclick="toggleMnemonicDetail('preflight')">
                        <span>üìã Pre-Flight Action (91.103) (WKRAFTN)</span>
                        <span class="expand-icon">+</span>
                    </div>
                    <div id="preflight" class="mnemonic-detail" style="display: none;">
                        <p><strong>W</strong> ‚Äì Weather and Forecasts</p>
                        <p><strong>K</strong> ‚Äì Known ATC Delays (IFR Flight)</p>
                        <p><strong>R</strong> ‚Äì Runway lengths of intended use</p>
                        <p><strong>A</strong> ‚Äì Alternates (IFR Flight)</p>
                        <p><strong>F</strong> ‚Äì Fuel Requirements</p>
                        <p><strong>T</strong> ‚Äì T/O and LDG Distances</p>
                        <p><strong>N</strong> ‚Äì NOTAMs</p>
                    </div>
                </div>

                <!-- VOR Receiver Checks -->
                <div class="mnemonic-item">
                    <div class="mnemonic-title" onclick="toggleMnemonicDetail('vor-checks')">
                        <span>üì° VOR Receiver Checks (91.171) (BAD VAG)</span>
                        <span class="expand-icon">+</span>
                    </div>
                    <div id="vor-checks" class="mnemonic-detail" style="display: none;">
                        <p><strong>B</strong> ‚Äì Bench (+/- 4)</p>
                        <p><strong>A</strong> ‚Äì Airway (+/- 6)</p>
                        <p><strong>D</strong> ‚Äì Dual (+/- 4)</p>
                        <p><strong>V</strong> ‚Äì VOT (+/- 4)</p>
                        <p><strong>A</strong> ‚Äì Airborne (+/- 6)</p>
                        <p><strong>G</strong> ‚Äì Ground (+/- 4)</p>
                    </div>
                </div>

                <!-- Clearance Information -->
                <div class="mnemonic-item">
                    <div class="mnemonic-title" onclick="toggleMnemonicDetail('clearance')">
                        <span>üìª Clearance Information (IFR Flight) (CRAFTT)</span>
                        <span class="expand-icon">+</span>
                    </div>
                    <div id="clearance" class="mnemonic-detail" style="display: none;">
                        <p><strong>C</strong> ‚Äì Clearance limit</p>
                        <p><strong>R</strong> ‚Äì Route of flight</p>
                        <p><strong>A</strong> ‚Äì Altitudes</p>
                        <p><strong>F</strong> ‚Äì Frequency</p>
                        <p><strong>T</strong> ‚Äì Transponder Code</p>
                        <p><strong>T</strong> ‚Äì Time of Void</p>
                    </div>
                </div>

                <!-- Lost Procedures -->
                <div class="mnemonic-item">
                    <div class="mnemonic-title" onclick="toggleMnemonicDetail('lost')">
                        <span>üß≠ Lost Procedures (VFR) (5 C's)</span>
                        <span class="expand-icon">+</span>
                    </div>
                    <div id="lost" class="mnemonic-detail" style="display: none;">
                        <p><strong>C</strong> ‚Äì Climb</p>
                        <p><strong>C</strong> ‚Äì Communicate</p>
                        <p><strong>C</strong> ‚Äì Confess</p>
                        <p><strong>C</strong> ‚Äì Comply</p>
                        <p><strong>C</strong> ‚Äì Conserve</p>
                    </div>
                </div>

                <!-- Types of Altitudes -->
                <div class="mnemonic-item">
                    <div class="mnemonic-title" onclick="toggleMnemonicDetail('altitude-types')">
                        <span>üìè Types of Altitudes (IPDAT)</span>
                        <span class="expand-icon">+</span>
                    </div>
                    <div id="altitude-types" class="mnemonic-detail" style="display: none;">
                        <p><strong>I</strong> ‚Äì Indicated ‚Äì Read off your Altimeter</p>
                        <p><strong>P</strong> ‚Äì Pressure ‚Äì Height above standard datum plane (29.92")</p>
                        <p><strong>D</strong> ‚Äì Density ‚Äì Pressure altitude corrected for non standard temperature</p>
                        <p><strong>A</strong> ‚Äì Absolute ‚Äì Height above the ground (AGL)</p>
                        <p><strong>T</strong> ‚Äì True ‚Äì Height above mean sea level (MSL)</p>
                    </div>
                </div>

                <!-- IFR Altitudes -->
                <div class="mnemonic-item">
                    <div class="mnemonic-title" onclick="toggleMnemonicDetail('ifr-altitudes')">
                        <span>üõ©Ô∏è IFR Altitudes (MOMMAD)</span>
                        <span class="expand-icon">+</span>
                    </div>
                    <div id="ifr-altitudes" class="mnemonic-detail" style="display: none;">
                        <p><strong>M</strong> ‚Äì MEA ‚Äì Minimum Enroute Altitude</p>
                        <p><strong>O</strong> ‚Äì MOCA ‚Äì Minimum Obstruction Clearance Altitude</p>
                        <p><strong>M</strong> ‚Äì OROCA ‚Äì Off Route Obstruction Clearance Altitude or MORA ‚Äì Minimum Off-Route Altitude</p>
                        <p><strong>M</strong> ‚Äì MAA ‚Äì Maximum Authorized Altitude</p>
                        <p><strong>A</strong> ‚Äì MCA ‚Äì Minimum Crossing Altitude</p>
                        <p><strong>D</strong> ‚Äì MRA ‚Äì Minimum Reception Altitude</p>
                        <p><strong>M</strong> ‚Äì MSA ‚Äì Minimum Safe Altitude</p>
                        <p><strong>A</strong> ‚Äì MVA ‚Äì Minimum Vectoring Altitude</p>
                        <p><strong>D</strong> ‚Äì DH ‚Äì Decision Height (AGL)</p>
                        <p><strong>A</strong> ‚Äì DA ‚Äì Decision Altitude (MSL)</p>
                        <p><strong>M</strong> ‚Äì MDA ‚Äì Minimum Descent Altitude (MSL)</p>
                    </div>
                </div>

                <!-- Pre-landing Check -->
                <div class="mnemonic-item">
                    <div class="mnemonic-title" onclick="toggleMnemonicDetail('gumps')">
                        <span>üõ¨ Pre-landing Check (GUMPS)</span>
                        <span class="expand-icon">+</span>
                    </div>
                    <div id="gumps" class="mnemonic-detail" style="display: none;">
                        <p><strong>G</strong> ‚Äì Gas (fuel pump on)</p>
                        <p><strong>U</strong> ‚Äì Undercarriage (Down and VERIFY 3-green)</p>
                        <p><strong>M</strong> ‚Äì Mixture (full rich)</p>
                        <p><strong>P</strong> ‚Äì Propeller (full forward)</p>
                        <p><strong>P</strong> ‚Äì Power (set)</p>
                        <p><strong>P</strong> ‚Äì Brake pressure (check for resistance)</p>
                        <p><strong>S</strong> ‚Äì Systems (engines instruments in the green)</p>
                        <p><strong>S</strong> ‚Äì Seatbelts (fastened)</p>
                    </div>
                </div>

                <!-- Night VFR Equipment -->
                <div class="mnemonic-item">
                    <div class="mnemonic-title" onclick="toggleMnemonicDetail('night-vfr')">
                        <span>üåô Night VFR Equipment (FLAPS)</span>
                        <span class="expand-icon">+</span>
                    </div>
                    <div id="night-vfr" class="mnemonic-detail" style="display: none;">
                        <p><strong>F</strong> ‚Äì Fuses (1 set or 3 of each ‚Äì in reach of pilot)</p>
                        <p><strong>L</strong> ‚Äì Landing Light (for hire)</p>
                        <p><strong>A</strong> ‚Äì Anti-Collision Lights (man. after August 11, 1971)</p>
                        <p><strong>P</strong> ‚Äì Position Lights</p>
                        <p><strong>S</strong> ‚Äì Source of electrical power</p>
                    </div>
                </div>

                <!-- CRM Principles -->
                <div class="mnemonic-item">
                    <div class="mnemonic-title" onclick="toggleMnemonicDetail('crm')">
                        <span>‚ö†Ô∏è Critical Engine Inoperative Vmc (CRMALOFT)</span>
                        <span class="expand-icon">+</span>
                    </div>
                    <div id="crm" class="mnemonic-detail" style="display: none;">
                        <p><strong>C</strong> ‚Äì Critical Engine Inoperative (failed engine windmilling, creating high drag)</p>
                        <p><strong>R</strong> ‚Äì Rearward Center of Gravity (reduces rudder effectiveness, increases Vmc)</p>
                        <p><strong>M</strong> ‚Äì Most Unfavorable Weight (lighter weight can increase Vmc due to less horizontal lift component)</p>
                        <p><strong>A</strong> ‚Äì Airborne/Out of Ground Effect (allows more rudder effectiveness but higher Vmc due to accelerated slipstream)</p>
                        <p><strong>L</strong> ‚Äì Landing Gear Up (removes drag on failed side, allows faster yaw and higher Vmc)</p>
                        <p><strong>O</strong> ‚Äì Operating Engine at Max Power (maximum yaw on good engine increases Vmc)</p>
                        <p><strong>F</strong> ‚Äì Flaps Up (flaps up position allows for higher Vmc)</p>
                        <p><strong>T</strong> ‚Äì Trimmed for Takeoff (rudder trim set for takeoff increases Vmc)</p>
                    </div>
                </div>

                <!-- Multi-Engine Operations -->
                <div class="mnemonic-item">
                    <div class="mnemonic-title" onclick="toggleMnemonicDetail('multi-engine')">
                        <span>üõ©Ô∏è Critical Engine Determination (PAST)</span>
                        <span class="expand-icon">+</span>
                    </div>
                    <div id="multi-engine" class="mnemonic-detail" style="display: none;">
                        <p><strong>P</strong> ‚Äì P-Factor (Asymmetric Thrust - descending propeller blade produces more thrust, center of thrust on right engine further from CG)</p>
                        <p><strong>A</strong> ‚Äì Accelerated Slipstream (Roll - right engine creates accelerated airflow over wing, more lift further from CG causes severe roll when left engine fails)</p>
                        <p><strong>S</strong> ‚Äì Spiraling Slipstream (Yaw - left engine slipstream strikes vertical stabilizer from left, helping counteract yaw from failed right engine)</p>
                        <p><strong>T</strong> ‚Äì Torque (Roll - clockwise torque from right engine causes greater roll toward dead engine in left engine failure)</p>
                    </div>
                </div>

                <!-- Pre-Maneuver Checklist -->
                <div class="mnemonic-item">
                    <div class="mnemonic-title" onclick="toggleMnemonicDetail('pre-maneuver')">
                        <span>üîÑ Pre-Maneuver Checklist (CCMALS)</span>
                        <span class="expand-icon">+</span>
                    </div>
                    <div id="pre-maneuver" class="mnemonic-detail" style="display: none;">
                        <p><strong>C</strong> ‚Äì Clearing Turns (visually checking for traffic)</p>
                        <p><strong>C</strong> ‚Äì Configuration (setting aircraft - flaps, power)</p>
                        <p><strong>M</strong> ‚Äì Minimum Safe Altitude (ensuring required altitude - 1,500' or 2,000' AGL)</p>
                        <p><strong>A</strong> ‚Äì Airspeed (establishing proper speed)</p>
                        <p><strong>L</strong> ‚Äì Landing Area (identifying emergency landing spot)</p>
                        <p><strong>S</strong> ‚Äì Scan/Seatbelts (scanning for traffic and securing belts)</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- General Aviation Knowledge Section -->
        <div class="input-section">
            <button onclick="toggleGeneralKnowledge()" style="
                background: linear-gradient(135deg, rgba(156, 39, 176, 0.3) 0%, rgba(156, 39, 176, 0.1) 100%);
                color: white;
                border: 1px solid #9C27B0;
                padding: 12px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                font-weight: bold;
                width: 100%;
                margin-bottom: 15px;
                box-shadow: 0 2px 4px rgba(156, 39, 176, 0.2);
            ">üìö General Aviation Knowledge</button>
            
            <div id="generalKnowledgeContainer" style="display: none;">
                <!-- Required Documents & Currency -->
                <div class="mnemonic-item">
                    <div class="mnemonic-title" onclick="toggleMnemonicDetail('docs-currency')">
                        <span>üìã Documents & Currency</span>
                        <span class="expand-icon">+</span>
                    </div>
                    <div id="docs-currency" class="mnemonic-detail" style="display: none;">
                        <div style="margin-bottom: 15px; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 6px;">
                            <h4 style="color: #9C27B0; margin-bottom: 8px;">üë®‚Äç‚úàÔ∏è Required Pilot Documents</h4>
                            <p>‚Ä¢ Valid Government Issued Photo I.D.</p>
                            <p>‚Ä¢ Current Pilot's Certificate</p>
                            <p>‚Ä¢ Current Medical Certificate</p>
                            <p>‚Ä¢ Logbook (student pilots only)</p>
                        </div>

                        <div style="margin-bottom: 15px; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 6px;">
                            <h4 style="color: #9C27B0; margin-bottom: 8px;">‚è∞ Pilot Currency Requirements</h4>
                            <p><strong>General:</strong> Flight Review, FAA Checkride, or WINGS program within preceding 24 calendar months</p>
                            <p><strong>With PAX:</strong> 3 T/O and LDGs within preceding 90 (must be full stop if flight will be at night or in a tailwheel aircraft)</p>
                            <p><strong>IFR Flight:</strong> 6 Instrument Approaches, Holding, Intercepting, and Tracking Course within preceding 6 months (or Instrument Proficiency Check)</p>
                        </div>

                        <div style="margin-bottom: 15px; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 6px;">
                            <h4 style="color: #9C27B0; margin-bottom: 8px;">üè• Medical Certificates</h4>
                            <p><strong>1st Class:</strong> Valid for 12 calendar months (6 if over 40)</p>
                            <p><strong>2nd Class:</strong> Valid for 12 calendar months</p>
                            <p><strong>3rd Class:</strong> Valid for 60 calendar months (24 if over 40)</p>
                            <p><em>*1st reverts to 2nd which reverts to 3rd</em></p>
                        </div>
                    </div>
                </div>

                <!-- Equipment Requirements -->
                <div class="mnemonic-item">
                    <div class="mnemonic-title" onclick="toggleMnemonicDetail('equipment-reqs')">
                        <span>üõ©Ô∏è Equipment Requirements</span>
                        <span class="expand-icon">+</span>
                    </div>
                    <div id="equipment-reqs" class="mnemonic-detail" style="display: none;">
                    </div>
                </div>

                <!-- Airspace & Weather -->
                <div class="mnemonic-item">
                    <div class="mnemonic-title" onclick="toggleMnemonicDetail('airspace-weather')">
                        <span>‚òÅÔ∏è Airspace & Weather</span>
                        <span class="expand-icon">+</span>
                    </div>
                    <div id="airspace-weather" class="mnemonic-detail" style="display: none;">
                        <div style="margin-bottom: 15px; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 6px;">
                            <h4 style="color: #9C27B0; margin-bottom: 8px;">üó∫Ô∏è Airspace Dimensions</h4>
                            <p><strong>Class A:</strong> FL180 to FL600 and over the entire U.S. and extends 12 NM off the coast line</p>
                            <p><strong>Class B:</strong> Extends from the surface to 10,000MSL in multiple shelves. Generally extends laterally from the airport to 30NM.</p>
                            <p><strong>Class C:</strong> Extends from the surface to 4,000AGL with 1 shelf (lower shelf starts at 1,200AGL). Generally extends laterally from the airport to 10NM.</p>
                            <p><strong>Class D:</strong> Extends from the surface to 2,500AGL. Generally extends laterally from the airport to 4NM.</p>
                            <p><strong>Class E:</strong> Extends from either SFC, 700AGL, or 1,200AGL to 17,999MSL.</p>
                            <p><strong>Class G:</strong> Extends from SFC to 700AGL or 1200AGL. Maximum altitude is 14,500MSL (out west)</p>
                            <p><em>*Class A > B > C > D > E > G in hierarchy.</em></p>
                        </div>

                        <div style="margin-bottom: 15px; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 6px;">
                            <h4 style="color: #9C27B0; margin-bottom: 8px;">üì° Airspace Equipment Requirements</h4>
                            <p><strong>Class A:</strong> IFR flight plan, A/C IFR equip, IFR current</p>
                            <p><strong>Class B:</strong> Two-way radio, Mode C transponder, clearance into specific Class B airspace</p>
                            <p><strong>Class C:</strong> Two-way radio, Mode C transponder, est. 2 way radio contact</p>
                            <p><strong>Class D:</strong> Two-way radio. Establish 2 way radio contact</p>
                            <p><strong>Class E:</strong> None</p>
                            <p><strong>Class G:</strong> None</p>
                        </div>

                        <div style="margin-bottom: 15px; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 6px;">
                            <h4 style="color: #9C27B0; margin-bottom: 8px;">‚òÅÔ∏è VFR Weather Requirements</h4>
                            <p><strong>Class A:</strong> VFR N/A</p>
                            <p><strong>Class B:</strong> 3SM visibility, Clear of clouds</p>
                            <p><strong>Class C:</strong> 3SM visibility, 1000 above, 500 below, 2000 horizontal from any clouds (3-152)</p>
                            <p><strong>Class D:</strong> 3SM visibility, 1000 above, 500 below, 2000 horizontal from any clouds (3-152)</p>
                            <p><strong>Class E below 10k:</strong> 3SM visibility, 1000 above, 500 below, 2000 horizontal from any clouds (3-152)</p>
                            <p><strong>Class E >10k:</strong> 5SM visibility, 1000 above, 1000 below, 1 SM horizontal from any clouds (5-111)</p>
                            <p><strong>Class G <1200AGL day:</strong> 1SM visibility, Clear of clouds</p>
                            <p><strong>Class G >1200AGL, <10k MSL:</strong> 1SM 1000 above, 500 below, 2000 horizontal from any clouds (3-152)</p>
                            <p><strong>Class G >1200AGL, >10k MSL:</strong> 5SM visibility, 1000 above, 1000 below, 1 SM horizontal from any clouds (5-111)</p>
                            <p><strong>Class G during night:</strong> 3SM visibility, 1000 above, 500 below, 2000 horizontal from any clouds (3-152)</p>
                        </div>

                        <div style="margin-bottom: 15px; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 6px;">
                            <h4 style="color: #9C27B0; margin-bottom: 8px;">‚õ∞Ô∏è Minimum Safe Altitudes (91.119)</h4>
                            <p><strong>Anywhere:</strong> Altitude at which should a powerplant fail, a safe landing can be made without undue harm to persons or property on the surface.</p>
                            <p><strong>Congested areas:</strong> 2000ft horizontal, 1000ft above the highest obstacle</p>
                            <p><strong>Other than congested area:</strong> 500ft above the surface</p>
                            <p><strong>Over water or sparse areas:</strong> 500ft from any person, vessel, vehicle, or structure</p>
                        </div>
                    </div>
                </div>

                <!-- Regulations & Procedures -->
                <div class="mnemonic-item">
                    <div class="mnemonic-title" onclick="toggleMnemonicDetail('regulations')">
                        <span>‚öñÔ∏è Regulations & Procedures</span>
                        <span class="expand-icon">+</span>
                    </div>
                    <div id="regulations" class="mnemonic-detail" style="display: none;">
                        <div style="margin-bottom: 15px; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 6px;">
                            <h4 style="color: #9C27B0; margin-bottom: 8px;">‚ö†Ô∏è Inoperative Equipment Test (91.213)</h4>
                            <p><strong>1.</strong> VFR Day Type Certificate</p>
                            <p><strong>2.</strong> Kinds of Operations List</p>
                            <p><strong>3.</strong> 91.205 Requirements</p>
                            <p><strong>4.</strong> Airworthiness Directives</p>
                            <p><em>---If item passes all 4 steps</em></p>
                            <p><strong>1.</strong> Deactivate and Placard INOPERATIVE (entire word)</p>
                            <p><strong>2.</strong> Remove Item and redo weight and balance</p>
                            <p><em>*Minimum Equipment List DO NOT require use of the 4-step test. MELs contain items that can break and not affect airworthiness of the aircraft. MELs are tail number specific.</em></p>
                        </div>

                        <div style="margin-bottom: 15px; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 6px;">
                            <h4 style="color: #9C27B0; margin-bottom: 8px;">üéõÔ∏è Instrument Cockpit Check</h4>
                            <p><strong>Airspeed:</strong> Reading 0kts</p>
                            <p><strong>Altimeter:</strong> +/- 75 ft of field elevation</p>
                            <p><strong>Attitude:</strong> Erect, bank no more than 5¬∞</p>
                            <p><strong>Compass:</strong> Swinging feely, full of fluid, known headings</p>
                            <p><strong>D.G.:</strong> Matches compass, known headings, moving in the right direction during turns</p>
                            <p><strong>Turn and Bank:</strong> Ball to outside of turn, coordinator goes with turn</p>
                            <p><strong>Vertical Speed:</strong> Value read will be 0fpm for the flight</p>
                        </div>

                        <div style="margin-bottom: 15px; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 6px;">
                            <h4 style="color: #9C27B0; margin-bottom: 8px;">ü´Å Supplemental Oxygen Requirements (91.211)</h4>
                            <p><strong>12,500:</strong> Minimum flight crew must use supp. oxygen for time period greater than 30 minutes</p>
                            <p><strong>14,000:</strong> Minimum flight crew must use supp. oxygen.</p>
                            <p><strong>15,000:</strong> All flight crew must use supp. oxygen. Passengers must be supplied with supp. oxygen.</p>
                        </div>

                        <div style="margin-bottom: 15px; padding: 10px; background: rgba(156, 39, 176, 0.1); border-radius: 6px;">
                            <h4 style="color: #9C27B0; margin-bottom: 8px;">‚öñÔ∏è Aircraft Load Factors</h4>
                            <p><strong>Normal:</strong> + 3.8 g's - 1.52 g's</p>
                            <p><strong>Utility:</strong> + 4.4 g's - 1.76 g's</p>
                            <p><strong>Acrobatic:</strong> + 6.0 g's - 3.00 g's</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    </div> <!-- Close desktop-layout div -->

    <!-- Floating Risk Toggle (Desktop Only) -->
    <div class="risk-toggle" onclick="toggleRiskPanel()" style="
        position: fixed;
        top: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, rgba(255, 152, 0, 0.3) 0%, rgba(255, 152, 0, 0.1) 100%);
        border: 1px solid #FF9800;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        z-index: 1000;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
    " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
        ‚ö†Ô∏è
    </div>

    <!-- Floating Settings Toggle (Desktop Only) -->
    <div class="settings-toggle" onclick="toggleSettingsPanel()" style="
        position: fixed;
        top: 20px;
        right: 80px;
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, rgba(76, 175, 80, 0.3) 0%, rgba(76, 175, 80, 0.1) 100%);
        border: 1px solid #4CAF50;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        z-index: 1000;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
    " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
        ‚öôÔ∏è
    </div>

    <!-- Floating Brain Toggle (Desktop Only) -->
    <div class="brain-toggle" onclick="toggleBrainPanel()" style="
        position: fixed;
        top: 20px;
        right: 140px;
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, rgba(76, 175, 80, 0.3) 0%, rgba(76, 175, 80, 0.1) 100%);
        border: 1px solid #4CAF50;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        z-index: 1000;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
    " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
        üß†
    </div>

    <!-- Mobile Navigation (Mobile Only) -->
    <div class="mobile-nav" style="
        display: flex;
        overflow-x: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
        white-space: nowrap;
    ">
        <style>
        .mobile-nav::-webkit-scrollbar {
            display: none;
        }
        .mobile-nav-btn {
            flex: 0 0 auto;
            min-width: 80px;
        }
        </style>
        <button class="mobile-nav-btn" onclick="showMobileColumn('left')">
            <div class="nav-icon">üìä</div>
            <div>Data</div>
        </button>
        <button class="mobile-nav-btn" onclick="showMobileColumn('right')">
            <div class="nav-icon">üìà</div>
            <div>Charts</div>
        </button>
        <button class="mobile-nav-btn" onclick="showMobileColumn('risk')">
            <div class="nav-icon">‚ö†Ô∏è</div>
            <div>Risk</div>
        </button>
        <button class="mobile-nav-btn" onclick="showMobileColumn('settings')">
            <div class="nav-icon">‚öôÔ∏è</div>
            <div>Settings</div>
        </button>
        <button class="mobile-nav-btn" onclick="showMobileColumn('brain')">
            <div class="nav-icon">üß†</div>
            <div>Brain</div>
        </button>
    </div>

    <script>
        // New Mobile Column Switching
        function showMobileColumn(column) {
            console.log('Showing mobile column:', column);
            
            const desktopLayout = document.querySelector('.desktop-layout');
            const leftPanel = document.querySelector('.left-panel');
            const rightColumn = document.querySelector('.right-column');
            const navButtons = document.querySelectorAll('.mobile-nav-btn');
            
            if (!desktopLayout) return;
            
            // Remove active class from all nav buttons
            navButtons.forEach(btn => btn.classList.remove('active'));
            
            // Add active class to clicked button
            if (event && event.target) {
                const button = event.target.closest('.mobile-nav-btn');
                if (button) {
                    button.classList.add('active');
                }
            }
            
            // Remove all mobile column classes
            desktopLayout.classList.remove('mobile-show-left', 'mobile-show-right', 'mobile-show-risk', 'mobile-show-settings', 'mobile-show-brain');
            
            // Add appropriate mobile column class
            switch(column) {
                case 'left':
                    desktopLayout.classList.add('mobile-show-left');
                    break;
                case 'right':
                    desktopLayout.classList.add('mobile-show-right');
                    // Redraw charts after a short delay to ensure proper rendering
                    setTimeout(() => {
                        updateWeightBalanceCalculations();
                        updateTakeoffPerformance();
                        updateLandingPerformance();
                        // Redraw CG chart for mobile
                        drawCGChart();
                    }, 100);
                    break;
                case 'risk':
                    desktopLayout.classList.add('mobile-show-risk');
                    // Redraw risk assessment after a short delay
                    setTimeout(() => {
                        updateGrandTotal();
                    }, 100);
                    break;
                case 'settings':
                    desktopLayout.classList.add('mobile-show-settings');
                    break;
                case 'brain':
                    desktopLayout.classList.add('mobile-show-brain');
                    break;
            }
        }

        // Toggle brain panel visibility (desktop only)
        function toggleBrainPanel() {
            const brainPanel = document.querySelector('.brain-panel');
            const desktopLayout = document.querySelector('.desktop-layout');
            
            if (!brainPanel || !desktopLayout) return;
            
            // Check if brain panel is currently visible
            const isVisible = brainPanel.classList.contains('brain-visible') || 
                             (window.getComputedStyle(brainPanel).display !== 'none');
            
            if (isVisible) {
                // Hide the brain panel
                brainPanel.classList.add('brain-hidden');
                brainPanel.classList.remove('brain-visible');
                desktopLayout.classList.add('brain-collapsed');
            } else {
                // Show the brain panel
                brainPanel.classList.remove('brain-hidden');
                brainPanel.classList.add('brain-visible');
                desktopLayout.classList.remove('brain-collapsed');
            }
        }

        // Toggle risk panel visibility (desktop only)
        function toggleRiskPanel() {
            const riskPanel = document.querySelector('.risk-column');
            const desktopLayout = document.querySelector('.desktop-layout');
            
            if (!riskPanel || !desktopLayout) return;
            
            // Check if risk panel is currently visible
            const isVisible = riskPanel.classList.contains('risk-visible') || 
                             (window.getComputedStyle(riskPanel).display !== 'none');
            
            if (isVisible) {
                // Hide the risk panel
                riskPanel.classList.add('risk-hidden');
                riskPanel.classList.remove('risk-visible');
                desktopLayout.classList.add('risk-collapsed');
            } else {
                // Show the risk panel
                riskPanel.classList.remove('risk-hidden');
                riskPanel.classList.add('risk-visible');
                desktopLayout.classList.remove('risk-collapsed');
            }
        }

        // Toggle mnemonics container visibility
        function toggleMnemonics() {
            const container = document.getElementById('mnemonicsContainer');
            const button = event.target;
            
            if (container.style.display === 'none' || container.style.display === '') {
                container.style.display = 'block';
                button.textContent = 'üìö Hide Mnemonics';
                button.style.background = 'linear-gradient(135deg, rgba(255, 87, 34, 0.3) 0%, rgba(255, 87, 34, 0.1) 100%)';
                button.style.borderColor = '#FF5722';
            } else {
                container.style.display = 'none';
                button.textContent = 'üìö Mnemonics';
                button.style.background = 'linear-gradient(135deg, rgba(76, 175, 80, 0.3) 0%, rgba(76, 175, 80, 0.1) 100%)';
                button.style.borderColor = '#4CAF50';
            }
        }

        // Toggle general knowledge container visibility
        function toggleGeneralKnowledge() {
            const container = document.getElementById('generalKnowledgeContainer');
            const button = event.target;
            
            if (container.style.display === 'none' || container.style.display === '') {
                container.style.display = 'block';
                button.textContent = 'üìö Hide General Knowledge';
                button.style.background = 'linear-gradient(135deg, rgba(255, 87, 34, 0.3) 0%, rgba(255, 87, 34, 0.1) 100%)';
                button.style.borderColor = '#FF5722';
            } else {
                container.style.display = 'none';
                button.textContent = 'üìö General Aviation Knowledge';
                button.style.background = 'linear-gradient(135deg, rgba(156, 39, 176, 0.3) 0%, rgba(156, 39, 176, 0.1) 100%)';
                button.style.borderColor = '#9C27B0';
            }
        }

        // Toggle individual mnemonic detail visibility
        function toggleMnemonicDetail(id) {
            const detail = document.getElementById(id);
            const title = event.target.closest('.mnemonic-title');
            const icon = title.querySelector('.expand-icon');
            
            if (detail.style.display === 'none' || detail.style.display === '') {
                detail.style.display = 'block';
                icon.textContent = '‚àí';
                title.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
            } else {
                detail.style.display = 'none';
                icon.textContent = '+';
                title.style.backgroundColor = '';
            }
        }
        function toggleSettingsPanel() {
            const settingsPanel = document.querySelector('.settings-panel');
            const desktopLayout = document.querySelector('.desktop-layout');
            
            if (!settingsPanel || !desktopLayout) return;
            
            // Check if settings panel is currently visible
            const isVisible = settingsPanel.classList.contains('settings-visible') || 
                             (window.getComputedStyle(settingsPanel).display !== 'none');
            
            if (isVisible) {
                // Hide the settings panel
                settingsPanel.classList.add('settings-hidden');
                settingsPanel.classList.remove('settings-visible');
                desktopLayout.classList.add('settings-collapsed');
            } else {
                // Show the settings panel
                settingsPanel.classList.remove('settings-hidden');
                settingsPanel.classList.add('settings-visible');
                desktopLayout.classList.remove('settings-collapsed');
            }
        }

        // Risk Assessment Functions
        let riskScores = {};

        function selectRisk(riskId, value) {
            // Remove selection from all buttons in this row
            const row = document.querySelector(`#${riskId}-total`).closest('.risk-row');
            const buttons = row.querySelectorAll('.risk-btn');
            buttons.forEach(btn => {
                btn.classList.remove('selected-1', 'selected-2', 'selected-3', 'selected-4', 'selected-5');
            });

            // Add selection to clicked button
            const clickedButton = row.querySelector(`[data-value="${value}"]`);
            if (clickedButton) {
                clickedButton.classList.add(`selected-${value}`);
            }

            // Store the score
            riskScores[riskId] = value;

            // Update row total
            document.getElementById(`${riskId}-total`).textContent = value;

            // Update section totals
            updateSectionTotals();
            updateGrandTotal();
        }

        function updateSectionTotals() {
            // Pilot section
            const pilotItems = ['pilot-illness', 'pilot-medication', 'pilot-stress', 'pilot-alcohol', 
                              'pilot-fatigue', 'pilot-eating', 'pilot-emotion', 'pilot-academy', 'pilot-currency'];
            let pilotTotal = pilotItems.reduce((sum, item) => sum + (riskScores[item] || 0), 0);
            document.getElementById('pilot-section-total').textContent = pilotTotal;

            // Aircraft section
            const aircraftItems = ['aircraft-single', 'aircraft-multi', 'aircraft-obstacle', 'aircraft-mx'];
            let aircraftTotal = aircraftItems.reduce((sum, item) => sum + (riskScores[item] || 0), 0);
            document.getElementById('aircraft-section-total').textContent = aircraftTotal;

            // Environment section
            const envItems = ['env-duration', 'env-backtoback', 'env-newairport', 'env-depvis', 
                            'env-depceil', 'env-destvis', 'env-destceil', 'env-xwind'];
            let envTotal = envItems.reduce((sum, item) => sum + (riskScores[item] || 0), 0);
            document.getElementById('environment-section-total').textContent = envTotal;

            // External Pressures section
            const extItems = ['ext-death', 'ext-pressure', 'ext-emergency', 'ext-mission', 'ext-type'];
            let extTotal = extItems.reduce((sum, item) => sum + (riskScores[item] || 0), 0);
            document.getElementById('external-section-total').textContent = extTotal;
        }

        function updateGrandTotal() {
            const pilotTotal = parseInt(document.getElementById('pilot-section-total').textContent) || 0;
            const aircraftTotal = parseInt(document.getElementById('aircraft-section-total').textContent) || 0;
            const envTotal = parseInt(document.getElementById('environment-section-total').textContent) || 0;
            const extTotal = parseInt(document.getElementById('external-section-total').textContent) || 0;

            const grandTotal = pilotTotal + aircraftTotal + envTotal + extTotal;
            
            const grandTotalDisplay = document.getElementById('grand-total-display');
            const riskMessage = document.getElementById('risk-message');
            
            grandTotalDisplay.textContent = grandTotal;
            
            // Update color and message based on total
            grandTotalDisplay.classList.remove('green', 'yellow', 'red');
            
            if (grandTotal <= 29) {
                grandTotalDisplay.classList.add('green');
                riskMessage.textContent = 'SP solos require IP sign off';
                riskMessage.style.color = '#4CAF50';
            } else if (grandTotal <= 39) {
                grandTotalDisplay.classList.add('yellow');
                riskMessage.textContent = 'All Solos require IP sign off';
                riskMessage.style.color = '#FFC107';
            } else {
                grandTotalDisplay.classList.add('red');
                riskMessage.textContent = 'Requires Manager Approval';
                riskMessage.style.color = '#f44336';
            }
        }

        // Column Resizing Functionality
        function initializeColumnResizers() {
            const resizers = document.querySelectorAll('.column-resizer');
            
            resizers.forEach(resizer => {
                let isResizing = false;
                let startX = 0;
                let startWidthLeft = 0;
                let startWidthRight = 0;
                let leftColumn = null;
                let rightColumn = null;
                
                resizer.addEventListener('mousedown', function(e) {
                    isResizing = true;
                    startX = e.clientX;
                    resizer.classList.add('resizing');
                    
                    // Determine which columns to resize based on data-resize attribute
                    const resizeType = resizer.getAttribute('data-resize');
                    
                    if (resizeType === 'left-right') {
                        leftColumn = document.querySelector('.left-panel');
                        rightColumn = document.querySelector('.right-column');
                    } else if (resizeType === 'right-risk') {
                        leftColumn = document.querySelector('.right-column');
                        rightColumn = document.querySelector('.risk-column');
                    } else if (resizeType === 'risk-settings') {
                        leftColumn = document.querySelector('.risk-column');
                        rightColumn = document.querySelector('.settings-panel');
                    }
                    
                    if (leftColumn && rightColumn) {
                        startWidthLeft = leftColumn.offsetWidth;
                        startWidthRight = rightColumn.offsetWidth;
                    }
                    
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                    
                    e.preventDefault();
                });
                
                function handleMouseMove(e) {
                    if (!isResizing || !leftColumn || !rightColumn) return;
                    
                    const deltaX = e.clientX - startX;
                    const newLeftWidth = startWidthLeft + deltaX;
                    const newRightWidth = startWidthRight - deltaX;
                    
                    // Set minimum widths based on column type
                    let minWidthLeft = 200;
                    let minWidthRight = 200;
                    
                    // Risk Assessment column needs more space
                    if (rightColumn && rightColumn.classList.contains('risk-column')) {
                        minWidthRight = 480;
                    }
                    if (leftColumn && leftColumn.classList.contains('risk-column')) {
                        minWidthLeft = 480;
                    }
                    
                    // Settings panel minimum width
                    if (rightColumn && rightColumn.classList.contains('settings-panel')) {
                        minWidthRight = 250;
                    }
                    if (leftColumn && leftColumn.classList.contains('settings-panel')) {
                        minWidthLeft = 250;
                    }
                    
                    if (newLeftWidth >= minWidthLeft && newRightWidth >= minWidthRight) {
                        leftColumn.style.width = newLeftWidth + 'px';
                        leftColumn.style.minWidth = newLeftWidth + 'px';
                        rightColumn.style.width = newRightWidth + 'px';
                        rightColumn.style.minWidth = newRightWidth + 'px';
                    }
                }
                
                function handleMouseUp() {
                    isResizing = false;
                    resizer.classList.remove('resizing');
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                    
                    // Redraw chart if right column was resized
                    if (leftColumn && leftColumn.classList.contains('right-column')) {
                        setTimeout(() => {
                            drawCGChart();
                        }, 100);
                    }
                }
            });
        }

        // Update width displays in real-time
        function updateWidthDisplays() {
            const panels = [
                { id: 'width-a', element: document.querySelector('.left-panel') },
                { id: 'width-b', element: document.querySelector('.right-column') },
                { id: 'width-c', element: document.querySelector('.risk-column') },
                { id: 'width-d', element: document.querySelector('.settings-panel') }
            ];
            
            panels.forEach(panel => {
                if (panel.element) {
                    const rect = panel.element.getBoundingClientRect();
                    const widthDisplay = document.getElementById(panel.id);
                    if (widthDisplay) {
                        const screenWidth = window.innerWidth;
                        const percentage = ((rect.width / screenWidth) * 100).toFixed(1);
                        widthDisplay.textContent = `${Math.round(rect.width)}px (${percentage}%)`;
                    }
                }
            });
        }

        // Debug function to log panel sizes (can be called from console)
        window.debugPanelSizes = function debugPanelSizes() {
            const panels = [
                { name: 'Panel A (Data)', element: document.querySelector('.left-panel') },
                { name: 'Panel B (Charts)', element: document.querySelector('.right-column') },
                { name: 'Panel C (Risk Assessment)', element: document.querySelector('.risk-column') },
                { name: 'Panel D (Settings)', element: document.querySelector('.settings-panel') }
            ];
            
            console.log('=== PANEL SIZE DEBUG ===');
            const screenWidth = window.innerWidth;
            console.log(`Screen Width: ${screenWidth}px`);
            console.log('---');
            
            panels.forEach(panel => {
                if (panel.element) {
                    const rect = panel.element.getBoundingClientRect();
                    const computedStyle = window.getComputedStyle(panel.element);
                    const percentage = ((rect.width / screenWidth) * 100).toFixed(1);
                    console.log(`${panel.name}:`);
                    console.log(`  Actual width: ${rect.width}px (${percentage}%)`);
                    console.log(`  CSS flex: ${computedStyle.flex}`);
                    console.log(`  CSS min-width: ${computedStyle.minWidth}`);
                    console.log('---');
                }
            });
            
            updateWidthDisplays();
            console.log('=== END DEBUG ===');
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            initializeMobileInterface();
            initializeColumnResizers();
            
            // Update width displays after initialization
            setTimeout(() => {
                updateWidthDisplays();
                debugPanelSizes();
            }, 1000);
            
            // Add resize event listener
            window.addEventListener('resize', function() {
                setTimeout(() => {
                    drawCGChart();
                    updateWidthDisplays(); // Update displays on resize
                }, 100);
            });
            
            // Update width displays periodically and on column resize
            setInterval(updateWidthDisplays, 500);
        });
    </script>

    <script>
        // Aircraft specifications for different types
        const aircraftSpecs = {
            'C-152': {
                frontSeatArm: 39,
                rearSeatArm: null, // Block out rear seats
                baggage1Arm: 64,
                baggage2Arm: null, // Block out baggage 2
                fuelArm: 42.2,
                fuelWeightMultiplier: 6,
                fuelBurnRate: 6, // GPH
                groundFuelUse: -5,
                maxTakeoffWeight: 1710,
                maxLandingWeight: 1670,
                aftLimit: 36.5,
                demoCrosswind: 12,
                // CG forward limits based on weight (from POH table + STC)
                cgForwardLimits: [
                    { weight: 1000, cgLimit: 31.0 },
                    { weight: 1350, cgLimit: 31.0 },
                    { weight: 1670, cgLimit: 32.6 },
                    { weight: 1710, cgLimit: 33.0 }  // STC forward limit at max weight
                ]
            },
            'C-172': {
                frontSeatArm: 37,
                rearSeatArm: 73,
                baggage1Arm: 95,
                baggage2Arm: 142,
                fuelArm: 48,
                fuelWeightMultiplier: 6,
                fuelBurnRate: 8,
                groundFuelUse: -3
            },
            'P2006T': {
                basicEmptyWeight: 1470,
                basicEmptyArm: 2.477,
                frontSeatArm: -2.93,     // Front seats: -2.93 ft
                rearSeatArm: 0.741,      // Rear seats: 0.741 ft
                baggage1Arm: 3.986,      // Baggage 1: 3.986 ft
                baggage2Arm: null,        // Baggage 2 arm (N/A)
                fuelArm: 2.477,          // Fuel arm
                groundFuelArm: 2.477,    // Ground fuel use arm
                estFuelBurnArm: 2.477,   // Est fuel burn arm (+25%)
                macConstant: 4.4,        // MAC constant for %MAC calculations (inches)
                demoCrosswind: 17,       // Demo crosswind limit: 17 kt
                fuelWeightMultiplier: 6, // 6 gallons per lb per tank
                fuelBurnRate: 9,         // 9 gal per hour
                groundFuelUse: -12,      // Always -12
                maxTakeoffWeight: 2712,
                maxLandingWeight: 2712,
                forwardLimit: 16.5,      // Forward CG limit up to 2712 lb, then 19.5% at 2844 lb
                aftLimit: 31,            // Aft CG limit for all conditions
                forwardLimitHigh: 19.5,  // Forward limit at maximum weight (2844 lb)
                forwardLimitWeight: 2712, // Weight at which forward limit changes
                seats: 4,
                fuelTanks: 2,
                fuelCapacity: 92         // Total fuel capacity in gallons
            },
            'P2010': {
                frontSeatArm: 89.8,
                rearSeatArm: 118.1,
                baggage1Arm: 142.2,
                fuelArm: 89.8,
                fuelWeightMultiplier: 6,
                fuelBurnRate: 10,
                groundFuelUse: -6
            }
        };

        // Update aircraft type display and populate aircraft-specific values
        document.getElementById('aircraftType').addEventListener('change', function() {
            const aircraftType = this.value;
            const display = document.getElementById('aircraftTypeDisplay');
            const mobileDisplay = document.getElementById('aircraftTypeDisplay-mobile');
            display.textContent = aircraftType;
            if (mobileDisplay) mobileDisplay.textContent = aircraftType;
            
            // Sync mobile dropdown
            const mobileSelect = document.getElementById('aircraftType-mobile');
            if (mobileSelect) mobileSelect.value = aircraftType;
            
            // Handle custom aircraft selection
            if (aircraftType && aircraftType.startsWith('CUSTOM_')) {
                loadCustomAircraft(aircraftType);
            } else if (aircraftType && aircraftSpecs[aircraftType]) {
                populateAircraftSpecificValues(aircraftType);
            }
        });

        // Add mobile aircraft type listener
        const mobileAircraftType = document.getElementById('aircraftType-mobile');
        if (mobileAircraftType) {
            mobileAircraftType.addEventListener('change', function() {
                const aircraftType = this.value;
                const display = document.getElementById('aircraftTypeDisplay');
                const mobileDisplay = document.getElementById('aircraftTypeDisplay-mobile');
                display.textContent = aircraftType;
                if (mobileDisplay) mobileDisplay.textContent = aircraftType;
                
                // Sync desktop dropdown
                const desktopSelect = document.getElementById('aircraftType');
                if (desktopSelect) desktopSelect.value = aircraftType;
                
                // Handle custom aircraft selection
                if (aircraftType && aircraftType.startsWith('CUSTOM_')) {
                    loadCustomAircraft(aircraftType);
                } else if (aircraftType && aircraftSpecs[aircraftType]) {
                    populateAircraftSpecificValues(aircraftType);
                }
            });
        }

        function populateAircraftSpecificValues(aircraftType) {
            console.log('populateAircraftSpecificValues called with:', aircraftType);
            const specs = aircraftSpecs[aircraftType];
            console.log('Aircraft specs:', specs);
            if (!specs) {
                return;
            }
            
            // Clear all arms first
            const allArmCells = document.querySelectorAll('.data-table tbody tr td:nth-child(3)');
            allArmCells.forEach(cell => cell.textContent = '');
            console.log('Cleared', allArmCells.length, 'arm cells');
            
            // Clear all weights except basic empty weight
            const allWeightCells = document.querySelectorAll('.data-table tbody tr td:nth-child(2)');
            allWeightCells.forEach((cell, index) => {
                if (index !== 0) { // Don't clear basic empty weight
                    cell.textContent = '';
                }
            });
            console.log('Cleared weight cells (except basic empty weight)');
            
            // Get specific table cells for arms (using tbody to be more specific)
            const frontSeatArmCell = document.querySelector('.data-table tbody tr:nth-child(2) td:nth-child(3)'); // Front Seat arm
            const rearSeatRow = document.querySelector('.data-table tbody tr:nth-child(3)'); // Rear Seat row
            const baggage1ArmCell = document.querySelector('.data-table tbody tr:nth-child(4) td:nth-child(3)'); // Baggage 1 arm (back to row 4)
            const fuelArmCell = document.querySelector('.data-table tbody tr:nth-child(7) td:nth-child(3)'); // Fuel arm (back to row 7)
            const grndFuelArmCell = document.querySelector('.data-table tbody tr:nth-child(9) td:nth-child(3)'); // Grnd Fuel Use arm (back to row 9)
            const grndFuelWeightCell = document.querySelector('.data-table tbody tr:nth-child(9) td:nth-child(2)'); // Grnd Fuel Use weight (back to row 9)
            const estFuelBurnArmCell = document.querySelector('.data-table tbody tr:nth-child(11) td:nth-child(3)'); // Est Fuel Burn arm (back to row 11)
            
            // Populate only the correct arms
            if (frontSeatArmCell) {
                frontSeatArmCell.textContent = specs.frontSeatArm;
                console.log('Set front seat arm to:', specs.frontSeatArm);
            }
            if (baggage1ArmCell) {
                baggage1ArmCell.textContent = specs.baggage1Arm;
                console.log('Set baggage 1 arm to:', specs.baggage1Arm);
            }
            if (fuelArmCell) {
                fuelArmCell.textContent = specs.fuelArm;
                console.log('Set fuel arm to:', specs.fuelArm);
            }
            
            // Handle different fuel arm configurations for P2006T
            if (aircraftType === 'P2006T') {
                if (grndFuelArmCell) grndFuelArmCell.textContent = specs.groundFuelArm;
                if (estFuelBurnArmCell) estFuelBurnArmCell.textContent = specs.estFuelBurnArm;
            } else {
                if (grndFuelArmCell) grndFuelArmCell.textContent = specs.fuelArm; // Same as fuel arm for other aircraft
                if (estFuelBurnArmCell) estFuelBurnArmCell.textContent = specs.fuelArm; // Same as fuel arm for other aircraft
            }
            
            if (grndFuelWeightCell) grndFuelWeightCell.textContent = specs.groundFuelUse;
            
            // Handle rear seat row for different aircraft types
            if (rearSeatRow) {
                const isTwoSeatAircraft = aircraftType === 'C-152' || specs.seats === 2;
                if (isTwoSeatAircraft) {
                    rearSeatRow.style.backgroundColor = '#2a2a2a';
                    rearSeatRow.style.opacity = '0.5';
                    const rearSeatCells = rearSeatRow.querySelectorAll('td');
                    rearSeatCells.forEach(cell => {
                        cell.textContent = 'N/A';
                        cell.style.fontStyle = 'italic';
                    });
                } else {
                    rearSeatRow.style.backgroundColor = '';
                    rearSeatRow.style.opacity = '';
                    const rearSeatCells = rearSeatRow.querySelectorAll('td');
                    rearSeatCells[0].textContent = 'Rear Seats';
                    rearSeatCells[1].textContent = '';
                    rearSeatCells[2].textContent = specs.rearSeatArm || '';
                    rearSeatCells[3].textContent = '';
                    console.log('Set rear seat arm to:', specs.rearSeatArm);
                    rearSeatCells.forEach(cell => {
                        cell.style.fontStyle = '';
                    });
                }
            }
            
            
            // Handle baggage 2 row for C-152 (block it out)
            const baggage2Row = document.querySelector('.data-table tbody tr:nth-child(5)'); // Baggage 2 row (back to row 5)
            if (baggage2Row) {
                const isTwoSeatAircraft = aircraftType === 'C-152' || specs.seats === 2;
                if (isTwoSeatAircraft) {
                    baggage2Row.style.backgroundColor = '#2a2a2a';
                    baggage2Row.style.opacity = '0.5';
                    const baggage2Cells = baggage2Row.querySelectorAll('td');
                    baggage2Cells.forEach(cell => {
                        cell.textContent = 'N/A';
                        cell.style.fontStyle = 'italic';
                    });
                } else {
                    baggage2Row.style.backgroundColor = '';
                    baggage2Row.style.opacity = '';
                    const baggage2Cells = baggage2Row.querySelectorAll('td');
                    baggage2Cells[0].textContent = 'Baggage 2';
                    baggage2Cells[1].textContent = '';
                    baggage2Cells[2].textContent = '';
                    baggage2Cells[3].textContent = '';
                    baggage2Cells.forEach(cell => {
                        cell.style.fontStyle = '';
                    });
                }
            }
            
            // Update calculations and displays
            updateDisplays();
            updateWeightBalanceCalculations();
            
            // Populate limits panel
            populateLimitsPanel(aircraftType, specs);
            
            // Draw CG chart
            drawCGChart();
            
            // Populate V-speeds panel
            populateVSpeedsPanel(aircraftType);
            
            // Update takeoff performance
            updateTakeoffPerformance();
            
            // Update landing performance
            updateLandingPerformance();
            
            // Populate demo data for C-152 if no existing data
            if (aircraftType === 'C-152') {
                populateC152DemoData();
            }
            
            // Update landing performance
            updateLandingPerformance();
        }

        function populateC152DemoData() {
            // Only populate if fields are empty to avoid overwriting user data
            const windDirection = document.getElementById('windDirection');
            const windSpeed = document.getElementById('windSpeed');
            const runwayHeading = document.getElementById('runwayHeading');
            
            if (!windDirection.value && !windSpeed.value && !runwayHeading.value) {
                // Set demo values that will result in 12kt crosswind
                // Wind from 090¬∞ at 15kts, runway 36 = 90¬∞ crosswind component
                windDirection.value = '090';
                windSpeed.value = '15';
                runwayHeading.value = '36';
                
                // Trigger calculations
                updateDisplays();
                updateWeightBalanceCalculations();
            }
        }
        
        // C-152 Performance Data Tables
        const C152_TAKEOFF_DATA = {
            // Pressure altitudes (rows)
            pressureAltitudes: [0, 1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000],
            // Temperatures (columns) - 0, 10, 20, 30, 40 degrees C
            temperatures: [0, 10, 20, 30, 40],
            // Ground roll distances (feet)
            groundRoll: [
                [540, 695, 755, 810, 875],    // Sea level
                [705, 765, 825, 890, 960],    // 1000 ft
                [775, 840, 910, 980, 1055],   // 2000 ft
                [865, 925, 1000, 1080, 1165], // 3000 ft
                [940, 1020, 1100, 1190, 1285], // 4000 ft
                [1040, 1125, 1215, 1315, 1420], // 5000 ft
                [1145, 1245, 1345, 1455, 1570], // 6000 ft
                [1270, 1375, 1490, 1615, 1745], // 7000 ft
                [1405, 1525, 1655, 1795, 1940]  // 8000 ft
            ],
            // 50ft obstacle clearance distances (feet)
            obstacle50ft: [
                [1190, 1290, 1390, 1495, 1605], // Sea level
                [1310, 1420, 1530, 1645, 1770], // 1000 ft
                [1445, 1565, 1690, 1820, 1960], // 2000 ft
                [1600, 1730, 1870, 2020, 2185], // 3000 ft
                [1775, 1920, 2080, 2250, 2440], // 4000 ft
                [1970, 2140, 2320, 2525, 2750], // 5000 ft
                [2200, 2395, 2610, 2855, 3125], // 6000 ft
                [2470, 2705, 2960, 3255, 3590], // 7000 ft
                [2800, 3080, 3385, 3765, 4195]  // 8000 ft
            ]
        };

        const C152_LANDING_DATA = {
            // Pressure altitudes (rows) - same as takeoff
            pressureAltitudes: [0, 1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000],
            // Temperatures (columns) - 0, 10, 20, 30, 40 degrees C
            temperatures: [0, 10, 20, 30, 40],
            // Ground roll distances (feet) - from POH landing data
            groundRoll: [
                [450, 465, 485, 515, 550],    // Sea level
                [480, 495, 520, 550, 585],    // 1000 ft
                [505, 525, 550, 585, 625],    // 2000 ft
                [535, 560, 590, 625, 670],    // 3000 ft
                [570, 595, 630, 670, 720],    // 4000 ft
                [605, 635, 675, 720, 775],    // 5000 ft
                [645, 680, 725, 775, 835],    // 6000 ft
                [690, 730, 780, 835, 900],    // 7000 ft
                [740, 785, 840, 900, 970]     // 8000 ft
            ],
            // 50ft obstacle clearance distances (feet) - from POH landing data
            obstacle50ft: [
                [1190, 1185, 1215, 1240, 1265], // Sea level
                [1185, 1215, 1250, 1270, 1295], // 1000 ft
                [1240, 1275, 1305, 1335, 1360], // 2000 ft
                [1275, 1325, 1355, 1370, 1400], // 3000 ft
                [1340, 1370, 1410, 1440, 1475], // 4000 ft
                [1375, 1410, 1445, 1480, 1515], // 5000 ft
                [1430, 1465, 1505, 1545, 1590], // 6000 ft
                [1490, 1530, 1575, 1620, 1670], // 7000 ft
                [1560, 1605, 1655, 1705, 1760]  // 8000 ft
            ]
        };

        // P2006T Landing Performance Data (from POH) - Weight-based tables
        const P2006T_LANDING_DATA = {
            // Weight categories (lbs)
            weights: [2051, 2381, 2844],
            
            // 2844 lbs weight category
            2844: {
                pressureAltitudes: [0, 1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000, 9000, 10000],
                temperatures: [-25, 0, 25, 50, 15], // ISA last column
                groundRoll: [
                    [708, 781, 853, 922, 823],    // Sea level
                    [735, 810, 882, 958, 846],    // 1000 ft
                    [761, 840, 915, 994, 872],    // 2000 ft
                    [790, 869, 951, 1030, 899],   // 3000 ft
                    [820, 902, 987, 1069, 928],   // 4000 ft
                    [853, 938, 1023, 1109, 954],  // 5000 ft
                    [886, 974, 1063, 1151, 984],  // 6000 ft
                    [918, 1010, 1105, 1197, 1017], // 7000 ft
                    [954, 1050, 1148, 1243, 1046], // 8000 ft
                    [991, 1092, 1191, 1292, 1079], // 9000 ft
                    [1030, 1135, 1240, 1342, 1115] // 10000 ft
                ],
                obstacle50ft: [
                    [1086, 1178, 1266, 1355, 1230], // Sea level
                    [1118, 1214, 1305, 1397, 1260], // 1000 ft
                    [1155, 1250, 1345, 1440, 1292], // 2000 ft
                    [1191, 1289, 1387, 1486, 1325], // 3000 ft
                    [1227, 1328, 1430, 1532, 1358], // 4000 ft
                    [1266, 1371, 1476, 1581, 1394], // 5000 ft
                    [1305, 1417, 1525, 1633, 1430], // 6000 ft
                    [1348, 1463, 1574, 1686, 1466], // 7000 ft
                    [1394, 1509, 1627, 1742, 1506], // 8000 ft
                    [1440, 1561, 1683, 1801, 1545], // 9000 ft
                    [1486, 1614, 1738, 1863, 1588]  // 10000 ft
                ]
            },
            
            // 2381 lbs weight category
            2381: {
                pressureAltitudes: [0, 1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000, 9000, 10000],
                temperatures: [-25, 0, 25, 50, 15], // ISA last column
                groundRoll: [
                    [574, 630, 689, 745, 666],    // Sea level
                    [594, 653, 715, 774, 686],    // 1000 ft
                    [617, 679, 741, 804, 705],    // 2000 ft
                    [640, 705, 768, 833, 728],    // 3000 ft
                    [663, 731, 797, 863, 748],    // 4000 ft
                    [689, 758, 827, 895, 771],    // 5000 ft
                    [715, 787, 859, 932, 797],    // 6000 ft
                    [741, 817, 892, 968, 820],    // 7000 ft
                    [771, 850, 928, 1004, 846],   // 8000 ft
                    [800, 882, 964, 1043, 872],   // 9000 ft
                    [833, 918, 1000, 1086, 902]   // 10000 ft
                ],
                obstacle50ft: [
                    [889, 961, 1033, 1105, 1004],  // Sea level
                    [915, 991, 1066, 1141, 1030],  // 1000 ft
                    [945, 1020, 1099, 1174, 1056], // 2000 ft
                    [1004, 1086, 1168, 1250, 1109], // 3000 ft
                    [1004, 1086, 1168, 1250, 1109], // 4000 ft (duplicate in data)
                    [1033, 1122, 1207, 1292, 1138], // 5000 ft
                    [1066, 1158, 1246, 1332, 1168], // 6000 ft
                    [1102, 1194, 1286, 1378, 1197], // 7000 ft
                    [1138, 1233, 1328, 1424, 1230], // 8000 ft
                    [1174, 1273, 1371, 1469, 1263], // 9000 ft
                    [1214, 1315, 1417, 1519, 1296]  // 10000 ft
                ]
            },
            
            // 2051 lbs weight category
            2051: {
                pressureAltitudes: [0, 1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000, 9000, 10000],
                temperatures: [-25, 0, 25, 50, 15], // ISA last column
                groundRoll: [
                    [492, 544, 594, 643, 574],    // Sea level
                    [512, 564, 613, 666, 590],    // 1000 ft
                    [531, 584, 636, 692, 607],    // 2000 ft
                    [551, 607, 663, 718, 626],    // 3000 ft
                    [571, 630, 686, 745, 646],    // 4000 ft
                    [594, 653, 712, 771, 666],    // 5000 ft
                    [617, 679, 741, 800, 686],    // 6000 ft
                    [640, 705, 768, 833, 705],    // 7000 ft
                    [666, 731, 797, 866, 728],    // 8000 ft
                    [689, 761, 830, 899, 751],    // 9000 ft
                    [718, 790, 863, 935, 777]     // 10000 ft
                ],
                obstacle50ft: [
                    [764, 827, 889, 951, 866],    // Sea level
                    [787, 853, 918, 981, 886],    // 1000 ft
                    [813, 879, 945, 1014, 909],   // 2000 ft
                    [863, 935, 1007, 1076, 954],  // 3000 ft
                    [863, 935, 1007, 1076, 954],  // 4000 ft (duplicate in data)
                    [892, 964, 1040, 1112, 981],  // 5000 ft
                    [918, 997, 1073, 1148, 1007], // 6000 ft
                    [948, 1027, 1109, 1184, 1033], // 7000 ft
                    [981, 1063, 1145, 1223, 1059], // 8000 ft
                    [1010, 1096, 1181, 1266, 1086], // 9000 ft
                    [1046, 1135, 1220, 1309, 1115]  // 10000 ft
                ]
            }
        };

// P2006T Single Engine Performance Data (from POH)
const P2006T_SE_PERFORMANCE = {
    // 1180 kg (2601 lb)
    '2601': {
        altitudes: [0, 1000, 2000, 3000, 4000, 5000, 6000, 7000],
        vyse: [80, 80, 80, 79, 79, 79, 79, 78],
        roc_m25: [362, 324, 285, 247, 209, 171, 132, 94],
        roc_0: [261, 224, 186, 148, 111, 74, 36, -1],
        roc_25: [171, 134, 97, 60, 24, -13, -49, -86],
        roc_50: [89, 53, 17, -19, -55, -91, -127, -163],
        roc_isa: [206, 176, 146, 116, 85, 55, 25, -5]
    },
    // 1080 kg (2381 lb)
    '2381': {
        altitudes: [0, 1000, 2000, 3000, 4000, 5000, 6000, 7000],
        vyse: [80, 80, 79, 79, 79, 79, 78, 78],
        roc_m25: [436, 396, 355, 315, 275, 234, 194, 154],
        roc_0: [330, 290, 251, 211, 172, 132, 93, 54],
        roc_25: [235, 196, 157, 118, 80, 41, 3, -35],
        roc_50: [149, 111, 73, 35, -3, -41, -78, -116],
        roc_isa: [271, 240, 208, 176, 145, 113, 81, 50]
    },
    // 930 kg (2050 lb)
    '2050': {
        altitudes: [0, 1000, 2000, 3000, 4000, 5000, 6000, 7000],
        vyse: [79, 79, 79, 78, 78, 78, 78, 77],
        roc_m25: [574, 529, 483, 438, 393, 348, 304, 259],
        roc_0: [455, 411, 367, 322, 278, 235, 191, 147],
        roc_25: [349, 305, 262, 219, 176, 133, 90, 47],
        roc_50: [253, 211, 168, 126, 83, 41, -1, -43],
        roc_isa: [390, 355, 319, 284, 248, 213, 178, 142]
    }
};

        // P2006T Takeoff Performance Data (from POH) - Weight-based tables
        const P2006T_TAKEOFF_DATA = {
            // Weight categories (lbs)
            weights: [2051, 2381, 2844],
            
            // 2844 lbs weight category
            2844: {
                pressureAltitudes: [0, 1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000, 9000, 10000],
                temperatures: [-25, 0, 25, 50, 15], // ISA last column
                groundRoll: [
                    [705, 899, 1118, 1368, 1027],    // Sea level
                    [787, 1004, 1246, 1525, 1125],   // 1000 ft
                    [879, 1118, 1394, 1706, 1237],   // 2000 ft
                    [984, 1253, 1558, 1906, 1358],   // 3000 ft
                    [1102, 1401, 1742, 2132, 1492],  // 4000 ft
                    [1233, 1568, 1952, 2388, 1643],  // 5000 ft
                    [1384, 1758, 2188, 2676, 1807],  // 6000 ft
                    [1581, 2011, 2503, 3064, 2034],  // 7000 ft
                    [1814, 2306, 2870, 3510, 2286],  // 8000 ft
                    [2076, 2640, 3287, 4021, 2572],  // 9000 ft
                    [2381, 3027, 3769, 4612, 2896]   // 10000 ft
                ],
                obstacle50ft: [
                    [971, 1237, 1538, 1883, 1368],   // Sea level
                    [1086, 1378, 1715, 2099, 1499],  // 1000 ft
                    [1210, 1542, 1919, 2345, 1647],  // 2000 ft
                    [1355, 1722, 2145, 2621, 1807],  // 3000 ft
                    [1515, 1925, 2398, 2932, 1988],  // 4000 ft
                    [1696, 2158, 2686, 3287, 2188],  // 5000 ft
                    [1902, 2417, 3011, 3683, 2408],  // 6000 ft
                    [2178, 2768, 3447, 4215, 2709],  // 7000 ft
                    [2496, 3172, 3946, 4828, 3047],  // 8000 ft
                    [2860, 3634, 4523, 5533, 3428],  // 9000 ft
                    [3277, 4169, 5189, 6344, 3861]   // 10000 ft
                ]
            },
            
            // 2381 lbs weight category
            2381: {
                pressureAltitudes: [0, 1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000, 9000, 10000],
                temperatures: [-25, 0, 25, 50, 15], // ISA last column
                groundRoll: [
                    [485, 617, 768, 938, 705],    // Sea level
                    [541, 689, 856, 1046, 771],   // 1000 ft
                    [604, 768, 954, 1168, 846],   // 2000 ft
                    [676, 859, 1069, 1305, 932],  // 3000 ft
                    [754, 961, 1194, 1463, 1023], // 4000 ft
                    [846, 1076, 1338, 1637, 1125], // 5000 ft
                    [948, 1207, 1499, 1834, 1240], // 6000 ft
                    [1063, 1351, 1683, 2060, 1368], // 7000 ft
                    [1194, 1519, 1893, 2312, 1509], // 8000 ft
                    [1345, 1709, 2125, 2601, 1666], // 9000 ft
                    [1512, 1922, 2394, 2929, 1840]  // 10000 ft
                ],
                obstacle50ft: [
                    [633, 807, 1004, 1227, 922],    // Sea level
                    [708, 899, 1118, 1371, 1010],   // 1000 ft
                    [790, 1004, 1250, 1528, 1109],  // 2000 ft
                    [987, 1256, 1565, 1912, 1342],  // 3000 ft
                    [987, 1256, 1565, 1912, 1342],  // 4000 ft (duplicate in data)
                    [1109, 1407, 1752, 2142, 1473], // 5000 ft
                    [1240, 1578, 1965, 2401, 1624], // 6000 ft
                    [1394, 1771, 2204, 2696, 1788], // 7000 ft
                    [1565, 1988, 2476, 3027, 1975], // 8000 ft
                    [1758, 2237, 2785, 3405, 2178], // 9000 ft
                    [1981, 2516, 3132, 3831, 2408]  // 10000 ft
                ]
            },
            
            // 2051 lbs weight category
            2051: {
                pressureAltitudes: [0, 1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000, 9000, 10000],
                temperatures: [-25, 0, 25, 50, 15], // ISA last column
                groundRoll: [
                    [328, 417, 518, 636, 479],    // Sea level
                    [367, 466, 581, 708, 525],    // 1000 ft
                    [410, 522, 646, 794, 574],    // 2000 ft
                    [459, 581, 725, 886, 630],    // 3000 ft
                    [512, 649, 810, 991, 695],    // 4000 ft
                    [574, 728, 909, 1109, 764],   // 5000 ft
                    [643, 817, 1017, 1243, 840],  // 6000 ft
                    [722, 918, 1141, 1397, 925],  // 7000 ft
                    [810, 1030, 1282, 1568, 1023], // 8000 ft
                    [912, 1158, 1443, 1765, 1128], // 9000 ft
                    [1027, 1302, 1624, 1984, 1246] // 10000 ft
                ],
                obstacle50ft: [
                    [430, 548, 679, 833, 623],    // Sea level
                    [479, 610, 758, 928, 686],    // 1000 ft
                    [535, 682, 846, 1036, 751],   // 2000 ft
                    [669, 853, 1059, 1296, 909],  // 3000 ft
                    [669, 853, 1059, 1296, 909],  // 4000 ft (duplicate in data)
                    [751, 954, 1187, 1453, 1000], // 5000 ft
                    [843, 1069, 1332, 1627, 1099], // 6000 ft
                    [945, 1200, 1492, 1827, 1214], // 7000 ft
                    [1059, 1348, 1679, 2053, 1338], // 8000 ft
                    [1194, 1515, 1886, 2309, 1476], // 9000 ft
                    [1342, 1706, 2125, 2598, 1633]  // 10000 ft
                ]
            }
        };

        function bilinearInterpolation(x, y, x1, x2, y1, y2, q11, q12, q21, q22) {
            // Bilinear interpolation formula
            const term1 = q11 * (x2 - x) * (y2 - y);
            const term2 = q21 * (x - x1) * (y2 - y);
            const term3 = q12 * (x2 - x) * (y - y1);
            const term4 = q22 * (x - x1) * (y - y1);
            
            return (term1 + term2 + term3 + term4) / ((x2 - x1) * (y2 - y1));
        }

        function calculatePerformance(temperature, pressureAltitude, dataTable) {
            const data = dataTable;
            
            // Find bounding indices for pressure altitude
            let altIndex1 = 0;
            for (let i = 0; i < data.pressureAltitudes.length - 1; i++) {
                if (pressureAltitude >= data.pressureAltitudes[i] && pressureAltitude <= data.pressureAltitudes[i + 1]) {
                    altIndex1 = i;
                    break;
                }
            }
            const altIndex2 = Math.min(altIndex1 + 1, data.pressureAltitudes.length - 1);
            
            // Find bounding indices for temperature
            let tempIndex1 = 0;
            for (let i = 0; i < data.temperatures.length - 1; i++) {
                if (temperature >= data.temperatures[i] && temperature <= data.temperatures[i + 1]) {
                    tempIndex1 = i;
                    break;
                }
            }
            const tempIndex2 = Math.min(tempIndex1 + 1, data.temperatures.length - 1);
            
            // Get corner values for ground roll
            const grQ11 = data.groundRoll[altIndex1][tempIndex1];
            const grQ12 = data.groundRoll[altIndex1][tempIndex2];
            const grQ21 = data.groundRoll[altIndex2][tempIndex1];
            const grQ22 = data.groundRoll[altIndex2][tempIndex2];
            
            // Get corner values for 50ft obstacle
            const obQ11 = data.obstacle50ft[altIndex1][tempIndex1];
            const obQ12 = data.obstacle50ft[altIndex1][tempIndex2];
            const obQ21 = data.obstacle50ft[altIndex2][tempIndex1];
            const obQ22 = data.obstacle50ft[altIndex2][tempIndex2];
            
            // Perform bilinear interpolation
            const groundRoll = bilinearInterpolation(
                temperature, pressureAltitude,
                data.temperatures[tempIndex1], data.temperatures[tempIndex2],
                data.pressureAltitudes[altIndex1], data.pressureAltitudes[altIndex2],
                grQ11, grQ12, grQ21, grQ22
            );
            
            const obstacle50ft = bilinearInterpolation(
                temperature, pressureAltitude,
                data.temperatures[tempIndex1], data.temperatures[tempIndex2],
                data.pressureAltitudes[altIndex1], data.pressureAltitudes[altIndex2],
                obQ11, obQ12, obQ21, obQ22
            );
            
            return {
                groundRoll: Math.round(groundRoll),
                obstacle50ft: Math.round(obstacle50ft)
            };
        }

        function calculateTakeoffPerformance(temperature, pressureAltitude) {
            return calculatePerformance(temperature, pressureAltitude, C152_TAKEOFF_DATA);
        }

        function calculateLandingPerformance(temperature, pressureAltitude) {
            return calculatePerformance(temperature, pressureAltitude, C152_LANDING_DATA);
        }

        function calculateP2006TLandingPerformance(temperature, pressureAltitude, weight) {
            // Find the appropriate weight category
            const weights = P2006T_LANDING_DATA.weights;
            let selectedWeight;
            
            if (weight <= weights[0]) {
                selectedWeight = weights[0]; // 2051 lbs
            } else if (weight <= weights[1]) {
                selectedWeight = weights[1]; // 2381 lbs
            } else {
                selectedWeight = weights[2]; // 2844 lbs
            }
            
            // Get the data table for the selected weight
            const dataTable = P2006T_LANDING_DATA[selectedWeight];
            
            const performance = calculatePerformance(temperature, pressureAltitude, dataTable);
            // Add the selected weight to the result
            performance.selectedWeight = selectedWeight;
            
            return performance;
        }

        function calculateP2006TTakeoffPerformance(temperature, pressureAltitude, weight) {
            // Find the appropriate weight category
            const weights = P2006T_TAKEOFF_DATA.weights;
            let selectedWeight;
            
            if (weight <= weights[0]) {
                selectedWeight = weights[0]; // 2051 lbs
            } else if (weight <= weights[1]) {
                selectedWeight = weights[1]; // 2381 lbs
            } else {
                selectedWeight = weights[2]; // 2844 lbs
            }
            
            // Get the data table for the selected weight
            const dataTable = P2006T_TAKEOFF_DATA[selectedWeight];
            
            const performance = calculatePerformance(temperature, pressureAltitude, dataTable);
            // Add the selected weight to the result
            performance.selectedWeight = selectedWeight;
            
            return performance;
        }

        function populateVSpeedsPanel(aircraftType) {
            const vSpeedItems = document.querySelectorAll('.airspeed-item');
            const specs = aircraftSpecs[aircraftType];

            if (specs && specs.vspeeds) {
                const vs = specs.vspeeds;
                const customVSpeeds = [
                    vs.vr ? `Vr - ${vs.vr}` : 'Vr',
                    vs.vxse ? `Vxse - ${vs.vxse}` : 'Vxse',
                    vs.vle ? `Vle - ${vs.vle}` : 'Vle',
                    vs.vg ? `Vg - ${vs.vg}` : 'Vg',
                    vs.vr50 ? `Vr 50' - ${vs.vr50}` : "Vr 50'",
                    vs.vyse ? `Vyse - ${vs.vyse}` : 'Vyse',
                    vs.vlo ? `Vlo - ${vs.vlo}` : 'Vlo',
                    vs.vmc ? `Vmc - ${vs.vmc}` : 'Vmc',
                    vs.vx ? `Vx - ${vs.vx}` : 'Vx',
                    vs.vs0 ? `Vs0 - ${vs.vs0}` : 'Vs0',
                    vs.va ? `Va - ${vs.va}` : 'Va',
                    vs.vappShort ? `Vapp Short - ${vs.vappShort}` : 'Vapp Short',
                    vs.vy ? `Vy - ${vs.vy}` : 'Vy',
                    vs.vs1 ? `Vs1 - ${vs.vs1}` : 'Vs1',
                    vs.vaMax ? `Va Max - ${vs.vaMax}` : 'Va Max',
                    vs.vappNormal ? `Vapp Normal - ${vs.vappNormal}` : 'Vapp Normal',
                    vs.cruise ? `Vcc - ${vs.cruise}` : 'Vcc',
                    vs.vfe ? `Vfe - ${vs.vfe}` : 'Vfe',
                    vs.vne ? `Vne - ${vs.vne}` : 'Vne',
                    vs.vappFlapless ? `Vapp Flapless - ${vs.vappFlapless}` : 'Vapp Flapless'
                ];

                vSpeedItems.forEach((item, index) => {
                    if (index < customVSpeeds.length) {
                        item.textContent = customVSpeeds[index];
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
                return;
            }
            
            if (aircraftType === 'C-152') {
                // C-152 specific V-speeds
                const c152VSpeeds = [
                    'Vr - 50', 'Vxse', 'Vle', 'Vg - 60',
                    'Vr 50\' - 50', 'Vyse', 'Vlo', 'Vmc',
                    'Vx - 55', 'Vs0 - 35', 'Va - 104', 'Vapp Short - 55',
                    'Vy - 67', 'Vs1 - 40', 'Va Max - 111', 'Vapp Normal - 60',
                    'Vcc - 80', 'Vfe - 85', 'Vne - 149', 'Vapp Flapless - 65-70'
                ];
                
                vSpeedItems.forEach((item, index) => {
                    if (index < c152VSpeeds.length) {
                        item.textContent = c152VSpeeds[index];
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            } else if (aircraftType === 'P2006T') {
                // P2006T specific V-speeds
                const p2006tVSpeeds = [
                    'Vr - 65', 'Vxse - 70', 'Vle - 122', 'Vg - 84',
                    'Vr 50\' - 65', 'Vyse - 84', 'Vlo - 122', 'Vmc - 62',
                    'Vx - 72', 'Vs0 - 53', 'Va Max - 118', 'Vapp Short - 70',
                    'Vy - 84', 'Vs1 - 66', 'Vno - 135', 'Vapp Normal - 75',
                    'Vcc - 95', 'Vfe - 122/93', 'Vne - 171', 'Vapp Flapless - 75'
                ];
                
                vSpeedItems.forEach((item, index) => {
                    if (index < p2006tVSpeeds.length) {
                        item.textContent = p2006tVSpeeds[index];
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            } else {
                // Generic V-speeds for other aircraft
                const genericVSpeeds = [
                    'Vr', 'Vxse', 'Vle', 'Vg',
                    'Vr 50\'', 'Vyse', 'Vlo', 'Vmc',
                    'Vx', 'Vs0', 'Va', 'Vapp Short',
                    'Vy', 'Vs1', 'Va Max', 'Vapp Normal',
                    'Vcc', 'Vfe', 'Vne', 'Vapp Flapless'
                ];
                
                vSpeedItems.forEach((item, index) => {
                    if (index < genericVSpeeds.length) {
                        item.textContent = genericVSpeeds[index];
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            }
        }
        
        function populateLimitsPanel(aircraftType, specs) {
            const limitsPanel = document.querySelector('.right-panel .panel-title');
            if (!limitsPanel || limitsPanel.textContent !== 'Limits') return;
            
            const infoItems = limitsPanel.parentElement.querySelectorAll('.info-item');
            
            infoItems.forEach(item => {
                const label = item.querySelector('.info-label').textContent;
                const valueSpan = item.querySelector('.info-value');
                
                switch(label) {
                    case 'Max T/O Weight':
                        valueSpan.textContent = (specs.maxTakeoffWeight || specs.maxWeight) ? (specs.maxTakeoffWeight || specs.maxWeight) + ' lbs' : '';
                        break;
                    case 'Max LDG Weight':
                        valueSpan.textContent = specs.maxLandingWeight ? specs.maxLandingWeight + ' lbs' : '';
                        break;
                    case 'Demo Crosswind':
                        valueSpan.textContent = (specs.demoCrosswind || specs.maxCrosswind) ? (specs.demoCrosswind || specs.maxCrosswind) + ' kt' : '';
                        break;
                }
            });
        }
        
        function calculateCGForwardLimit(weight, aircraftType) {
            if (!aircraftType || !aircraftSpecs[aircraftType]) {
                return null;
            }
            
            const specs = aircraftSpecs[aircraftType];
            
            // P2006T has fixed forward limit for all conditions
            if (aircraftType === 'P2006T') {
                return specs.forwardLimit; // Always 16.5
            }
            
            // For other aircraft, use the existing cgForwardLimits logic
            if (!specs.cgForwardLimits) {
                return null;
            }
            
            const limits = specs.cgForwardLimits;
            
            // Find the appropriate CG limit based on weight
            for (let i = 0; i < limits.length - 1; i++) {
                if (weight >= limits[i].weight && weight <= limits[i + 1].weight) {
                    // Linear interpolation between two points
                    const weightRange = limits[i + 1].weight - limits[i].weight;
                    const cgRange = limits[i + 1].cgLimit - limits[i].cgLimit;
                    const weightDiff = weight - limits[i].weight;
                    
                    return limits[i].cgLimit + (cgRange * weightDiff / weightRange);
                }
            }
            
            // If weight is below minimum, use first limit
            if (weight <= limits[0].weight) {
                return limits[0].cgLimit;
            }
            
            // If weight is above maximum, use last limit
            if (weight >= limits[limits.length - 1].weight) {
                return limits[limits.length - 1].cgLimit;
            }
            
            return null;
        }
        
        function updateTakeoffPerformance() {
            const aircraftType = document.getElementById('aircraftType').value;
            if (aircraftType !== 'C-152' && aircraftType !== 'P2006T') {
                // Clear performance data for unsupported aircraft
                document.querySelector('[data-field="takeoffGR"]').textContent = '';
                document.querySelector('[data-field="takeoffDist50"]').textContent = '';
                // Clear left panel fields
                document.getElementById('takeoffGR').value = '';
                document.getElementById('fiftyFtObst').value = '';
                return;
            }

            // Get temperature and pressure altitude from weather inputs
            const temperature = parseFloat(document.getElementById('temperature').value) || 15; // Default to 15¬∞C
            const pressureAltitude = parseFloat(document.getElementById('pressureAltitude').value) || 0; // Default to sea level

            // Calculate base takeoff performance based on aircraft type
            let performance;
            let currentWeight = 0;
            if (aircraftType === 'C-152') {
                performance = calculateTakeoffPerformance(temperature, pressureAltitude);
                currentWeight = 1670; // Typical C-152 weight
            } else if (aircraftType === 'P2006T') {
                // Get current aircraft weight for P2006T weight-based performance
                const takeoffWeightElement = document.querySelector('.data-table tbody tr:nth-child(10) td:nth-child(2)');
                currentWeight = parseFloat(takeoffWeightElement?.textContent) || 2844;
                // P2006T data is in Celsius, no conversion needed
                performance = calculateP2006TTakeoffPerformance(temperature, pressureAltitude, currentWeight);
            }
            
            // Apply headwind correction based on aircraft type
            const headwind = parseFloat(document.getElementById('headwind').value) || 0;
            let correctedGroundRoll, correctedObstacle50ft;
            let correctionFormula = '';
            
            if (aircraftType === 'C-152') {
                // C-152: decrease distances 10% for each 9 knots headwind
                const headwindCorrection = 1 - (headwind / 9) * 0.1;
                const correctionFactor = Math.max(headwindCorrection, 0.5); // Safety minimum
                correctedGroundRoll = Math.round(performance.groundRoll * correctionFactor);
                correctedObstacle50ft = Math.round(performance.obstacle50ft * correctionFactor);
                correctionFormula = `Base √ó ${correctionFactor.toFixed(3)} (${headwind} kts headwind)`;
            } else if (aircraftType === 'P2006T') {
                // P2006T: decrease distances 8ft per knot of headwind
                correctedGroundRoll = Math.max(performance.groundRoll - (headwind * 8), performance.groundRoll * 0.5);
                correctedObstacle50ft = Math.max(performance.obstacle50ft - (headwind * 8), performance.obstacle50ft * 0.5);
                correctedGroundRoll = Math.round(correctedGroundRoll);
                correctedObstacle50ft = Math.round(correctedObstacle50ft);
                correctionFormula = `Base - (${headwind} √ó 8) ft`;
            }
            
            // Store calculation details for tooltips
            calculationDetails.takeoff = {
                baseDistance: performance.groundRoll,
                headwind: headwind,
                correction: correctionFormula,
                temperature: temperature,
                pressureAltitude: pressureAltitude,
                weight: currentWeight,
                interpolationNote: performance.selectedWeight ? `Weight category: ${performance.selectedWeight} lbs` : 'Standard interpolation'
            };
            
            // Update display fields
            if (aircraftType === 'P2006T' && performance.selectedWeight) {
                document.querySelector('[data-field="takeoffGR"]').textContent = `${correctedGroundRoll} ft (${performance.selectedWeight} lbs)`;
                document.querySelector('[data-field="takeoffDist50"]').textContent = `${correctedObstacle50ft} ft (${performance.selectedWeight} lbs)`;
            } else {
                document.querySelector('[data-field="takeoffGR"]').textContent = `${correctedGroundRoll} ft`;
                document.querySelector('[data-field="takeoffDist50"]').textContent = `${correctedObstacle50ft} ft`;
            }
            
            // Update left panel input fields
            document.getElementById('takeoffGR').value = correctedGroundRoll;
            document.getElementById('fiftyFtObst').value = correctedObstacle50ft;
            
            // Update P2006T specific performance
            updatePerformanceCalculations();
            
            // Update tooltips with actual values
            updateTooltipContent();
        }

        function updateLandingPerformance() {
            const aircraftType = document.getElementById('aircraftType').value;
            if (aircraftType !== 'C-152' && aircraftType !== 'P2006T') {
                // Clear performance data for unsupported aircraft
                document.querySelector('[data-field="landingGR"]').textContent = '';
                document.querySelector('[data-field="landingDist50"]').textContent = '';
                // Clear left panel fields
                document.getElementById('landingGR').value = '';
                document.getElementById('landingDist50').value = '';
                return;
            }

            // Get temperature and pressure altitude from weather inputs
            const temperature = parseFloat(document.getElementById('temperature').value) || 15; // Default to 15¬∞C (59¬∞F)
            const pressureAltitude = parseFloat(document.getElementById('pressureAltitude').value) || 0; // Default to sea level

            // Calculate base landing performance based on aircraft type
            let performance;
            let currentWeight = 0;
            if (aircraftType === 'C-152') {
                performance = calculateLandingPerformance(temperature, pressureAltitude);
                currentWeight = 1670; // Typical C-152 weight
            } else if (aircraftType === 'P2006T') {
                // Get estimated landing weight for P2006T weight-based landing performance
                const landingWeightElement = document.querySelector('.data-table tbody tr:nth-child(12) td:nth-child(2)');
                currentWeight = parseFloat(landingWeightElement?.textContent) || 2844;
                // P2006T data is now in Celsius, no conversion needed
                performance = calculateP2006TLandingPerformance(temperature, pressureAltitude, currentWeight);
            }
            
            // Apply headwind correction based on aircraft type
            const headwind = parseFloat(document.getElementById('headwind').value) || 0;
            let correctedGroundRoll, correctedObstacle50ft;
            let correctionFormula = '';
            
            if (aircraftType === 'C-152') {
                // C-152: increase distances 10% for each 9 knots headwind
                const headwindCorrection = 1 + (headwind / 9) * 0.1;
                correctedGroundRoll = Math.round(performance.groundRoll * headwindCorrection);
                correctedObstacle50ft = Math.round(performance.obstacle50ft * headwindCorrection);
                correctionFormula = `Base √ó ${headwindCorrection.toFixed(3)} (${headwind} kts headwind)`;
            } else if (aircraftType === 'P2006T') {
                // P2006T: increase distances 8ft per knot of headwind
                correctedGroundRoll = performance.groundRoll + (headwind * 8);
                correctedObstacle50ft = performance.obstacle50ft + (headwind * 8);
                correctedGroundRoll = Math.round(correctedGroundRoll);
                correctedObstacle50ft = Math.round(correctedObstacle50ft);
                correctionFormula = `Base + (${headwind} √ó 8) ft`;
            }
            
            // Store calculation details for tooltips
            calculationDetails.landing = {
                baseDistance: performance.groundRoll,
                headwind: headwind,
                correction: correctionFormula,
                temperature: temperature,
                pressureAltitude: pressureAltitude,
                weight: currentWeight,
                interpolationNote: performance.selectedWeight ? `Weight category: ${performance.selectedWeight} lbs` : 'Standard interpolation'
            };
            
            // Update display fields
            if (aircraftType === 'P2006T' && performance.selectedWeight) {
                document.querySelector('[data-field="landingGR"]').textContent = `${correctedGroundRoll} ft (${performance.selectedWeight} lbs)`;
                document.querySelector('[data-field="landingDist50"]').textContent = `${correctedObstacle50ft} ft (${performance.selectedWeight} lbs)`;
            } else {
                document.querySelector('[data-field="landingGR"]').textContent = `${correctedGroundRoll} ft`;
                document.querySelector('[data-field="landingDist50"]').textContent = `${correctedObstacle50ft} ft`;
            }
            
            // Update left panel input fields
            document.getElementById('landingGR').value = correctedGroundRoll;
            document.getElementById('landingDist50').value = correctedObstacle50ft;
            
            // Update P2006T specific performance
            updatePerformanceCalculations();
            
            // Update tooltips with actual values
            updateTooltipContent();
        }

        function updateP2006TPerformance() {
            const aircraftType = document.getElementById('aircraftType').value;
            if (aircraftType !== 'P2006T') return;
            
            // Show/hide P2006T specific performance section
            const p2006tSection = document.getElementById('p2006t-performance');
            if (p2006tSection) {
                p2006tSection.style.display = 'block';
            }
            
            // Get current performance data
            const takeoffGR = parseFloat(document.getElementById('takeoffGR').value) || 0;
            const landingGR = parseFloat(document.getElementById('landingGR').value) || 0;
            
            // Calculate Accelerate/Stop Distance
            const accelerateStopDist = Math.abs(takeoffGR - landingGR);
            document.querySelector('[data-field="accelerateStopDist"]').textContent = `${accelerateStopDist} ft`;
            
            // Get current weight for SE performance calculations
            const currentWeightElement = document.querySelector('.data-table tbody tr:nth-child(10) td:nth-child(2)');
            const currentWeight = parseFloat(currentWeightElement?.textContent) || 2381;
            
            // Get temperature and pressure altitude for SE performance
            const temperature = parseFloat(document.getElementById('temperature').value) || 15;
            const pressureAltitude = parseFloat(document.getElementById('pressureAltitude').value) || 0;
            
            // Calculate SE Service Ceiling and Climb Rate
            const sePerformance = calculateP2006TSEPerformance(currentWeight, temperature, pressureAltitude);
            
            // Determine temperature column for tooltip
            let tempColumn = 'ISA';
            if (temperature <= -25) tempColumn = '-25¬∞C';
            else if (temperature <= 0) tempColumn = '0¬∞C';
            else if (temperature <= 25) tempColumn = '25¬∞C';
            else if (temperature <= 50) tempColumn = '50¬∞C';
            
            // Determine weight category for tooltip
            const weightCategories = [2050, 2381, 2601];
            let closestWeight = weightCategories[0];
            let minDiff = Math.abs(currentWeight - closestWeight);
            for (const catWeight of weightCategories) {
                const diff = Math.abs(currentWeight - catWeight);
                if (diff < minDiff) {
                    minDiff = diff;
                    closestWeight = catWeight;
                }
            }
            
            // Store P2006T calculation details for tooltips
            calculationDetails.p2006t = {
                takeoffGR: takeoffGR,
                landingGR: landingGR,
                accelerateStop: accelerateStopDist,
                weight: currentWeight,
                weightCategory: closestWeight,
                temperature: temperature,
                tempColumn: tempColumn,
                pressureAltitude: pressureAltitude,
                serviceCeiling: sePerformance.serviceCeiling,
                climbRate: sePerformance.climbRate
            };
            
            if (sePerformance.serviceCeiling) {
                document.querySelector('[data-field="seServiceCeiling"]').textContent = `${sePerformance.serviceCeiling} ft`;
            } else {
                document.querySelector('[data-field="seServiceCeiling"]').textContent = 'N/A';
            }
            
            if (sePerformance.climbRate) {
                document.querySelector('[data-field="seClimbRate"]').textContent = `${sePerformance.climbRate} fpm`;
            } else {
                document.querySelector('[data-field="seClimbRate"]').textContent = 'N/A';
            }
            
            // Update tooltips with actual values
            updateTooltipContent();
        }

        function calculateP2006TSEPerformance(weight, temperature, pressureAltitude) {
            // Find the closest weight category
            const weightCategories = [2050, 2381, 2601];
            let closestWeight = weightCategories[0];
            let minDiff = Math.abs(weight - closestWeight);
            
            for (const catWeight of weightCategories) {
                const diff = Math.abs(weight - catWeight);
                if (diff < minDiff) {
                    minDiff = diff;
                    closestWeight = catWeight;
                }
            }
            
            const performanceData = P2006T_SE_PERFORMANCE[closestWeight.toString()];
            if (!performanceData) return { serviceCeiling: null, climbRate: null };
            
            // Find the closest temperature column
            let tempColumn = 'roc_isa'; // Default to ISA
            if (temperature <= -25) tempColumn = 'roc_m25';
            else if (temperature <= 0) tempColumn = 'roc_0';
            else if (temperature <= 25) tempColumn = 'roc_25';
            else if (temperature <= 50) tempColumn = 'roc_50';
            
            // Calculate service ceiling (altitude where ROC = 50 fpm)
            let serviceCeiling = null;
            const rocData = performanceData[tempColumn];
            
            for (let i = 0; i < performanceData.altitudes.length - 1; i++) {
                if (rocData[i] > 50 && rocData[i + 1] <= 50) {
                    // Interpolate between these two points
                    const alt1 = performanceData.altitudes[i];
                    const alt2 = performanceData.altitudes[i + 1];
                    const roc1 = rocData[i];
                    const roc2 = rocData[i + 1];
                    
                    const ratio = (roc1 - 50) / (roc1 - roc2);
                    serviceCeiling = Math.round(alt1 + ratio * (alt2 - alt1));
                    break;
                }
            }
            
            // Calculate climb rate at current pressure altitude
            let climbRate = null;
            for (let i = 0; i < performanceData.altitudes.length; i++) {
                if (performanceData.altitudes[i] >= pressureAltitude) {
                    if (i === 0) {
                        climbRate = rocData[i];
                    } else {
                        // Interpolate between two altitude points
                        const alt1 = performanceData.altitudes[i - 1];
                        const alt2 = performanceData.altitudes[i];
                        const roc1 = rocData[i - 1];
                        const roc2 = rocData[i];
                        
                        const ratio = (pressureAltitude - alt1) / (alt2 - alt1);
                        climbRate = Math.round(roc1 + ratio * (roc2 - roc1));
                    }
                    break;
                }
            }
            
            return {
                serviceCeiling: serviceCeiling,
                climbRate: climbRate
            };
        }

        // Store calculation details for tooltips
        let calculationDetails = {
            takeoff: {},
            landing: {},
            p2006t: {}
        };

        function updateTooltipContent() {
            // Update takeoff ground roll tooltip
            const takeoffTooltip = document.querySelector('[data-field="takeoffGR"]').parentElement.querySelector('.tooltip-content');
            if (takeoffTooltip && calculationDetails.takeoff) {
                takeoffTooltip.innerHTML = `
                    <div class="tooltip-title">Takeoff Ground Roll Calculation</div>
                    <div class="tooltip-formula">Base: ${calculationDetails.takeoff.baseDistance || 'N/A'} ft</div>
                    <div class="tooltip-formula">Headwind: ${calculationDetails.takeoff.headwind || 0} kts</div>
                    <div class="tooltip-formula">Correction: ${calculationDetails.takeoff.correction || 'N/A'}</div>
                    <div class="tooltip-formula">Temperature: ${calculationDetails.takeoff.temperature || 'N/A'}¬∞C</div>
                    <div class="tooltip-formula">Pressure Alt: ${calculationDetails.takeoff.pressureAltitude || 'N/A'} ft</div>
                    <div class="tooltip-formula">Weight: ${calculationDetails.takeoff.weight || 'N/A'} lbs</div>
                    <div class="tooltip-note">Interpolated from POH data. ${calculationDetails.takeoff.interpolationNote || ''}</div>
                `;
            }

            // Update landing ground roll tooltip
            const landingTooltip = document.querySelector('[data-field="landingGR"]').parentElement.querySelector('.tooltip-content');
            if (landingTooltip && calculationDetails.landing) {
                landingTooltip.innerHTML = `
                    <div class="tooltip-title">Landing Ground Roll Calculation</div>
                    <div class="tooltip-formula">Base: ${calculationDetails.landing.baseDistance || 'N/A'} ft</div>
                    <div class="tooltip-formula">Headwind: ${calculationDetails.landing.headwind || 0} kts</div>
                    <div class="tooltip-formula">Correction: ${calculationDetails.landing.correction || 'N/A'}</div>
                    <div class="tooltip-formula">Temperature: ${calculationDetails.landing.temperature || 'N/A'}¬∞C</div>
                    <div class="tooltip-formula">Pressure Alt: ${calculationDetails.landing.pressureAltitude || 'N/A'} ft</div>
                    <div class="tooltip-formula">Weight: ${calculationDetails.landing.weight || 'N/A'} lbs</div>
                    <div class="tooltip-note">Interpolated from POH data. ${calculationDetails.landing.interpolationNote || ''}</div>
                `;
            }

            // Update P2006T specific tooltips
            if (calculationDetails.p2006t) {
                const accelStopTooltip = document.querySelector('[data-field="accelerateStopDist"]').parentElement.querySelector('.tooltip-content');
                if (accelStopTooltip) {
                    accelStopTooltip.innerHTML = `
                        <div class="tooltip-title">Accelerate/Stop Distance Calculation</div>
                        <div class="tooltip-formula">|${calculationDetails.p2006t.takeoffGR || 0} - ${calculationDetails.p2006t.landingGR || 0}| = ${calculationDetails.p2006t.accelerateStop || 0} ft</div>
                        <div class="tooltip-formula">Takeoff GR: ${calculationDetails.p2006t.takeoffGR || 0} ft</div>
                        <div class="tooltip-formula">Landing GR: ${calculationDetails.p2006t.landingGR || 0} ft</div>
                        <div class="tooltip-note">Absolute difference between takeoff and landing ground roll.</div>
                    `;
                }

                const seCeilingTooltip = document.querySelector('[data-field="seServiceCeiling"]').parentElement.querySelector('.tooltip-content');
                if (seCeilingTooltip) {
                    seCeilingTooltip.innerHTML = `
                        <div class="tooltip-title">Single-Engine Service Ceiling</div>
                        <div class="tooltip-formula">Weight: ${calculationDetails.p2006t.weight || 'N/A'} lbs (closest to ${calculationDetails.p2006t.weightCategory || 'N/A'} lbs)</div>
                        <div class="tooltip-formula">Temperature: ${calculationDetails.p2006t.temperature || 'N/A'}¬∞C ‚Üí ${calculationDetails.p2006t.tempColumn || 'N/A'} column</div>
                        <div class="tooltip-formula">Service Ceiling: ${calculationDetails.p2006t.serviceCeiling || 'N/A'} ft</div>
                        <div class="tooltip-note">Altitude where ROC = 50 fpm. Interpolated from P2006T SE performance tables.</div>
                    `;
                }

                const seClimbTooltip = document.querySelector('[data-field="seClimbRate"]').parentElement.querySelector('.tooltip-content');
                if (seClimbTooltip) {
                    seClimbTooltip.innerHTML = `
                        <div class="tooltip-title">Single-Engine Rate of Climb</div>
                        <div class="tooltip-formula">Weight: ${calculationDetails.p2006t.weight || 'N/A'} lbs ‚Üí ${calculationDetails.p2006t.weightCategory || 'N/A'} lbs category</div>
                        <div class="tooltip-formula">Temperature: ${calculationDetails.p2006t.temperature || 'N/A'}¬∞C ‚Üí ${calculationDetails.p2006t.tempColumn || 'N/A'} column</div>
                        <div class="tooltip-formula">Pressure Alt: ${calculationDetails.p2006t.pressureAltitude || 'N/A'} ft</div>
                        <div class="tooltip-formula">Climb Rate: ${calculationDetails.p2006t.climbRate || 'N/A'} fpm</div>
                        <div class="tooltip-note">Linear interpolation between table data points.</div>
                    `;
                }
            }
        }

        function updatePerformanceCalculations() {
            const aircraftType = document.getElementById('aircraftType').value;
            
            // Hide P2006T specific performance section for other aircraft
            const p2006tSection = document.getElementById('p2006t-performance');
            if (p2006tSection) {
                if (aircraftType === 'P2006T') {
                    p2006tSection.style.display = 'block';
                } else {
                    p2006tSection.style.display = 'none';
                }
            }
            
            // Update P2006T specific performance if applicable
            if (aircraftType === 'P2006T') {
                updateP2006TPerformance();
            }
        }

        function updateCGLimitsDisplay() {
            const aircraftType = document.getElementById('aircraftType').value;
            if (!aircraftType || !aircraftSpecs[aircraftType]) return;
            
            const specs = aircraftSpecs[aircraftType];
            const limitsPanel = document.querySelector('.right-panel .panel-title');
            if (!limitsPanel || limitsPanel.textContent !== 'Limits') return;
            
            const infoItems = limitsPanel.parentElement.querySelectorAll('.info-item');
            
            // Get current weights
            const zeroFuelWeight = parseFloat(document.querySelector('.data-table tbody tr:nth-child(6) td:nth-child(2)').textContent) || 0;
            const takeoffWeight = parseFloat(document.querySelector('.data-table tbody tr:nth-child(10) td:nth-child(2)').textContent) || 0;
            const landingWeight = parseFloat(document.querySelector('.data-table tbody tr:nth-child(12) td:nth-child(2)').textContent) || 0;
            
            infoItems.forEach(item => {
                const label = item.querySelector('.info-label').textContent;
                const valueSpan = item.querySelector('.info-value');
                
                switch(label) {
                    case 'T/O CG fwd/aft':
                        if (takeoffWeight > 0) {
                            const fwdLimit = calculateCGForwardLimit(takeoffWeight, aircraftType);
                            valueSpan.textContent = fwdLimit ? fwdLimit.toFixed(2) + '/' + specs.aftLimit : '/' + specs.aftLimit;
                        }
                        break;
                    case 'LDG CG fwd/aft':
                        if (landingWeight > 0) {
                            const fwdLimit = calculateCGForwardLimit(landingWeight, aircraftType);
                            valueSpan.textContent = fwdLimit ? fwdLimit.toFixed(2) + '/' + specs.aftLimit : '/' + specs.aftLimit;
                        }
                        break;
                    case 'Zero Fuel CG fwd/aft':
                        if (zeroFuelWeight > 0) {
                            const fwdLimit = calculateCGForwardLimit(zeroFuelWeight, aircraftType);
                            valueSpan.textContent = fwdLimit ? fwdLimit.toFixed(2) + '/' + specs.aftLimit : '/' + specs.aftLimit;
                        }
                        break;
                }
            });
            
            // Update CG chart
            drawCGChart();
        }
        
        function drawCGChart() {
            // Draw on desktop canvas only (mobile uses same canvas now)
            const canvas = document.getElementById('cgChart');
            
            if (!canvas) {
                console.log('CG Chart canvas not found');
                return;
            }
            
            // Ensure canvas is visible and has dimensions
            if (canvas.offsetWidth === 0 || canvas.offsetHeight === 0) {
                console.log('CG Chart canvas has no dimensions, retrying...');
                setTimeout(() => drawCGChart(), 100);
                return;
            }
            
            drawCGChartOnCanvas(canvas);
        }
        
        function drawCGChartOnCanvas(canvas) {
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const aircraftType = document.getElementById('aircraftType').value;
            
            // Enable high DPI rendering for crisp lines
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            
            // Set actual canvas size in memory (scaled up for high DPI)
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            
            // Scale the drawing context so everything draws at the correct size
            ctx.scale(dpr, dpr);
            
            // Set canvas CSS size to maintain proper display size
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (aircraftType !== 'C-152' && aircraftType !== 'P2006T' && !aircraftType.startsWith('CUSTOM_')) {
                // Show message for other aircraft types
                ctx.fillStyle = '#cccccc';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('CG Chart available for C-152, P2006T, and Custom Aircraft only', canvas.width/2, canvas.height/2);
                return;
            }
            
            // Chart dimensions and scaling (use rect dimensions for proper scaling)
            const margin = 60; // Increased from 40 to give more space for labels
            const chartWidth = rect.width - 2 * margin;
            const chartHeight = rect.height - 2 * margin;
            
            // Set chart parameters based on aircraft type
            let cgMin, cgMax, weightMin, weightMax, cgUnit;
            
            if (aircraftType === 'C-152') {
                // C-152: CG range 30-37 inches, Weight range 1000-1800 lbs
                cgMin = 30; cgMax = 37;
                weightMin = 1000; weightMax = 1800;
                cgUnit = 'inches';
            } else if (aircraftType === 'P2006T') {
                // P2006T: MAC range 14-32%, Weight range 1653-2844 lbs
                cgMin = 14; cgMax = 32;
                weightMin = 1653; weightMax = 2844;
                cgUnit = '% MAC';
            } else if (aircraftType.startsWith('CUSTOM_')) {
                // Custom aircraft: Use custom axis ranges if available
                const specs = aircraftSpecs[aircraftType];
                cgUnit = 'CG';
                
                if (specs && specs.xAxisRange && specs.yAxisRange) {
                    // Parse custom axis ranges
                    const xValues = specs.xAxisRange.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v));
                    const yValues = specs.yAxisRange.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v));
                    
                    if (xValues.length > 0 && yValues.length > 0) {
                        // Use the actual range values but add some padding for better visualization
                        const xRange = Math.max(...xValues) - Math.min(...xValues);
                        const yRange = Math.max(...yValues) - Math.min(...yValues);
                        
                        cgMin = Math.min(...xValues) - (xRange * 0.1);
                        cgMax = Math.max(...xValues) + (xRange * 0.1);
                        weightMin = Math.min(...yValues) - (yRange * 0.1);
                        weightMax = Math.max(...yValues) + (yRange * 0.1);
                    } else {
                        // Fallback to default ranges
                        cgMin = 25; cgMax = 50;
                        weightMin = 1000; weightMax = 2000;
                    }
                } else {
                    // Default ranges for custom aircraft
                    cgMin = 25; cgMax = 50;
                    weightMin = 1000; weightMax = 2000;
                }
            }
            
            // Helper functions for coordinate conversion
            const cgToX = (cg) => margin + ((cg - cgMin) / (cgMax - cgMin)) * chartWidth;
            const weightToY = (weight) => margin + ((weightMax - weight) / (weightMax - weightMin)) * chartHeight;
            
            // Draw grid
            ctx.strokeStyle = '#404040';
            ctx.lineWidth = 0.3;
            
            // Set grid increments based on aircraft type
            let majorCGIncrement, minorCGIncrement, majorWeightIncrement, minorWeightIncrement;
            
            if (aircraftType === 'C-152') {
                majorCGIncrement = 1;     // Every 1 inch
                minorCGIncrement = 0.2;   // Every 0.2 inches
                majorWeightIncrement = 200; // Every 200 lbs
                minorWeightIncrement = 50;  // Every 50 lbs
            } else if (aircraftType === 'P2006T') {
                majorCGIncrement = 2;     // Every 2% MAC
                minorCGIncrement = 1;     // Every 1% MAC
                majorWeightIncrement = 200; // Every 200 lbs
                minorWeightIncrement = 50;  // Every 50 lbs
            } else if (aircraftType.startsWith('CUSTOM_')) {
                // Custom aircraft: Calculate reasonable increments based on range
                const cgRange = cgMax - cgMin;
                const weightRange = weightMax - weightMin;
                
                majorCGIncrement = Math.max(1, Math.round(cgRange / 10));
                minorCGIncrement = majorCGIncrement / 5;
                majorWeightIncrement = Math.max(50, Math.round(weightRange / 10 / 50) * 50);
                minorWeightIncrement = majorWeightIncrement / 4;
            }
            
            // Major vertical grid lines (CG)
            for (let cg = cgMin; cg <= cgMax; cg += majorCGIncrement) {
                const x = cgToX(cg);
                ctx.strokeStyle = '#505050';
                ctx.lineWidth = 0.5;
                ctx.beginPath();
                ctx.moveTo(x, margin);
                ctx.lineTo(x, canvas.height - margin);
                ctx.stroke();
            }
            
            // Minor vertical grid lines (CG)
            ctx.strokeStyle = '#303030';
            ctx.lineWidth = 0.2;
            for (let cg = cgMin; cg <= cgMax; cg += minorCGIncrement) {
                if (cg % majorCGIncrement !== 0) { // Skip major grid lines
                    const x = cgToX(cg);
                    ctx.beginPath();
                    ctx.moveTo(x, margin);
                    ctx.lineTo(x, canvas.height - margin);
                    ctx.stroke();
                }
            }
            
            // Major horizontal grid lines (Weight)
            for (let weight = weightMin; weight <= weightMax; weight += majorWeightIncrement) {
                const y = weightToY(weight);
                ctx.strokeStyle = '#505050';
                ctx.lineWidth = 0.5;
                ctx.beginPath();
                ctx.moveTo(margin, y);
                ctx.lineTo(canvas.width - margin, y);
                ctx.stroke();
            }
            
            // Minor horizontal grid lines (Weight)
            ctx.strokeStyle = '#303030';
            ctx.lineWidth = 0.2;
            for (let weight = weightMin; weight <= weightMax; weight += minorWeightIncrement) {
                if (weight % majorWeightIncrement !== 0) { // Skip major grid lines
                    const y = weightToY(weight);
                    ctx.beginPath();
                    ctx.moveTo(margin, y);
                    ctx.lineTo(canvas.width - margin, y);
                    ctx.stroke();
                }
            }
            
            // Draw CG envelope based on aircraft type
            ctx.strokeStyle = '#2196F3'; // Blue color to match reference
            ctx.lineWidth = 2; // Reduced from 3 to make lines thinner
            ctx.beginPath();
            
            if (aircraftType === 'C-152') {
                // C-152 CG envelope using correct POH data: 31,1000 31,1350 32.6,1670 36.5,1670 36.5,1000
                ctx.moveTo(cgToX(31.0), weightToY(1000));
                ctx.lineTo(cgToX(31.0), weightToY(1350));
                ctx.lineTo(cgToX(32.6), weightToY(1670));
                ctx.lineTo(cgToX(36.5), weightToY(1670));
                ctx.lineTo(cgToX(36.5), weightToY(1000));
                ctx.lineTo(cgToX(31.0), weightToY(1000));
                
                ctx.stroke();
                
                // Fill the envelope area with blue tint
                ctx.fillStyle = 'rgba(33, 150, 243, 0.1)';
                ctx.fill();
                
                // Draw STC envelope extension as dashed line
                // STC path: 32.6,1670 -> 33,1710 -> 35.4,1710 -> 36.5,1670
                ctx.strokeStyle = '#2196F3'; // Same blue color
                ctx.lineWidth = 1.5; // Reduced from 2 to make dashed line thinner
                ctx.setLineDash([8, 4]); // Dashed line pattern
                ctx.beginPath();
                
                ctx.moveTo(cgToX(32.6), weightToY(1670));
                ctx.lineTo(cgToX(33.0), weightToY(1710));
                ctx.lineTo(cgToX(35.4), weightToY(1710));
                ctx.lineTo(cgToX(36.5), weightToY(1670));
                
                ctx.stroke();
                ctx.setLineDash([]); // Reset to solid line
                
            } else if (aircraftType === 'P2006T') {
                // P2006T CG envelope based on the chart image
                // Forward limit: 16.5% MAC up to 2712 lb, then straight line to 19.5% MAC at 2844 lb
                // Aft limit: 31% MAC for all weights
                
                ctx.moveTo(cgToX(16.5), weightToY(1653)); // Bottom left (min weight, forward limit)
                ctx.lineTo(cgToX(16.5), weightToY(2712)); // Forward limit up to 2712 lb
                ctx.lineTo(cgToX(19.5), weightToY(2844)); // Forward limit at max weight
                ctx.lineTo(cgToX(31.0), weightToY(2844)); // Top right (max weight, aft limit)
                ctx.lineTo(cgToX(31.0), weightToY(1653)); // Bottom right (min weight, aft limit)
                ctx.lineTo(cgToX(16.5), weightToY(1653)); // Close the envelope
                
                ctx.stroke();
                
                // Fill the envelope area with blue tint
                ctx.fillStyle = 'rgba(33, 150, 243, 0.1)';
                ctx.fill();
                
                // Draw MTOW limit lines
                ctx.strokeStyle = '#FF5722'; // Orange/red color for MTOW lines
                ctx.lineWidth = 1.5; // Reduced from 2 to make MTOW lines thinner
                ctx.setLineDash([5, 3]); // Dashed line pattern
                
                // MTOW 2844 lb line (already at top of envelope)
                ctx.beginPath();
                ctx.moveTo(cgToX(cgMin), weightToY(2844));
                ctx.lineTo(cgToX(cgMax), weightToY(2844));
                ctx.stroke();
                
                // MTOW 2712 lb line
                ctx.beginPath();
                ctx.moveTo(cgToX(cgMin), weightToY(2712));
                ctx.lineTo(cgToX(cgMax), weightToY(2712));
                ctx.stroke();
                
                // MTOW 2601 lb line
                ctx.beginPath();
                ctx.moveTo(cgToX(cgMin), weightToY(2601));
                ctx.lineTo(cgToX(cgMax), weightToY(2601));
                ctx.stroke();
                
                ctx.setLineDash([]); // Reset to solid line
            } else if (aircraftType && aircraftType.startsWith('CUSTOM_')) {
                // Custom aircraft CG envelope
                const specs = aircraftSpecs[aircraftType];
                if (specs && specs.cgEnvelope && specs.cgEnvelope.length > 2) {
                    ctx.strokeStyle = '#4CAF50'; // Green color for custom aircraft
                    ctx.lineWidth = 2; // Reduced from 3 to make lines thinner
                    ctx.beginPath();
                    
                    // Draw the envelope by connecting all points
                    specs.cgEnvelope.forEach((point, index) => {
                        const x = cgToX(point.cg);
                        const y = weightToY(point.weight);
                        
                        if (index === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    });
                    
                    // Close the envelope by connecting back to the first point
                    if (specs.cgEnvelope.length > 0) {
                        const firstPoint = specs.cgEnvelope[0];
                        ctx.lineTo(cgToX(firstPoint.cg), weightToY(firstPoint.weight));
                    }
                    
                    ctx.stroke();
                    
                    // Fill the envelope area with green tint
                    ctx.fillStyle = 'rgba(76, 175, 80, 0.1)';
                    ctx.fill();
                }
            }
            
            // Draw axes labels
            ctx.fillStyle = '#cccccc';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            
            // X-axis labels (CG)
            for (let cg = cgMin; cg <= cgMax; cg += majorCGIncrement) {
                const x = cgToX(cg);
                ctx.fillText(cg.toString(), x, rect.height - 20); // Moved from -10 to -20 for more space
            }
            
            // Y-axis labels (Weight)
            ctx.textAlign = 'right';
            for (let weight = weightMin; weight <= weightMax; weight += majorWeightIncrement) {
                const y = weightToY(weight);
                ctx.fillText(weight.toString(), margin - 20, y + 4); // Moved from -10 to -20 for more space
            }
            
            // Add MTOW labels for P2006T
            if (aircraftType === 'P2006T') {
                ctx.fillStyle = '#FF5722'; // Orange/red color for MTOW labels
                ctx.font = '10px Arial';
                ctx.textAlign = 'left';
                
                // MTOW 2844 lb label
                ctx.fillText('MTOW/MLW-1290 kg / 2844 lb (MOD2006/416)', cgToX(cgMin) + 5, weightToY(2844) - 5);
                
                // MTOW 2712 lb label
                ctx.fillText('MTOW/MLW-1230 kg / 2712 lb (MOD2006/015)', cgToX(cgMin) + 5, weightToY(2712) - 5);
                
                // MTOW 2601 lb label
                ctx.fillText('MTOW/MLW-1180 kg / 2601 lb', cgToX(cgMin) + 5, weightToY(2601) - 5);
            }
            
            // Axis titles with aircraft-specific labels
            ctx.textAlign = 'center';
            ctx.font = '12px Arial';
            ctx.fillStyle = '#aaaaaa';
            
            const xAxisTitle = aircraftType === 'P2006T' ? 'Xc (% M.A.C.)' : 'Airplane C.G. Location-Inches Aft of Datum';
            ctx.fillText(xAxisTitle, rect.width/2, rect.height - 2);
            
            ctx.save();
            ctx.translate(8, rect.height/2);
            ctx.rotate(-Math.PI/2);
            const yAxisTitle = aircraftType === 'P2006T' ? 'Weight (lb)' : 'Loaded Airplane Weight-Pounds';
            ctx.fillText(yAxisTitle, 0, 0);
            ctx.restore();
            
            // Plot current aircraft positions
            plotCurrentPositions(ctx, cgToX, weightToY, rect, margin);
        }
        
        function extractMACPercentage(armText) {
            // Extract MAC percentage from text like "1.10 (25.1%)"
            const match = armText.match(/\((\d+\.?\d*)\%\)/);
            return match ? parseFloat(match[1]) : 0;
        }
        
        function plotCurrentPositions(ctx, cgToX, weightToY, rect, margin) {
            const aircraftType = document.getElementById('aircraftType').value;
            if (aircraftType !== 'C-152' && aircraftType !== 'P2006T') return;
            
            // Get current weights and CG values (ARM for C-152, MAC% for P2006T)
            const zeroFuelWeight = parseFloat(document.querySelector('.data-table tbody tr:nth-child(6) td:nth-child(2)').textContent) || 0;
            const takeoffWeight = parseFloat(document.querySelector('.data-table tbody tr:nth-child(10) td:nth-child(2)').textContent) || 0;
            const landingWeight = parseFloat(document.querySelector('.data-table tbody tr:nth-child(12) td:nth-child(2)').textContent) || 0;
            
            // Extract CG values based on aircraft type
            let zeroFuelCG, takeoffCG, landingCG;
            
            if (aircraftType === 'P2006T') {
                // For P2006T, extract MAC percentage from ARM cell text like "1.10 (25.1%)"
                const zeroFuelArmText = document.querySelector('.data-table tbody tr:nth-child(6) td:nth-child(3)').textContent || '';
                const takeoffArmText = document.querySelector('.data-table tbody tr:nth-child(10) td:nth-child(3)').textContent || '';
                const landingArmText = document.querySelector('.data-table tbody tr:nth-child(12) td:nth-child(3)').textContent || '';
                
                zeroFuelCG = extractMACPercentage(zeroFuelArmText);
                takeoffCG = extractMACPercentage(takeoffArmText);
                landingCG = extractMACPercentage(landingArmText);
            } else {
                // For C-152, use ARM values directly
                zeroFuelCG = parseFloat(document.querySelector('.data-table tbody tr:nth-child(6) td:nth-child(3)').textContent) || 0;
                takeoffCG = parseFloat(document.querySelector('.data-table tbody tr:nth-child(10) td:nth-child(3)').textContent) || 0;
                landingCG = parseFloat(document.querySelector('.data-table tbody tr:nth-child(12) td:nth-child(3)').textContent) || 0;
            }
            
            // Plot actual CG positions for Zero Fuel Weight, T/O Weight, and Est Landing Weight
            const plotPoint = (weight, cg, color, label) => {
                if (weight > 0 && cg > 0) {
                    const pointX = cgToX(cg);
                    const pointY = weightToY(weight);
                    
                    // Plot point
                    ctx.fillStyle = color;
                    ctx.beginPath();
                    ctx.arc(pointX, pointY, 6, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // Add white border
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    // For C-152, add dashed lines from CG points down to CG values
                    if (aircraftType === 'C-152') {
                        ctx.strokeStyle = color;
                        ctx.lineWidth = 1;
                        ctx.setLineDash([3, 3]); // Small dashed line pattern
                        ctx.beginPath();
                        ctx.moveTo(pointX, pointY + 6); // Start from bottom of point
                        ctx.lineTo(pointX, rect.height - margin + 10); // End just above the x-axis
                        ctx.stroke();
                        ctx.setLineDash([]); // Reset to solid line
                        
                        // Add label directly above the CG number on x-axis
                        ctx.fillStyle = color;
                        ctx.font = 'bold 10px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(label, pointX, rect.height - margin + 25); // Position above CG axis numbers
                    } else {
                        // For other aircraft, keep label near the point
                        ctx.fillStyle = color;
                        ctx.font = '10px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(label, pointX, pointY - 12);
                    }
                }
            };
            
            // Plot Zero Fuel Weight point
            if (zeroFuelWeight > 0 && zeroFuelCG > 0) {
                plotPoint(zeroFuelWeight, zeroFuelCG, '#4CAF50', 'ZFW'); // Green
            }
            
            // Plot T/O Weight point  
            if (takeoffWeight > 0 && takeoffCG > 0) {
                plotPoint(takeoffWeight, takeoffCG, '#FF9800', 'T/O'); // Orange
            }
            
            // Plot Est Landing Weight point
            if (landingWeight > 0 && landingCG > 0) {
                plotPoint(landingWeight, landingCG, '#9C27B0', 'LDG'); // Purple
            }
        }

        // Time calculator functionality
        function updateTimes() {
            const now = new Date();
            
            // Local time and date
            const localTime = now.toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            const localDate = now.toLocaleDateString('en-US', {
                month: '2-digit',
                day: '2-digit',
                year: 'numeric'
            });
            
            // UTC/Zulu time and date
            const zuluTime = now.toLocaleTimeString('en-US', { 
                timeZone: 'UTC',
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            const zuluDate = now.toLocaleDateString('en-US', {
                timeZone: 'UTC',
                month: '2-digit',
                day: '2-digit',
                year: 'numeric'
            });
            
            // Update displays - both desktop and mobile
            const localTimeEl = document.getElementById('localTime');
            const localTimeMobileEl = document.getElementById('localTime-mobile');
            const localDateEl = document.getElementById('localDate');
            const localDateMobileEl = document.getElementById('localDate-mobile');
            const zuluTimeEl = document.getElementById('zuluTime');
            const zuluTimeMobileEl = document.getElementById('zuluTime-mobile');
            const zuluDateEl = document.getElementById('zuluDate');
            const zuluDateMobileEl = document.getElementById('zuluDate-mobile');
            
            if (localTimeEl) localTimeEl.textContent = localTime;
            if (localTimeMobileEl) localTimeMobileEl.textContent = localTime;
            if (localDateEl) localDateEl.textContent = localDate;
            if (localDateMobileEl) localDateMobileEl.textContent = localDate;
            if (zuluTimeEl) zuluTimeEl.textContent = zuluTime + 'Z';
            if (zuluTimeMobileEl) zuluTimeMobileEl.textContent = zuluTime + 'Z';
            if (zuluDateEl) zuluDateEl.textContent = zuluDate;
            if (zuluDateMobileEl) zuluDateMobileEl.textContent = zuluDate;
        }

        // Update times immediately and then every second
        updateTimes();
        setInterval(updateTimes, 1000);

        // Function to update weight & balance calculations
        function updateWeightBalanceCalculations() {
            const aircraftType = document.getElementById('aircraftType').value;
            
            // Update Basic Empty Weight from left panel inputs (regardless of aircraft type)
            const weight = parseFloat(document.getElementById('weight').value) || 0;
            const arm = parseFloat(document.getElementById('arm').value) || 0;
            const moment = parseFloat(document.getElementById('moment').value) || 0;
            
            const basicEmptyWeightCell = document.querySelector('.data-table tbody tr:nth-child(1) td:nth-child(2)');
            const basicEmptyArmCell = document.querySelector('.data-table tbody tr:nth-child(1) td:nth-child(3)');
            const basicEmptyMomentCell = document.querySelector('.data-table tbody tr:nth-child(1) td:nth-child(4)');
            
            if (basicEmptyWeightCell) {
                basicEmptyWeightCell.textContent = weight || '';
                console.log('Set Basic Empty Weight to:', weight);
            }
            if (basicEmptyArmCell) {
                basicEmptyArmCell.textContent = arm || '';
                console.log('Set Basic Empty Arm to:', arm);
            }
            if (basicEmptyMomentCell) {
                basicEmptyMomentCell.textContent = moment || '';
                console.log('Set Basic Empty Moment to:', moment, 'Cell found:', !!basicEmptyMomentCell);
            }
            
            console.log('Setting Basic Empty Weight moment in table to:', moment);
            console.log('Moment input values - desktop:', document.getElementById('moment').value);
            
            // Calculate Front Seats weight (My Weight + Instructor Weight)
            const myWeight = parseFloat(document.getElementById('myWeight').value) || 0;
            const instructorWeight = parseFloat(document.getElementById('instructorWeight').value) || 0;
            const frontSeatWeight = myWeight + instructorWeight;
            
            const frontSeatWeightCell = document.querySelector('.data-table tbody tr:nth-child(2) td:nth-child(2)');
            if (frontSeatWeightCell) frontSeatWeightCell.textContent = frontSeatWeight || '';
            
            // Handle baggage weight calculations based on aircraft type
            const myBag = parseFloat(document.getElementById('myBag').value) || 0;
            const instructorBag = parseFloat(document.getElementById('instructorBag').value) || 0;
            const baggage1Input = parseFloat(document.getElementById('baggage1').value) || 0;
            const baggage2Input = parseFloat(document.getElementById('baggage2').value) || 0;
            
            if (aircraftType === 'P2006T') {
                // P2006T: My Bag + Instructor Bag go to rear seats, baggage inputs go to baggage compartments
                const rearSeatWeightCell = document.querySelector('.data-table tbody tr:nth-child(3) td:nth-child(2)'); // Rear Seats
                const baggage1WeightCell = document.querySelector('.data-table tbody tr:nth-child(4) td:nth-child(2)'); // Baggage 1
                const baggage2WeightCell = document.querySelector('.data-table tbody tr:nth-child(5) td:nth-child(2)'); // Baggage 2
                
                const rearSeatWeight = myBag + instructorBag;
                if (rearSeatWeightCell) rearSeatWeightCell.textContent = rearSeatWeight || '';
                if (baggage1WeightCell) baggage1WeightCell.textContent = baggage1Input || '';
                if (baggage2WeightCell) baggage2WeightCell.textContent = baggage2Input || '';
                
                console.log('P2006T baggage - Rear seats:', rearSeatWeight, 'Baggage 1:', baggage1Input, 'Baggage 2:', baggage2Input);
            } else if (aircraftType === 'C-152') {
                // C-152: My Bag + Instructor Bag + Baggage 1 input go to baggage 1 (no rear seats, no baggage 2)
                const baggage1WeightCell = document.querySelector('.data-table tbody tr:nth-child(4) td:nth-child(2)'); // Baggage 1
                const baggage1Weight = myBag + instructorBag + baggage1Input;
                if (baggage1WeightCell) baggage1WeightCell.textContent = baggage1Weight || '';
                
                console.log('C-152 baggage - Baggage 1 total:', baggage1Weight, '(My Bag:', myBag, '+ Instructor Bag:', instructorBag, '+ Baggage 1 input:', baggage1Input, ')');
            } else {
                // Other aircraft: Default behavior - My Bag + Instructor Bag go to baggage 1
                const baggage1WeightCell = document.querySelector('.data-table tbody tr:nth-child(4) td:nth-child(2)'); // Baggage 1
                const baggage1Weight = myBag + instructorBag + baggage1Input;
                if (baggage1WeightCell) baggage1WeightCell.textContent = baggage1Weight || '';
                
                const baggage2WeightCell = document.querySelector('.data-table tbody tr:nth-child(5) td:nth-child(2)'); // Baggage 2
                if (baggage2WeightCell) baggage2WeightCell.textContent = baggage2Input || '';
            }
            
            if (!aircraftType || !aircraftSpecs[aircraftType]) return;
            
            const specs = aircraftSpecs[aircraftType];
            const fuel = parseFloat(document.getElementById('fuel').value) || 0;
            const time = parseFloat(document.getElementById('time').value) || 0;
            
            // Calculate fuel weight - P2006T has dual tanks so multiply by 2
            let fuelWeight;
            if (aircraftType === 'P2006T') {
                fuelWeight = fuel * 2 * specs.fuelWeightMultiplier; // Dual tanks: fuel input x 2 x 6 lbs/gal
                console.log('P2006T fuel calculation:', fuel, 'gal x 2 tanks x', specs.fuelWeightMultiplier, 'lbs/gal =', fuelWeight, 'lbs');
            } else {
                fuelWeight = fuel * specs.fuelWeightMultiplier; // Single tank: fuel input x 6 lbs/gal
            }
            const fuelWeightCell = document.querySelector('.data-table tbody tr:nth-child(7) td:nth-child(2)'); // Fuel weight (row 7)
            if (fuelWeightCell) fuelWeightCell.textContent = fuelWeight || '';
            
            // Calculate estimated fuel burn - P2006T fuel burn rate is total for both tanks
            // Adding 25% safety margin: calculate base burn then add 25%
            console.log('Fuel burn calculation - Aircraft type:', aircraftType, 'Time:', time, 'Fuel burn rate:', specs.fuelBurnRate);
            let baseFuelBurn;
            if (aircraftType === 'P2006T') {
                baseFuelBurn = time * specs.fuelBurnRate * specs.fuelWeightMultiplier * -1; // Total burn rate for both tanks
                console.log('P2006T fuel burn calculation:', time, 'hrs x', specs.fuelBurnRate, 'gal/hr x', specs.fuelWeightMultiplier, 'lbs/gal x -1 =', baseFuelBurn, 'lbs');
            } else {
                baseFuelBurn = time * specs.fuelBurnRate * specs.fuelWeightMultiplier * -1; // Single tank
                console.log('Other aircraft fuel burn calculation:', time, 'hrs x', specs.fuelBurnRate, 'gal/hr x', specs.fuelWeightMultiplier, 'lbs/gal x -1 =', baseFuelBurn, 'lbs');
            }
            const estFuelBurn = baseFuelBurn + (baseFuelBurn * 0.25);
            console.log('Final fuel burn with 25% safety margin:', baseFuelBurn, '+ 25% =', estFuelBurn);
            const estFuelBurnCell = document.querySelector('.data-table tbody tr:nth-child(11) td:nth-child(2)'); // Est. Fuel Burn weight (row 11)
            if (estFuelBurnCell) estFuelBurnCell.textContent = Math.round(estFuelBurn) || '';
            
            // Calculate Zero Fuel Weight (sum of basic empty weight + front seats + baggage)
            const basicEmptyWeight = parseFloat(document.querySelector('.data-table tbody tr:nth-child(1) td:nth-child(2)').textContent) || 0;
            const frontSeatWeightFromTable = parseFloat(document.querySelector('.data-table tbody tr:nth-child(2) td:nth-child(2)').textContent) || 0;
            const rearSeatWeight = parseFloat(document.querySelector('.data-table tbody tr:nth-child(3) td:nth-child(2)').textContent) || 0;
            const baggage1WeightFromTable = parseFloat(document.querySelector('.data-table tbody tr:nth-child(4) td:nth-child(2)').textContent) || 0;
            
            const zeroFuelWeight = basicEmptyWeight + frontSeatWeightFromTable + rearSeatWeight + baggage1WeightFromTable;
            const zeroFuelWeightCell = document.querySelector('.data-table tbody tr:nth-child(6) td:nth-child(2)'); // Zero Fuel Weight (row 6)
            if (zeroFuelWeightCell && zeroFuelWeight > 0) {
                zeroFuelWeightCell.textContent = zeroFuelWeight;
            }
            
            // Calculate moments for individual rows first
            calculateMoments();
            
            // Small delay to ensure moments are calculated before reading them
            setTimeout(() => {
                // Calculate Zero Fuel Weight moment (sum of Basic Empty Weight + Front Seats + Baggage moments)
                // Use the moment from left panel input (flight school data) for Basic Empty Weight
                const basicEmptyMoment = parseFloat(document.getElementById('moment').value) || 0;
                const frontSeatMoment = parseFloat(document.querySelector('.data-table tbody tr:nth-child(2) td:nth-child(4)').textContent) || 0;
                const rearSeatMoment = parseFloat(document.querySelector('.data-table tbody tr:nth-child(3) td:nth-child(4)').textContent) || 0;
                const baggage1Moment = parseFloat(document.querySelector('.data-table tbody tr:nth-child(4) td:nth-child(4)').textContent) || 0;
                
                // Debug logging
                console.log('Basic Empty Moment:', basicEmptyMoment);
                console.log('Front Seat Moment:', frontSeatMoment);
                console.log('Rear Seat Moment:', rearSeatMoment);
                console.log('Baggage 1 Moment:', baggage1Moment);
                
                // Check if Ground Fuel Use is interfering
                const grndFuelUseMomentCheck = parseFloat(document.querySelector('.data-table tbody tr:nth-child(9) td:nth-child(4)').textContent) || 0;
                console.log('Ground Fuel Use Moment (should not be in ZFW calc):', grndFuelUseMomentCheck);
                
                // Calculate Zero Fuel Weight moment - include rear seats for P2006T, exclude for C-152
                let zeroFuelMomentCalculated;
                if (aircraftType === 'C-152') {
                    zeroFuelMomentCalculated = basicEmptyMoment + frontSeatMoment + baggage1Moment; // C-152: no rear seats
                    console.log('C-152 ZFW moment calculation:', basicEmptyMoment, '+', frontSeatMoment, '+', baggage1Moment, '=', zeroFuelMomentCalculated);
                } else {
                    zeroFuelMomentCalculated = basicEmptyMoment + frontSeatMoment + rearSeatMoment + baggage1Moment; // Include rear seats
                    console.log('P2006T ZFW moment calculation:', basicEmptyMoment, '+', frontSeatMoment, '+', rearSeatMoment, '+', baggage1Moment, '=', zeroFuelMomentCalculated);
                }
                console.log('Final Zero Fuel Moment Calculated:', zeroFuelMomentCalculated);
                
                const zeroFuelMomentCell = document.querySelector('.data-table tbody tr:nth-child(6) td:nth-child(4)'); // Zero Fuel Weight moment (row 6)
                if (zeroFuelMomentCell) {
                    zeroFuelMomentCell.textContent = zeroFuelMomentCalculated.toFixed(1);
                }
                
                // Calculate Zero Fuel Weight arm (moment / weight)
                const zeroFuelWeight = parseFloat(document.querySelector('.data-table tbody tr:nth-child(6) td:nth-child(2)').textContent) || 0;
                if (zeroFuelWeight > 0) {
                    const zeroFuelArm = zeroFuelMomentCalculated / zeroFuelWeight;
                    const zeroFuelArmCell = document.querySelector('.data-table tbody tr:nth-child(6) td:nth-child(3)'); // Zero Fuel Weight arm (row 6)
                    if (zeroFuelArmCell) {
                        if (aircraftType === 'P2006T' && specs.macConstant) {
                            const zeroFuelMAC = (zeroFuelArm / specs.macConstant) * 100;
                            zeroFuelArmCell.textContent = `${zeroFuelArm.toFixed(2)} (${zeroFuelMAC.toFixed(1)}%)`;
                            console.log(`Zero Fuel ARM with MAC: ${zeroFuelArm.toFixed(2)} (${zeroFuelMAC.toFixed(1)}%)`);
                        } else {
                            zeroFuelArmCell.textContent = zeroFuelArm.toFixed(2);
                        }
                    }
                }
                
                // Calculate Ramp Weight (Zero Fuel Weight + Fuel)
                const rampWeight = zeroFuelWeight + fuelWeight;
                const rampWeightCell = document.querySelector('.data-table tbody tr:nth-child(8) td:nth-child(2)'); // Ramp Weight (row 8)
                if (rampWeightCell && rampWeight > 0) {
                    rampWeightCell.textContent = rampWeight;
                }
                
                // Calculate Ramp Weight moment (Zero Fuel Weight moment + Fuel moment)
                const zeroFuelMomentFromTable = zeroFuelMomentCalculated; // Use our calculated value, not table value
                const fuelMoment = parseFloat(document.querySelector('.data-table tbody tr:nth-child(7) td:nth-child(4)').textContent) || 0;
                const rampMoment = zeroFuelMomentFromTable + fuelMoment;
                console.log('Ramp Weight moment calculation:', zeroFuelMomentFromTable, '+', fuelMoment, '=', rampMoment);
                const rampMomentCell = document.querySelector('.data-table tbody tr:nth-child(8) td:nth-child(4)'); // Ramp Weight moment (row 8)
                if (rampMomentCell && rampMoment !== 0) {
                    rampMomentCell.textContent = rampMoment.toFixed(1);
                }
                
                // Calculate Ramp Weight arm (moment / weight)
                if (rampWeight > 0 && rampMoment !== 0) {
                    const rampArm = rampMoment / rampWeight;
                    const rampArmCell = document.querySelector('.data-table tbody tr:nth-child(8) td:nth-child(3)'); // Ramp Weight arm (row 8)
                    if (rampArmCell) {
                        rampArmCell.textContent = rampArm.toFixed(2);
                    }
                }
                
                // Calculate T/O Weight (Ramp Weight + Grnd Fuel Use)
                const grndFuelUse = parseFloat(document.querySelector('.data-table tbody tr:nth-child(9) td:nth-child(2)').textContent) || 0;
                const takeoffWeight = rampWeight + grndFuelUse;
                const takeoffWeightCell = document.querySelector('.data-table tbody tr:nth-child(10) td:nth-child(2)'); // T/O Weight (row 10)
                if (takeoffWeightCell && takeoffWeight > 0) {
                    takeoffWeightCell.textContent = takeoffWeight;
                }
                
                // Calculate T/O Weight moment (Ramp Weight moment + Grnd Fuel Use moment)
                const grndFuelUseMoment = parseFloat(document.querySelector('.data-table tbody tr:nth-child(9) td:nth-child(4)').textContent) || 0;
                const takeoffMoment = rampMoment + grndFuelUseMoment;
                console.log('T/O Weight moment calculation:', rampMoment, '+', grndFuelUseMoment, '=', takeoffMoment);
                const takeoffMomentCell = document.querySelector('.data-table tbody tr:nth-child(10) td:nth-child(4)'); // T/O Weight moment (row 10)
                if (takeoffMomentCell && takeoffMoment !== 0) {
                    takeoffMomentCell.textContent = takeoffMoment.toFixed(1);
                }
                
                // Calculate T/O Weight arm (moment / weight)
                if (takeoffWeight > 0 && takeoffMoment !== 0) {
                    const takeoffArm = takeoffMoment / takeoffWeight;
                    const takeoffArmCell = document.querySelector('.data-table tbody tr:nth-child(10) td:nth-child(3)'); // T/O Weight arm (row 10)
                    if (takeoffArmCell) {
                        if (aircraftType === 'P2006T' && specs.macConstant) {
                            const takeoffMAC = (takeoffArm / specs.macConstant) * 100;
                            takeoffArmCell.textContent = `${takeoffArm.toFixed(2)} (${takeoffMAC.toFixed(1)}%)`;
                            console.log(`T/O ARM with MAC: ${takeoffArm.toFixed(2)} (${takeoffMAC.toFixed(1)}%)`);
                        } else {
                            takeoffArmCell.textContent = takeoffArm.toFixed(2);
                        }
                    }
                }
                
                // Calculate Est Landing Weight (T/O Weight + Est Fuel Burn)
                const estLandingWeight = takeoffWeight + estFuelBurn;
                const estLandingWeightCell = document.querySelector('.data-table tbody tr:nth-child(12) td:nth-child(2)'); // Est Landing Weight (row 12)
                if (estLandingWeightCell && estLandingWeight > 0) {
                    estLandingWeightCell.textContent = Math.round(estLandingWeight);
                }
                
                // Calculate Est Landing Weight moment (T/O Weight moment + Est Fuel Burn moment)
                const estFuelBurnMoment = parseFloat(document.querySelector('.data-table tbody tr:nth-child(11) td:nth-child(4)').textContent) || 0;
                const estLandingMoment = takeoffMoment + estFuelBurnMoment;
                const estLandingMomentCell = document.querySelector('.data-table tbody tr:nth-child(12) td:nth-child(4)'); // Est Landing Weight moment (row 12)
                if (estLandingMomentCell && estLandingMoment !== 0) {
                    estLandingMomentCell.textContent = estLandingMoment.toFixed(1);
                }
                
                // Calculate Est Landing Weight arm (moment / weight)
                if (estLandingWeight > 0 && estLandingMoment !== 0) {
                    const estLandingArm = estLandingMoment / estLandingWeight;
                    const estLandingArmCell = document.querySelector('.data-table tbody tr:nth-child(12) td:nth-child(3)'); // Est Landing Weight arm (row 12)
                    if (estLandingArmCell) {
                        if (aircraftType === 'P2006T' && specs.macConstant) {
                            const estLandingMAC = (estLandingArm / specs.macConstant) * 100;
                            estLandingArmCell.textContent = `${estLandingArm.toFixed(2)} (${estLandingMAC.toFixed(1)}%)`;
                            console.log(`Est Landing ARM with MAC: ${estLandingArm.toFixed(2)} (${estLandingMAC.toFixed(1)}%)`);
                        } else {
                            estLandingArmCell.textContent = estLandingArm.toFixed(2);
                        }
                    }
                }
                
                // Calculate moments for all rows
                calculateMoments();
                
                // Update CG limits display
                updateCGLimitsDisplay();
            }, 10);
            
            // Calculate moments for all rows
            calculateMoments();
            
            // MAC percentages are now displayed directly in ARM column for P2006T
        }
        
        
        function calculateMoments() {
            console.log('calculateMoments() called');
            const rows = document.querySelectorAll('.data-table tbody tr');
            rows.forEach((row, index) => {
                const weightCell = row.cells[1];
                const armCell = row.cells[2];
                const momentCell = row.cells[3];
                
                const weight = parseFloat(weightCell.textContent) || 0;
                const arm = parseFloat(armCell.textContent) || 0;
                
                console.log(`Row ${index}: weight=${weight}, arm=${arm}, weightText="${weightCell.textContent}", armText="${armCell.textContent}"`);
                
                // Skip Basic Empty Weight row (index 0) - use input from left panel
                // Skip Zero Fuel Weight row (index 5) - use custom calculation
                // Skip Ramp Weight row (index 7) - use custom calculation
                // Skip T/O Weight row (index 9) - use custom calculation
                // Skip Est Landing Weight row (index 11) - use custom calculation
                if (index === 0 || index === 5 || index === 7 || index === 9 || index === 11) {
                    console.log(`Skipping row ${index} (custom calculation)`);
                    return;
                }
                
                if (weight && arm) {
                    const moment = (weight * arm).toFixed(1);
                    momentCell.textContent = moment;
                    console.log(`Row ${index}: calculated moment = ${moment}`);
                } else {
                    console.log(`Row ${index}: skipped (weight=${weight}, arm=${arm})`);
                }
            });
        }

        // Function to update all displays based on input values
        function updateDisplays() {
            // Weather inputs to weather displays
            const weatherObs = document.getElementById('weatherObs').value;
            const windDirection = document.getElementById('windDirection').value;
            const windSpeed = document.getElementById('windSpeed').value;
            const visibility = document.getElementById('visibility').value;
            const weather = document.getElementById('weather').value;
            const temperature = document.getElementById('temperature').value;
            const dewpoint = document.getElementById('dewpoint').value;
            const altimeter = document.getElementById('altimeter').value;
            const fieldElevation = document.getElementById('fieldElevation').value;

            // Update weather displays
            if (weatherObs) {
                const wxObsElement = document.querySelector('[data-field="wxObs"]');
                if (wxObsElement) {
                    wxObsElement.textContent = weatherObs + 'Z';
                }
            }
            
            if (windDirection && windSpeed) {
                const windDirElement = document.querySelector('[data-field="windDirection"]');
                const windSpeedElement = document.querySelector('[data-field="windSpeed"]');
                if (windDirElement) {
                    windDirElement.textContent = `${windDirection}¬∞`;
                }
                if (windSpeedElement) {
                    windSpeedElement.textContent = `${windSpeed} kts`;
                }
            }
            
            if (visibility) {
                const visibilityElement = document.querySelector('[data-field="visibility"]');
                if (visibilityElement) {
                    visibilityElement.textContent = `${visibility} SM`;
                }
            }
            
            if (weather) {
                const weatherElement = document.querySelector('[data-field="weather"]');
                if (weatherElement) {
                    weatherElement.textContent = weather;
                }
            }
            
            if (temperature) {
                const temperatureElement = document.querySelector('[data-field="temperature"]');
                if (temperatureElement) {
                    temperatureElement.textContent = `${temperature}¬∞C`;
                }
            }
            
            if (dewpoint) {
                const dewpointElement = document.querySelector('[data-field="dewpoint"]');
                if (dewpointElement) {
                    dewpointElement.textContent = `${dewpoint}¬∞C`;
                }
            }
            
            if (altimeter) {
                const altimeterElement = document.querySelector('[data-field="altimeter"]');
                if (altimeterElement) {
                    altimeterElement.textContent = altimeter;
                }
            }
            
            if (fieldElevation) {
                const fieldElevationElement = document.querySelector('[data-field="airportElevation"]');
                if (fieldElevationElement) {
                    fieldElevationElement.textContent = fieldElevation + ' ft';
                }
            }

            // Calculate pressure altitude if we have altimeter and field elevation
            let pressureAlt = null;
            if (altimeter && fieldElevation) {
                pressureAlt = Math.round((29.92 - parseFloat(altimeter)) * 1000 + parseInt(fieldElevation));
                const pressureAltElement = document.querySelector('[data-field="pressureAltitude"]');
                if (pressureAltElement) {
                    pressureAltElement.textContent = pressureAlt + ' ft';
                }
                // Update left panel input
                const pressureAltInput = document.getElementById('pressureAltitude');
                if (pressureAltInput) {
                    pressureAltInput.value = pressureAlt;
                }
            }

            // Calculate density altitude if we have pressure altitude and temperature
            let densityAlt = null;
            if (altimeter && fieldElevation && temperature) {
                const pressureAltCalc = (29.92 - parseFloat(altimeter)) * 1000 + parseInt(fieldElevation);
                const standardTemp = 15 - (parseInt(fieldElevation) / 1000) * 2;
                densityAlt = Math.round(pressureAltCalc + (120 * (parseInt(temperature) - standardTemp)));
                const densityAltElement = document.querySelector('[data-field="densityAltitude"]');
                if (densityAltElement) {
                    densityAltElement.textContent = densityAlt + ' ft';
                }
                // Update left panel input
                const densityAltInput = document.getElementById('densityAltitude');
                if (densityAltInput) {
                    densityAltInput.value = densityAlt;
                }
            }

            // Auto-select runway heading based on wind direction
            let runwayHeadingInput = document.getElementById('runwayHeading').value;
            if (windDirection && !runwayHeadingInput) {
                // Default runway selection based on wind direction
                const windDir = parseInt(windDirection);
                if (windDir >= 315 || windDir < 45) {
                    // Wind from north (315-45¬∞) -> use runway 36
                    runwayHeadingInput = '36';
                    document.getElementById('runwayHeading').value = '36';
                } else if (windDir >= 135 && windDir < 225) {
                    // Wind from south (135-225¬∞) -> use runway 18
                    runwayHeadingInput = '18';
                    document.getElementById('runwayHeading').value = '18';
                } else {
                    // Default to runway 36 for other wind directions
                    runwayHeadingInput = '36';
                    document.getElementById('runwayHeading').value = '36';
                }
            }

            // Calculate crosswind and headwind if we have wind data and runway heading
            let headwind = null;
            let crosswind = null;
            
            if (windDirection && windSpeed && runwayHeadingInput) {
                // Extract numeric runway heading, ignoring L/R designations
                let runwayHeading;
                if (typeof runwayHeadingInput === 'string') {
                    // Handle runway designations like "18L", "36R", etc.
                    const numericPart = runwayHeadingInput.replace(/[LR]/gi, '');
                    runwayHeading = parseInt(numericPart) * 10; // Convert runway number to heading
                } else {
                    runwayHeading = parseInt(runwayHeadingInput);
                }
                
                const windAngleDiff = Math.abs(parseInt(windDirection) - runwayHeading);
                const adjustedAngleDiff = windAngleDiff > 180 ? 360 - windAngleDiff : windAngleDiff;
                
                headwind = Math.abs(parseInt(windSpeed) * Math.cos(adjustedAngleDiff * Math.PI / 180));
                crosswind = Math.abs(parseInt(windSpeed) * Math.sin(adjustedAngleDiff * Math.PI / 180));
                
                const headwindElement = document.querySelector('[data-field="headwind"]');
                if (headwindElement) {
                    headwindElement.textContent = headwind.toFixed(1) + ' kts';
                }
                
                const crosswindElement = document.querySelector('[data-field="crosswind"]');
                if (crosswindElement) {
                    crosswindElement.textContent = crosswind.toFixed(1) + ' kts';
                }
                
                // Update left panel inputs
                const headwindInput = document.getElementById('headwind');
                if (headwindInput) {
                    headwindInput.value = headwind.toFixed(1);
                }
                
                const crosswindInput = document.getElementById('crosswind');
                if (crosswindInput) {
                    crosswindInput.value = crosswind.toFixed(1);
                }
            }

            // Performance data
            const expectedRunway = document.getElementById('runwayHeading').value;
            const runwayLength = document.getElementById('runwayLength').value;
            const takeoffGR = document.getElementById('takeoffGR').value;
            const landingGR = document.getElementById('landingGR').value;
            const fiftyFtObst = document.getElementById('fiftyFtObst').value;

            if (expectedRunway) {
                const expectedRunwayElement = document.querySelector('[data-field="expectedRunway"]');
                if (expectedRunwayElement) {
                    expectedRunwayElement.textContent = expectedRunway;
                }
            }

            // Update takeoff and landing performance calculations for C-152
            updateTakeoffPerformance();
            updateLandingPerformance();

            // Maintenance data
            const hr50 = document.getElementById('hr50').value;
            const hr100 = document.getElementById('hr100').value;
            const ad1 = document.getElementById('ad1').value;
            const ad2 = document.getElementById('ad2').value;
            const annual = document.getElementById('annual').value;
            const regist = document.getElementById('regist').value;

            let timeToNextMx = '';
            if (hr50) timeToNextMx += `50Hr/${hr50} `;
            if (hr100) timeToNextMx += `100Hr/${hr100} `;
            if (ad1) timeToNextMx += `AD/${ad1}`;
            
            let daysToNextMx = '';
            if (ad2) daysToNextMx += `AD/${ad2} `;
            if (annual) daysToNextMx += `Annual/${annual} `;
            if (regist) daysToNextMx += `Regist/${regist}`;

            if (timeToNextMx) {
                document.querySelector('[data-field="timeToNextMx"]').textContent = timeToNextMx.trim();
            }
            if (daysToNextMx) {
                document.querySelector('[data-field="daysToNextMx"]').textContent = daysToNextMx.trim();
            }
            
            // Update CG chart if it's currently visible
            const cgContainer = document.getElementById('cgChartContainer');
            if (cgContainer && cgContainer.style.display !== 'none') {
                drawCGChartInLimitsPanel();
            }
        }

        // Consolidated initialization function
        function initializeApplication() {
            console.log('Initializing application...');
            
            // Initialize mobile interface
            initializeMobileInterface();
            
            // Initialize input field event listeners
            initializeInputFields();
            
            // Load saved custom aircraft into dropdown
            updateAircraftTypeDropdown();
            
            // Load saved data and trigger initial calculations
            loadPersistedData();
            
            // Initialize charts for both desktop and mobile
            setTimeout(() => {
                updateCGLimitsDisplay();
                drawCGChart();
                // Force chart redraw on window resize (mobile orientation changes)
                window.addEventListener('resize', () => {
                    setTimeout(updateCGLimitsDisplay, 100);
                });
            }, 200);
            
            console.log('Application initialization complete');
        }
        
        function initializeInputFields() {
            const inputFields = document.querySelectorAll('.input-field');
            console.log('Found input fields:', inputFields.length);
            
            // Add tail number specific event listener
            const tailNumberInput = document.getElementById('tailNumber');
            if (tailNumberInput) {
                tailNumberInput.addEventListener('input', function() {
                    const tailNumberInput = this.value;
                    const display = document.getElementById('tailNumberDisplay');
                    if (display) {
                        display.textContent = 'N' + tailNumberInput;
                    }
                });
                console.log('Tail number listener added');
            }
            
            // Convert NodeList to Array for easier manipulation
            const inputFieldsArray = Array.from(inputFields);
            
            inputFields.forEach((field, index) => {
                field.addEventListener('input', function() {
                    updateDisplays();
                    updateWeightBalanceCalculations();
                });
                
                // Add paste event listener to trigger calculations
                field.addEventListener('paste', function() {
                    // Use setTimeout to ensure pasted value is processed
                    setTimeout(() => {
                        updateDisplays();
                        updateWeightBalanceCalculations();
                    }, 10);
                });
                
                // Add Enter key navigation to move to next field
                field.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        const nextIndex = index + 1;
                        if (nextIndex < inputFieldsArray.length) {
                            inputFieldsArray[nextIndex].focus();
                        } else {
                            // If at the last field, go back to the first
                            inputFieldsArray[0].focus();
                        }
                    }
                });
            });
            
            // Add specific listeners for fuel and time inputs
            const fuelInput = document.getElementById('fuel');
            const timeInput = document.getElementById('time');
            
            if (fuelInput) {
                fuelInput.addEventListener('input', updateWeightBalanceCalculations);
                console.log('Fuel input listener added');
            } else {
                console.error('Fuel input not found');
            }
            
            if (timeInput) {
                timeInput.addEventListener('input', updateWeightBalanceCalculations);
                console.log('Time input listener added');
            } else {
                console.error('Time input not found');
            }
            
            // Add comprehensive listeners for all inputs that affect calculations
            const performanceInputs = [
                'temperature', 'pressureAltitude', 'headwind', 'crosswind',
                'windDirection', 'windSpeed', 'altimeter', 'fieldElevation',
                'runwayHeading', 'runwayLength'
            ];
            
            const weatherInputs = [
                'visibility', 'weather', 'temperature', 'dewpoint', 'altimeter',
                'fieldElevation', 'windDirection', 'windSpeed', 'runwayHeading'
            ];
            
            // Function to trigger all updates
            function triggerAllUpdates() {
                updateDisplays();
                updateTakeoffPerformance();
                updateLandingPerformance();
            }
            
            // Add listeners for performance-affecting inputs
            performanceInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', triggerAllUpdates);
                    input.addEventListener('change', triggerAllUpdates);
                    console.log(`Performance listener added for ${inputId}`);
                }
            });
            
            // Add listeners for weather inputs that trigger display updates
            weatherInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                
                if (input) {
                    input.addEventListener('input', triggerAllUpdates);
                    input.addEventListener('change', triggerAllUpdates);
                    console.log(`Weather listener added for ${inputId}`);
                }
            });
            
            // Mobile sync no longer needed - mobile uses same desktop elements
            
            // Initial update
            console.log('Running initial updates...');
            updateDisplays();
            updateWeightBalanceCalculations();
            
            console.log('Initialization complete');
            
            // Load user profile on page load
            loadUserProfile(true); // true = silent load (no status message)
            
            // Initialize aircraft management
            updateSavedAircraftDropdowns();
            updateTailNumberDropdowns();
            loadDefaultAircraft();
        }
        
        function initializeMobileInterface() {
            console.log('Initializing mobile interface...');
            
            // Ensure Data column is shown by default on mobile
            if (window.innerWidth <= 768) {
                console.log('Mobile detected, setting up default column...');
                
                const desktopLayout = document.querySelector('.desktop-layout');
                if (desktopLayout) {
                    // Remove any existing mobile classes
                    desktopLayout.classList.remove('mobile-show-left', 'mobile-show-right', 'mobile-show-risk', 'mobile-show-settings');
                    // Set to show Data column (left panel) by default
                    desktopLayout.classList.add('mobile-show-left');
                    console.log('Set mobile to show Data column by default');
                }
                
                // Set Data nav button as active
                const navButtons = document.querySelectorAll('.mobile-nav-btn');
                navButtons.forEach(button => {
                    button.classList.remove('active');
                });
                const dataButton = document.querySelector('.mobile-nav-btn[onclick="showMobileColumn(\'left\')"]');
                if (dataButton) {
                    dataButton.classList.add('active');
                    console.log('Set Data button as active');
                }
            }
        }
        
        function loadPersistedData() {
            console.log('Loading persisted data...');
            
            // Load user profile silently
            loadUserProfile(true);
            
            // Initialize aircraft management
            updateSavedAircraftDropdowns();
            
            // Trigger initial calculations and updates
            updateWeightBalanceCalculations();
            updateDisplays();
            updatePerformanceCalculations();
            
            // Update CG chart if it's currently visible
            const cgContainer = document.getElementById('cgChartContainer');
            if (cgContainer && cgContainer.style.display !== 'none') {
                drawCGChartInLimitsPanel();
            }
            
            // Sync desktop and mobile fields
            syncDesktopMobileFields();
            
            // Trigger initial calculations
            setTimeout(() => {
                // Ensure aircraft type is properly set and ARMs are populated
                const aircraftType = document.getElementById('aircraftType').value;
                if (aircraftType && aircraftSpecs[aircraftType]) {
                    console.log('Triggering calculations for aircraft:', aircraftType);
                    populateAircraftSpecificValues(aircraftType);
                    setTimeout(() => {
                        updateDisplays();
                        updateWeightBalanceCalculations();
                        updateTakeoffPerformance();
                        updateLandingPerformance();
                        updatePerformanceCalculations();
                    }, 100);
                } else {
                    console.log('No aircraft type set, running default calculations');
                    updateDisplays();
                    updateWeightBalanceCalculations();
                    updateTakeoffPerformance();
                    updateLandingPerformance();
                    updatePerformanceCalculations();
                }
            }, 300);
        }
        
        function syncDesktopMobileFields() {
            console.log('Syncing desktop and mobile fields...');
            
            // List of fields that need synchronization
            const syncFields = [
                'aircraftType', 'tailNumber', 'weight', 'arm', 'moment',
                'userWeight', 'userBagWeight', 'instructorWeight', 'instructorBagWeight',
                'baggage1Weight', 'baggage2Weight', 'fuel', 'time',
                'temperature', 'pressureAltitude', 'headwind', 'crosswind',
                'windDirection', 'windSpeed', 'altimeter', 'fieldElevation',
                'runwayHeading', 'runwayLength', 'visibility', 'weather', 'dewpoint'
            ];
            
            syncFields.forEach(fieldId => {
                const desktopField = document.getElementById(fieldId);
                const mobileField = document.getElementById(fieldId + '-mobile');
                
                if (desktopField && mobileField) {
                    // If desktop has value but mobile doesn't, copy to mobile
                    if (desktopField.value && !mobileField.value) {
                        mobileField.value = desktopField.value;
                    }
                    // If mobile has value but desktop doesn't, copy to desktop
                    else if (mobileField.value && !desktopField.value) {
                        desktopField.value = mobileField.value;
                    }
                }
            });
        }
        
        // Replace the old DOMContentLoaded listener
        document.addEventListener('DOMContentLoaded', initializeApplication);
        
// User Profile Management Functions
function saveUserProfile() {
    const userWeight = document.getElementById('userWeight').value;
    const userBagWeight = document.getElementById('userBagWeight').value;
    const defaultAircraft = document.getElementById('defaultAircraft').value;
    const defaultAirport = document.getElementById('defaultAirport').value;
            
    if (!userWeight && !userBagWeight && !defaultAircraft && !defaultAirport) {
        showSettingsStatus('Please enter at least one value to save.', 'error');
        return;
    }
            
    const userProfile = {
        weight: userWeight,
        bagWeight: userBagWeight,
        defaultAircraft: defaultAircraft,
        defaultAirport: defaultAirport,
        savedDate: new Date().toISOString()
    };
            
    try {
        localStorage.setItem('wb_user_profile', JSON.stringify(userProfile));
        showSettingsStatus('Profile saved successfully! ', 'success');
                
        // Auto-populate current form fields
        populateMyWeightFields();
                
        // Set default aircraft if specified
        if (defaultAircraft) {
            const aircraftSelects = document.querySelectorAll('#aircraftType, #aircraftType-mobile');
            aircraftSelects.forEach(select => {
                if (select) select.value = defaultAircraft;
            });
            // updateAircraftSpecifications(); // Function not needed - calculations handled by updateWeightBalanceCalculations
        }
                
    } catch (error) {
        showSettingsStatus('Error saving profile: ' + error.message, 'error');
    }
}

function showCustomAircraftManager() {
    const manager = document.getElementById('customAircraftManager');
    if (!manager) return;
    manager.style.display = 'block';
    updateCustomAircraftManager();
}

function hideCustomAircraftManager() {
    const manager = document.getElementById('customAircraftManager');
    if (!manager) return;
    manager.style.display = 'none';
}

function updateCustomAircraftManager() {
    const list = document.getElementById('customAircraftList');
    if (!list) return;

    const customAircraft = JSON.parse(localStorage.getItem('wb_custom_aircraft') || '{}');
    const names = Object.keys(customAircraft);

    if (names.length === 0) {
        list.innerHTML = '<div style="color: #ccc; font-size: 12px;">No custom aircraft saved.</div>';
        return;
    }

    list.innerHTML = '';
    names.forEach(name => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.justifyContent = 'space-between';
        row.style.gap = '10px';
        row.style.padding = '8px 0';
        row.style.borderBottom = '1px solid #555';

        const title = document.createElement('div');
        title.style.color = '#e0e0e0';
        title.style.fontSize = '13px';
        title.textContent = name;

        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit';
        editBtn.style.backgroundColor = '#4CAF50';
        editBtn.style.color = 'white';
        editBtn.style.border = 'none';
        editBtn.style.padding = '8px 10px';
        editBtn.style.borderRadius = '6px';
        editBtn.style.cursor = 'pointer';
        editBtn.style.fontSize = '12px';
        editBtn.onclick = () => editCustomAircraft(name);

        row.appendChild(title);
        row.appendChild(editBtn);
        list.appendChild(row);
    });
}

function editCustomAircraft(aircraftName) {
    const customAircraft = JSON.parse(localStorage.getItem('wb_custom_aircraft') || '{}');
    const aircraft = customAircraft[aircraftName];
    if (!aircraft) return;

    showCustomAircraftBuilder();
    document.getElementById('customAircraftOriginalName').value = aircraftName;

    document.getElementById('customAircraftName').value = aircraft.name || aircraftName;
    document.getElementById('customAircraftModel').value = aircraft.model || '';
    document.getElementById('customSeats').value = String(aircraft.seats || 4);
    updateSeatConfiguration();

    document.getElementById('customPilotArm').value = aircraft.pilotArm || '';
    document.getElementById('customRearArm').value = aircraft.rearArm || '';
    document.getElementById('customBaggage1Arm').value = aircraft.baggage1Arm || '';
    document.getElementById('customBaggage2Arm').value = aircraft.baggage2Arm || '';
    document.getElementById('customFuelArm').value = aircraft.fuelArm || '';

    document.getElementById('customFuelBurn').value = aircraft.fuelBurnRate || '';
    document.getElementById('customFuelTanks').value = String((aircraft.fuelTanks && aircraft.fuelTanks.length) ? aircraft.fuelTanks.length : 2);
    document.getElementById('customFuelWeight').value = aircraft.fuelWeight || '';
    document.getElementById('customGroundFuelUse').value = aircraft.groundFuelUse || '';

    document.getElementById('customForwardCG').value = aircraft.forwardCG || '';
    document.getElementById('customAftCG').value = aircraft.aftCG || '';
    document.getElementById('customMaxWeight').value = aircraft.maxWeight || '';
    document.getElementById('customMaxLandingWeight').value = aircraft.maxLandingWeight || '';
    document.getElementById('customMaxCrosswind').value = aircraft.maxCrosswind || '';

    updateCustomFuelTanks();
    setTimeout(() => {
        if (aircraft.fuelTanks && aircraft.fuelTanks.length) {
            aircraft.fuelTanks.forEach((tank, index) => {
                const i = index + 1;
                const cap = document.getElementById(`customTank${i}Capacity`);
                const arm = document.getElementById(`customTank${i}Arm`);
                const unus = document.getElementById(`customTank${i}Unusable`);
                if (cap) cap.value = tank.capacity ?? '';
                if (arm) arm.value = tank.arm ?? '';
                if (unus) unus.value = tank.unusable ?? '';
            });
        }
    }, 50);

    if (aircraft.vspeeds) {
        document.getElementById('customVs0').value = aircraft.vspeeds.vs0 || '';
        document.getElementById('customVs1').value = aircraft.vspeeds.vs1 || '';
        document.getElementById('customVr').value = aircraft.vspeeds.vr || '';
        document.getElementById('customVxse').value = aircraft.vspeeds.vxse || '';
        document.getElementById('customVle').value = aircraft.vspeeds.vle || '';
        document.getElementById('customVg').value = aircraft.vspeeds.vg || '';
        document.getElementById('customVr50').value = aircraft.vspeeds.vr50 || '';
        document.getElementById('customVx').value = aircraft.vspeeds.vx || '';
        document.getElementById('customVy').value = aircraft.vspeeds.vy || '';
        document.getElementById('customVa').value = aircraft.vspeeds.va || '';
        document.getElementById('customVne').value = aircraft.vspeeds.vne || '';
        document.getElementById('customVfe').value = aircraft.vspeeds.vfe || '';
        document.getElementById('customVmc').value = aircraft.vspeeds.vmc || '';
        document.getElementById('customVyse').value = aircraft.vspeeds.vyse || '';
        document.getElementById('customVlo').value = aircraft.vspeeds.vlo || '';
        document.getElementById('customVappShort').value = aircraft.vspeeds.vappShort || '';
        document.getElementById('customVaMax').value = aircraft.vspeeds.vaMax || '';
        document.getElementById('customVappNormal').value = aircraft.vspeeds.vappNormal || '';
        document.getElementById('customVcc').value = aircraft.vspeeds.cruise || aircraft.vspeeds.vcc || '';
        document.getElementById('customVappFlapless').value = aircraft.vspeeds.vappFlapless || '';
    }

    // Load CG envelope points if they exist
    if (aircraft.cgEnvelope && aircraft.cgEnvelope.length > 0) {
        const container = document.getElementById('cgEnvelopePoints');
        // Clear existing points
        container.innerHTML = '';
        
        // Add each saved point
        aircraft.cgEnvelope.forEach(point => {
            const newRow = document.createElement('div');
            newRow.className = 'cg-point-row';
            newRow.style.cssText = 'display: flex; gap: 10px; margin-bottom: 8px; align-items: center;';
            
            newRow.innerHTML = `
                <div style="flex: 1;">
                    <label class="input-label" style="font-size: 11px;">CG Position</label>
                    <input type="number" class="input-field cg-position" value="${point.cg}" step="0.1" style="font-size: 12px; padding: 6px;">
                </div>
                <div style="flex: 1;">
                    <label class="input-label" style="font-size: 11px;">Weight (lbs)</label>
                    <input type="number" class="input-field cg-weight" value="${point.weight}" step="1" style="font-size: 12px; padding: 6px;">
                </div>
                <button type="button" onclick="removeCGPoint(this)" style="background-color: #f44336; color: white; border: none; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">√ó</button>
            `;
            
            container.appendChild(newRow);
        });
    }

    // Load axis ranges if they exist
    if (aircraft.xAxisRange) {
        document.getElementById('customXAxisRange').value = aircraft.xAxisRange;
    }
    if (aircraft.yAxisRange) {
        document.getElementById('customYAxisRange').value = aircraft.yAxisRange;
    }

    if (aircraft.performance) {
        document.getElementById('customServiceCeiling').value = aircraft.performance.serviceCeiling || '';
        document.getElementById('customRateOfClimb').value = aircraft.performance.rateOfClimb || '';
        document.getElementById('customFuelCapacity').value = aircraft.fuelCapacity || '';
    }

    hideCustomAircraftManager();
}
            
function loadUserProfile(silent = false) {
    try {
        const savedProfile = localStorage.getItem('wb_user_profile');
        if (savedProfile) {
            const profile = JSON.parse(savedProfile);
                    
            // Populate settings form
            if (profile.weight) document.getElementById('userWeight').value = profile.weight;
            if (profile.bagWeight) document.getElementById('userBagWeight').value = profile.bagWeight;
            if (profile.defaultAircraft) document.getElementById('defaultAircraft').value = profile.defaultAircraft;
            if (profile.defaultAirport) document.getElementById('defaultAirport').value = profile.defaultAirport;
                    
            // Auto-populate data fields
            populateMyWeightFields();
                    
            // Set default aircraft
            if (profile.defaultAircraft) {
                const aircraftSelects = document.querySelectorAll('#aircraftType, #aircraftType-mobile');
                aircraftSelects.forEach(select => {
                    if (select) select.value = profile.defaultAircraft;
                });
                // Populate aircraft specific values after setting default aircraft
                if (profile.defaultAircraft && aircraftSpecs[profile.defaultAircraft]) {
                    populateAircraftSpecificValues(profile.defaultAircraft);
                }
            }
            
            // Set default airport and fetch its data
            if (profile.defaultAirport) {
                const airportInput = document.getElementById('airportCode');
                if (airportInput) {
                    airportInput.value = profile.defaultAirport;
                    // Automatically fetch weather and elevation data for default airport
                    fetchWeatherData(profile.defaultAirport);
                }
            }
                    
            if (!silent) {
                const savedDate = new Date(profile.savedDate).toLocaleDateString();
                showSettingsStatus(`Profile loaded! (Saved: ${savedDate}) `, 'success');
            }
        } else {
            if (!silent) {
                showSettingsStatus('No saved profile found.', 'info');
            }
        }
    } catch (error) {
        if (!silent) {
            showSettingsStatus('Error loading profile: ' + error.message, 'error');
        }
    }
}
            
function clearUserProfile() {
    if (confirm('Are you sure you want to clear all saved profile data? This cannot be undone.')) {
        try {
            localStorage.removeItem('wb_user_profile');
                    
            // Clear settings form
            document.getElementById('userWeight').value = '';
            document.getElementById('userBagWeight').value = '';
            document.getElementById('defaultAircraft').value = '';
                    
            showSettingsStatus('Profile data cleared successfully! ', 'success');
        } catch (error) {
            showSettingsStatus('Error clearing profile: ' + error.message, 'error');
        }
    }
}
            
function populateMyWeightFields() {
    try {
        const savedProfile = localStorage.getItem('wb_user_profile');
        if (savedProfile) {
            const profile = JSON.parse(savedProfile);
                    
            // Calculate total weight (user + bag)
            const userWeight = parseFloat(profile.weight) || 0;
            const bagWeight = parseFloat(profile.bagWeight) || 0;
            const totalWeight = userWeight + bagWeight;
                    
            if (totalWeight > 0) {
                // Populate desktop fields
                const myWeightField = document.getElementById('myWeight');
                const myBagField = document.getElementById('myBag');
                        
                if (myWeightField && userWeight > 0) myWeightField.value = userWeight;
                if (myBagField && bagWeight > 0) myBagField.value = bagWeight;
                        
                // Populate mobile fields
                const myWeightMobileField = document.getElementById('myWeight-mobile');
                const myBagMobileField = document.getElementById('myBag-mobile');
                        
                if (myWeightMobileField && userWeight > 0) myWeightMobileField.value = userWeight;
                if (myBagMobileField && bagWeight > 0) myBagMobileField.value = bagWeight;
                        
                // Trigger calculations update
                updateWeightBalanceCalculations();
            }
        }
    } catch (error) {
        console.error('Error populating weight fields:', error);
    }
}
            
function showSettingsStatus(message, type) {
    const statusDiv = document.getElementById('settingsStatus');
    if (statusDiv) {
        statusDiv.textContent = message;
        statusDiv.style.display = 'block';
                
        // Set colors based on type
        switch(type) {
            case 'success':
                statusDiv.style.backgroundColor = '#4CAF50';
                statusDiv.style.color = 'white';
                break;
            case 'error':
                statusDiv.style.backgroundColor = '#f44336';
                statusDiv.style.color = 'white';
                break;
            case 'info':
                statusDiv.style.backgroundColor = '#2196F3';
                statusDiv.style.color = 'white';
                break;
            default:
                statusDiv.style.backgroundColor = '#666';
                statusDiv.style.color = 'white';
        }
                
        // Auto-hide after 3 seconds
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 3000);
    }
}

// Aircraft Management Functions
function saveCurrentAircraft() {
    const aircraftType = document.getElementById('aircraftType').value || document.getElementById('aircraftType-mobile').value;
    
    // Handle tail number field (now using datalist)
    const tailNumberField = document.getElementById('tailNumber') || document.querySelector('input[list="tailNumberList"]');
    const tailNumberMobileField = document.getElementById('tailNumber-mobile') || document.querySelector('input[list="tailNumberListMobile"]');
    const tailNumber = (tailNumberField ? tailNumberField.value : '') || (tailNumberMobileField ? tailNumberMobileField.value : '');
    
    const weight = document.getElementById('weight').value || document.getElementById('weight-mobile').value;
    const arm = document.getElementById('arm').value || document.getElementById('arm-mobile').value;
    const moment = document.getElementById('moment').value || document.getElementById('moment-mobile').value;
    
    console.log('Saving aircraft with values:', {
        aircraftType,
        tailNumber,
        weight,
        arm,
        moment
    });
    
    if (!aircraftType || !tailNumber) {
        showSettingsStatus('Please select aircraft type and enter tail number before saving.', 'error');
        return;
    }
    
    // Auto-generate aircraft name: N[tailnumber] - [aircrafttype]
    const formattedTailNumber = tailNumber.startsWith('N') ? tailNumber : `N${tailNumber}`;
    const aircraftName = `${formattedTailNumber} - ${aircraftType}`;
    
    const aircraftProfile = {
        name: aircraftName,
        aircraftType: aircraftType,
        tailNumber: tailNumber,
        weight: weight || '',
        arm: arm || '',
        moment: moment || '',
        savedDate: new Date().toISOString()
    };
    
    try {
        const savedAircraft = JSON.parse(localStorage.getItem('wb_saved_aircraft') || '{}');
        savedAircraft[aircraftName] = aircraftProfile;
        localStorage.setItem('wb_saved_aircraft', JSON.stringify(savedAircraft));
        
        // Show popup message
        showAircraftSavedPopup(aircraftName);
        updateSavedAircraftDropdowns();
        updateAircraftManager();
        updateTailNumberDropdowns();
    } catch (error) {
        showSettingsStatus('Error saving aircraft: ' + error.message, 'error');
    }
}

function loadSavedAircraft(aircraftName) {
    console.log('loadSavedAircraft called with:', aircraftName);
    if (!aircraftName) {
        console.log('No aircraft name provided');
        return;
    }

    try {
        const savedAircraft = JSON.parse(localStorage.getItem('wb_saved_aircraft') || '{}');
        console.log('Saved aircraft data:', savedAircraft);
        const aircraft = savedAircraft[aircraftName];
        console.log('Selected aircraft data:', aircraft);

        if (aircraft) {
            console.log('Loading aircraft fields...');
            
            // Populate desktop fields
            const aircraftTypeField = document.getElementById('aircraftType');
            if (aircraftTypeField) {
                aircraftTypeField.value = aircraft.aircraftType;
                console.log('Set aircraftType to:', aircraft.aircraftType);
            } else {
                console.log('aircraftType field not found');
            }
            
            // Handle tail number field (now using datalist)
            const tailNumberField = document.getElementById('tailNumber') || document.querySelector('input[list="tailNumberList"]');
            if (tailNumberField) {
                tailNumberField.value = aircraft.tailNumber;
                console.log('Set tailNumber to:', aircraft.tailNumber);
            } else {
                console.log('tailNumber field not found');
            }
            
            const weightField = document.getElementById('weight');
            if (weightField) {
                weightField.value = aircraft.weight;
                console.log('Set weight to:', aircraft.weight);
            } else {
                console.log('weight field not found');
            }
            
            const armField = document.getElementById('arm');
            if (armField) {
                armField.value = aircraft.arm;
                console.log('Set arm to:', aircraft.arm);
            } else {
                console.log('arm field not found');
            }
            
            const momentField = document.getElementById('moment');
            if (momentField) {
                momentField.value = aircraft.moment;
                console.log('Set moment to:', aircraft.moment);
            } else {
                console.log('moment field not found');
            }

            // Populate mobile fields
            const aircraftTypeMobileField = document.getElementById('aircraftType-mobile');
            if (aircraftTypeMobileField) {
                aircraftTypeMobileField.value = aircraft.aircraftType;
                console.log('Set aircraftType-mobile to:', aircraft.aircraftType);
            }
            
            // Handle mobile tail number field (now using datalist)
            const tailNumberMobileField = document.getElementById('tailNumber-mobile') || document.querySelector('input[list="tailNumberListMobile"]');
            if (tailNumberMobileField) {
                tailNumberMobileField.value = aircraft.tailNumber;
                console.log('Set tailNumber-mobile to:', aircraft.tailNumber);
            }
            
            const weightMobileField = document.getElementById('weight-mobile');
            if (weightMobileField) {
                weightMobileField.value = aircraft.weight;
                console.log('Set weight-mobile to:', aircraft.weight);
            }
            
            const armMobileField = document.getElementById('arm-mobile');
            if (armMobileField) {
                armMobileField.value = aircraft.arm;
                console.log('Set arm-mobile to:', aircraft.arm);
            }
            
            const momentMobileField = document.getElementById('moment-mobile');
            if (momentMobileField) {
                momentMobileField.value = aircraft.moment;
                console.log('Set moment-mobile to:', aircraft.moment);
            }

            console.log('Calling updateAircraftSpecifications...');
            // Update aircraft specifications and calculations
            if (typeof updateAircraftSpecifications === 'function') {
                // updateAircraftSpecifications(); // Function not needed - calculations handled by updateWeightBalanceCalculations
            } else {
                console.log('updateAircraftSpecifications not needed - using updateWeightBalanceCalculations instead');
            }
            
            console.log('Calling populateAircraftSpecificValues...');
            // Populate aircraft specific values (ARMs, etc.)
            if (typeof populateAircraftSpecificValues === 'function') {
                populateAircraftSpecificValues(aircraft.aircraftType);
            } else {
                console.error('populateAircraftSpecificValues is not defined');
            }
            
            console.log('Calling updateWeightBalanceCalculations...');
            if (typeof updateWeightBalanceCalculations === 'function') {
                updateWeightBalanceCalculations();
            } else {
                console.error('updateWeightBalanceCalculations is not defined');
            }
            
            // Update tail number displays in calculator headers
            const tailNumberDisplay = document.getElementById('tailNumberDisplay');
            const tailNumberDisplayMobile = document.getElementById('tailNumberDisplay-mobile');
            const formattedTailNumber = aircraft.tailNumber.startsWith('N') ? aircraft.tailNumber : `N${aircraft.tailNumber}`;
            
            if (tailNumberDisplay) {
                tailNumberDisplay.textContent = formattedTailNumber;
                console.log('Updated desktop tail number display to:', formattedTailNumber);
            }
            if (tailNumberDisplayMobile) {
                tailNumberDisplayMobile.textContent = formattedTailNumber;
                console.log('Updated mobile tail number display to:', formattedTailNumber);
            }
            
            // Update aircraft type displays
            const aircraftTypeDisplay = document.getElementById('aircraftTypeDisplay');
            const aircraftTypeDisplayMobile = document.getElementById('aircraftTypeDisplay-mobile');
            
            if (aircraftTypeDisplay) {
                aircraftTypeDisplay.textContent = aircraft.aircraftType;
                console.log('Updated desktop aircraft type display to:', aircraft.aircraftType);
            }
            if (aircraftTypeDisplayMobile) {
                aircraftTypeDisplayMobile.textContent = aircraft.aircraftType;
                console.log('Updated mobile aircraft type display to:', aircraft.aircraftType);
            }

            console.log('Calling showSettingsStatus...');
            if (typeof showSettingsStatus === 'function') {
                showSettingsStatus(`Aircraft "${aircraftName}" loaded successfully! üìÇ`, 'success');
            } else {
                console.error('showSettingsStatus is not defined');
            }
        } else {
            console.log('Aircraft not found in saved data');
        }
    } catch (error) {
        console.error('Error in loadSavedAircraft:', error);
        if (typeof showSettingsStatus === 'function') {
            showSettingsStatus('Error loading aircraft: ' + error.message, 'error');
        } else {
            console.error('showSettingsStatus is not defined, cannot show error message');
        }
    }
}

function updateSavedAircraftDropdowns() {
    try {
        const savedAircraft = JSON.parse(localStorage.getItem('wb_saved_aircraft') || '{}');
        const aircraftNames = Object.keys(savedAircraft);
        
        // Update default aircraft dropdown in settings
        const defaultDropdown = document.getElementById('defaultAircraft');
        if (defaultDropdown) {
            const currentValue = defaultDropdown.value;
            defaultDropdown.innerHTML = '<option value="">No Default Selected</option>';
            aircraftNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                defaultDropdown.appendChild(option);
            });
            defaultDropdown.value = currentValue; // Restore selection
        }
    } catch (error) {
        console.error('Error updating aircraft dropdowns:', error);
    }
}

function showAircraftManager() {
    const desktopManager = document.getElementById('aircraftManager');
    const mobileManager = document.getElementById('aircraftManager-mobile');
    
    if (desktopManager) {
        desktopManager.style.display = 'block';
    }
    if (mobileManager) {
        mobileManager.style.display = 'block';
    }
    
    updateAircraftManager();
}

function hideAircraftManager() {
    const desktopManager = document.getElementById('aircraftManager');
    const mobileManager = document.getElementById('aircraftManager-mobile');
    
    if (desktopManager) {
        desktopManager.style.display = 'none';
    }
    if (mobileManager) {
        mobileManager.style.display = 'none';
    }
}

function updateAircraftManager() {
    try {
        const savedAircraft = JSON.parse(localStorage.getItem('wb_saved_aircraft') || '{}');
        const desktopAircraftList = document.getElementById('aircraftList');
        const mobileAircraftList = document.getElementById('aircraftList-mobile');

        function createAircraftListContent() {
            if (Object.keys(savedAircraft).length === 0) {
                return '<div style="color: #ccc; text-align: center; padding: 20px;">No saved aircraft yet. Use "Save Current Aircraft" to add one.</div>';
            }

            let content = '';
            Object.entries(savedAircraft).forEach(([name, aircraft]) => {
                content += `
                    <div style="background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%); border-radius: 6px; padding: 10px; margin-bottom: 8px; border: 1px solid #555;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: bold; color: #fff; margin-bottom: 4px;">${name}</div>
                                <div style="font-size: 12px; color: #ccc;">
                                    ${aircraft.aircraftType} ‚Ä¢ ${aircraft.tailNumber}
                                    ${aircraft.weight ? ` ‚Ä¢ ${aircraft.weight} lbs` : ''}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="loadSavedAircraft('${name}')" style="background-color: #4CAF50; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    Load
                                </button>
                                <button onclick="setDefaultAircraft('${name}')" style="background-color: #2196F3; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    Default
                                </button>
                                <button onclick="deleteAircraft('${name}')" style="background-color: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            return content;
        }

        const listContent = createAircraftListContent();
        
        if (desktopAircraftList) {
            desktopAircraftList.innerHTML = listContent;
        }
        if (mobileAircraftList) {
            mobileAircraftList.innerHTML = listContent;
        }
    } catch (error) {
        console.error('Error updating aircraft manager:', error);
    }
}

function setDefaultAircraft(aircraftName) {
    document.getElementById('defaultAircraft').value = aircraftName;
    showSettingsStatus(`"${aircraftName}" set as default aircraft! ‚≠ê`, 'success');
}

function deleteAircraft(aircraftName) {
    if (confirm(`Are you sure you want to delete "${aircraftName}"? This cannot be undone.`)) {
        try {
            const savedAircraft = JSON.parse(localStorage.getItem('wb_saved_aircraft') || '{}');
            delete savedAircraft[aircraftName];
            localStorage.setItem('wb_saved_aircraft', JSON.stringify(savedAircraft));

            // Clear default if it was the deleted aircraft
            if (document.getElementById('defaultAircraft').value === aircraftName) {
                document.getElementById('defaultAircraft').value = '';
            }

            updateSavedAircraftDropdowns();
            updateAircraftManager();
            showSettingsStatus(`Aircraft "${aircraftName}" deleted successfully! üóëÔ∏è`, 'success');
        } catch (error) {
            showSettingsStatus('Error deleting aircraft: ' + error.message, 'error');
        }
    }
}

function loadDefaultAircraft() {
    loadSavedAircraft('N12345 - C-172');
}

// Custom Aircraft Builder Functions
function showCustomAircraftBuilder() {
    // On mobile, navigate to Column D (options page) first
    if (window.innerWidth <= 768) {
        showMobileColumn('settings');
    } else {
        // On desktop, check if Settings panel is hidden and show it if needed
        const settingsPanel = document.querySelector('.settings-panel');
        const desktopLayout = document.querySelector('.desktop-layout');
        
        if (settingsPanel && desktopLayout) {
            const isHidden = settingsPanel.classList.contains('settings-hidden') || 
                            (window.getComputedStyle(settingsPanel).display === 'none');
            
            if (isHidden) {
                // Show the settings panel
                settingsPanel.classList.remove('settings-hidden');
                settingsPanel.classList.add('settings-visible');
                desktopLayout.classList.remove('settings-collapsed');
            }
        }
    }
    
    document.getElementById('customAircraftBuilder').style.display = 'block';
    updateCustomFuelTanks(); // Initialize fuel tank inputs
}

function hideCustomAircraftBuilder() {
    document.getElementById('customAircraftBuilder').style.display = 'none';
}

function updateSeatConfiguration() {
    const seats = document.getElementById('customSeats').value;
    const rearSeatGroup = document.getElementById('rearSeatGroup');
    
    if (seats === '2') {
        rearSeatGroup.style.display = 'none';
        document.getElementById('customRearArm').value = '';
    } else {
        rearSeatGroup.style.display = 'block';
    }
}

function updateCustomFuelTanks() {
    const numTanks = parseInt(document.getElementById('customFuelTanks').value) || 2;
    const container = document.getElementById('customFuelTankInputs');
    
    container.innerHTML = '';
    
    for (let i = 1; i <= numTanks; i++) {
        const tankDiv = document.createElement('div');
        tankDiv.className = 'input-section';
        tankDiv.style.marginBottom = '10px';
        
        tankDiv.innerHTML = `
            <div class="input-group">
                <label class="input-label">Tank ${i} Capacity (gal)</label>
                <input type="number" class="input-field" id="customTank${i}Capacity" placeholder="28" step="0.1">
            </div>
            <div class="input-group">
                <label class="input-label">Tank ${i} Arm (in)</label>
                <input type="number" class="input-field" id="customTank${i}Arm" placeholder="48.0" step="0.1">
            </div>
            <div class="input-group">
                <label class="input-label">Tank ${i} Unusable (gal)</label>
                <input type="number" class="input-field" id="customTank${i}Unusable" placeholder="0" step="0.1">
            </div>
        `;
        
        container.appendChild(tankDiv);
    }
}

function clearCustomAircraftForm() {
    // Clear all form fields
    const inputs = document.querySelectorAll('#customAircraftBuilder input');
    inputs.forEach(input => {
        if (input.type === 'number') {
            input.value = '';
        } else {
            input.value = '';
        }
    });
    
    // Reset fuel tanks to default
    document.getElementById('customFuelTanks').value = '2';
    document.getElementById('customFuelWeight').value = '6.0';
    updateCustomFuelTanks();
}

function loadCustomAircraftTemplate() {
    // Load C-172 template
    // Basic information
    document.getElementById('customAircraftName').value = 'My C-172';
    document.getElementById('customAircraftModel').value = 'C-172N';
    document.getElementById('customSeats').value = '4';
    updateSeatConfiguration();
    
    // Station Arms
    document.getElementById('customPilotArm').value = '37.0';
    document.getElementById('customRearArm').value = '73.0';
    document.getElementById('customBaggage1Arm').value = '95.0';
    document.getElementById('customBaggage2Arm').value = '123.0';
    document.getElementById('customFuelArm').value = '48.0';
    
    // Fuel configuration
    document.getElementById('customFuelBurn').value = '8.5';
    document.getElementById('customFuelTanks').value = '2';
    document.getElementById('customFuelWeight').value = '6.0';
    document.getElementById('customGroundFuelUse').value = '1.0';
    updateCustomFuelTanks();
    
    // Weight & Balance Limits
    document.getElementById('customForwardCG').value = '35.0';
    document.getElementById('customAftCG').value = '47.3';
    document.getElementById('customMaxWeight').value = '2400';
    document.getElementById('customMaxLandingWeight').value = '2400';
    document.getElementById('customMaxCrosswind').value = '15';
    
    // Set tank values after update
    setTimeout(() => {
        document.getElementById('customTank1Capacity').value = '28';
        document.getElementById('customTank1Arm').value = '48.0';
        document.getElementById('customTank1Unusable').value = '0';
        document.getElementById('customTank2Capacity').value = '28';
        document.getElementById('customTank2Arm').value = '48.0';
        document.getElementById('customTank2Unusable').value = '0';
    }, 100);
    
    // V-speeds
    document.getElementById('customVs0').value = '40';
    document.getElementById('customVs1').value = '48';
    document.getElementById('customVr').value = '55';
    document.getElementById('customVxse').value = '';
    document.getElementById('customVle').value = '';
    document.getElementById('customVg').value = '';
    document.getElementById('customVr50').value = '';
    document.getElementById('customVlo').value = '';
    document.getElementById('customVx').value = '62';
    document.getElementById('customVy').value = '79';
    document.getElementById('customVa').value = '105';
    document.getElementById('customVne').value = '163';
    document.getElementById('customVfe').value = '85';
    document.getElementById('customVmc').value = '';
    document.getElementById('customVyse').value = '88';
    document.getElementById('customVappShort').value = '';
    document.getElementById('customVaMax').value = '';
    document.getElementById('customVappNormal').value = '';
    document.getElementById('customVcc').value = '122';
    document.getElementById('customVappFlapless').value = '';
    
    // Set default CG envelope points (C-152 style)
    const container = document.getElementById('cgEnvelopePoints');
    container.innerHTML = '';
    
    const defaultPoints = [
        { cg: 31.0, weight: 1000 },
        { cg: 31.0, weight: 1350 },
        { cg: 32.6, weight: 1670 },
        { cg: 36.5, weight: 1670 },
        { cg: 36.5, weight: 1000 }
    ];
    
    defaultPoints.forEach(point => {
        const newRow = document.createElement('div');
        newRow.className = 'cg-point-row';
        newRow.style.cssText = 'display: flex; gap: 10px; margin-bottom: 8px; align-items: center;';
        
        newRow.innerHTML = `
            <div style="flex: 1;">
                <label class="input-label" style="font-size: 11px;">CG Position</label>
                <input type="number" class="input-field cg-position" value="${point.cg}" step="0.1" style="font-size: 12px; padding: 6px;">
            </div>
            <div style="flex: 1;">
                <label class="input-label" style="font-size: 11px;">Weight (lbs)</label>
                <input type="number" class="input-field cg-weight" value="${point.weight}" step="1" style="font-size: 12px; padding: 6px;">
            </div>
            <button type="button" onclick="removeCGPoint(this)" style="background-color: #f44336; color: white; border: none; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">√ó</button>
        `;
        
        container.appendChild(newRow);
    });
    
    // Set default axis ranges
    document.getElementById('customXAxisRange').value = '25,30,35,40,45,50';
    document.getElementById('customYAxisRange').value = '1000,1200,1400,1600,1800,2000';
    
    // Performance data
    document.getElementById('customServiceCeiling').value = '14200';
    document.getElementById('customRateOfClimb').value = '715';
    document.getElementById('customFuelCapacity').value = '56';
}

function saveCustomAircraft() {
    const aircraftName = document.getElementById('customAircraftName').value;
    const aircraftModel = document.getElementById('customAircraftModel').value;
    const originalName = document.getElementById('customAircraftOriginalName').value;
    
    if (!aircraftName || !aircraftModel) {
        alert('Please enter aircraft name and model/type.');
        return;
    }
    
    // Collect all configuration data
    const customAircraft = {
        name: aircraftName,
        model: aircraftModel,
        type: 'CUSTOM',
        maxWeight: parseFloat(document.getElementById('customMaxWeight').value) || 0,
        forwardCG: parseFloat(document.getElementById('customForwardCG').value) || 0,
        aftCG: parseFloat(document.getElementById('customAftCG').value) || 0,
        pilotArm: parseFloat(document.getElementById('customPilotArm').value) || 0,
        rearArm: parseFloat(document.getElementById('customRearArm').value) || 0,
        baggage1Arm: parseFloat(document.getElementById('customBaggage1Arm').value) || 0,
        baggage2Arm: parseFloat(document.getElementById('customBaggage2Arm').value) || 0,
        seats: parseInt(document.getElementById('customSeats').value) || 4,
        fuelArm: parseFloat(document.getElementById('customFuelArm').value) || 0,
        fuelWeight: parseFloat(document.getElementById('customFuelWeight').value) || 6.0,
        fuelBurnRate: parseFloat(document.getElementById('customFuelBurn').value) || 0,
        groundFuelUse: parseFloat(document.getElementById('customGroundFuelUse').value) || 0,
        fuelCapacity: parseFloat(document.getElementById('customFuelCapacity').value) || 0,
        maxLandingWeight: parseFloat(document.getElementById('customMaxLandingWeight').value) || 0,
        maxCrosswind: parseFloat(document.getElementById('customMaxCrosswind').value) || 0,
        
        // Collect fuel tank data
        fuelTanks: [],
        
        // V-speeds
        vspeeds: {
            vs0: parseInt(document.getElementById('customVs0').value) || 0,
            vs1: parseInt(document.getElementById('customVs1').value) || 0,
            vr: parseInt(document.getElementById('customVr').value) || 0,
            vxse: parseInt(document.getElementById('customVxse').value) || 0,
            vle: parseInt(document.getElementById('customVle').value) || 0,
            vg: parseInt(document.getElementById('customVg').value) || 0,
            vr50: parseInt(document.getElementById('customVr50').value) || 0,
            vx: parseInt(document.getElementById('customVx').value) || 0,
            vy: parseInt(document.getElementById('customVy').value) || 0,
            va: parseInt(document.getElementById('customVa').value) || 0,
            vne: parseInt(document.getElementById('customVne').value) || 0,
            vfe: parseInt(document.getElementById('customVfe').value) || 0,
            vmc: parseInt(document.getElementById('customVmc').value) || 0,
            vyse: parseInt(document.getElementById('customVyse').value) || 0,
            vlo: parseInt(document.getElementById('customVlo').value) || 0,
            vappShort: parseInt(document.getElementById('customVappShort').value) || 0,
            vaMax: parseInt(document.getElementById('customVaMax').value) || 0,
            vappNormal: parseInt(document.getElementById('customVappNormal').value) || 0,
            cruise: parseInt(document.getElementById('customVcc').value) || 0,
            vappFlapless: parseInt(document.getElementById('customVappFlapless').value) || 0
        },
        
        // CG Envelope points
        cgEnvelope: [],
        
        // Axis ranges
        xAxisRange: document.getElementById('customXAxisRange').value || '',
        yAxisRange: document.getElementById('customYAxisRange').value || '',
        
        // Performance data
        performance: {
            serviceCeiling: parseInt(document.getElementById('customServiceCeiling').value) || 0,
            rateOfClimb: parseInt(document.getElementById('customRateOfClimb').value) || 0
        },
        
        savedDate: new Date().toISOString()
    };
    
    // Collect fuel tank data
    const numTanks = parseInt(document.getElementById('customFuelTanks').value);
    for (let i = 1; i <= numTanks; i++) {
        const capacity = parseFloat(document.getElementById(`customTank${i}Capacity`).value) || 0;
        const arm = parseFloat(document.getElementById(`customTank${i}Arm`).value) || 0;
        const unusable = parseFloat(document.getElementById(`customTank${i}Unusable`).value) || 0;
        
        customAircraft.fuelTanks.push({
            capacity: capacity,
            arm: arm,
            unusable: unusable
        });
    }
    
    // Collect CG envelope points
    const cgPointRows = document.querySelectorAll('#cgEnvelopePoints .cg-point-row');
    cgPointRows.forEach(row => {
        const cgPosition = parseFloat(row.querySelector('.cg-position').value);
        const weight = parseFloat(row.querySelector('.cg-weight').value);
        
        if (!isNaN(cgPosition) && !isNaN(weight)) {
            customAircraft.cgEnvelope.push({
                cg: cgPosition,
                weight: weight
            });
        }
    });
    
    try {
        // Save to localStorage
        const savedCustomAircraft = JSON.parse(localStorage.getItem('wb_custom_aircraft') || '{}');
        if (originalName && originalName !== aircraftName && savedCustomAircraft[originalName]) {
            delete savedCustomAircraft[originalName];
        }
        savedCustomAircraft[aircraftName] = customAircraft;
        localStorage.setItem('wb_custom_aircraft', JSON.stringify(savedCustomAircraft));
        
        // Add to aircraft specs for immediate use
        aircraftSpecs[`CUSTOM_${aircraftName.replace(/\s+/g, '_')}`] = {
            maxWeight: customAircraft.maxWeight,
            maxTakeoffWeight: customAircraft.maxWeight,
            forwardCG: customAircraft.forwardCG,
            aftCG: customAircraft.aftCG,
            maxLandingWeight: customAircraft.maxLandingWeight,
            seats: customAircraft.seats,
            frontSeatArm: customAircraft.pilotArm,
            rearSeatArm: customAircraft.seats === 2 ? null : customAircraft.rearArm,
            baggage1Arm: customAircraft.baggage1Arm,
            baggage2Arm: customAircraft.baggage2Arm,
            fuelArm: customAircraft.fuelArm || (customAircraft.fuelTanks.length > 0 ? customAircraft.fuelTanks[0].arm : 48.0),
            groundFuelUse: customAircraft.groundFuelUse,
            fuelWeight: customAircraft.fuelWeight,
            fuelBurnRate: customAircraft.fuelBurnRate,
            maxCrosswind: customAircraft.maxCrosswind,
            demoCrosswind: customAircraft.maxCrosswind,
            vspeeds: customAircraft.vspeeds,
            performance: customAircraft.performance,
            fuelTanks: customAircraft.fuelTanks,
            isCustom: true
        };
        
        // Update aircraft type dropdown to include custom aircraft
        updateAircraftTypeDropdown();
        document.getElementById('customAircraftOriginalName').value = '';
        
        alert(`Custom aircraft "${aircraftName}" saved successfully!`);
        hideCustomAircraftBuilder();
        
    } catch (error) {
        alert('Error saving custom aircraft: ' + error.message);
    }
}

function updateAircraftTypeDropdown() {
    const customAircraft = JSON.parse(localStorage.getItem('wb_custom_aircraft') || '{}');
    const dropdowns = document.querySelectorAll('#aircraftType, #aircraftType-mobile');
    
    dropdowns.forEach(dropdown => {
        // Remove existing custom options
        const options = dropdown.querySelectorAll('option[data-custom="true"]');
        options.forEach(option => option.remove());
        
        // Add custom aircraft options
        Object.keys(customAircraft).forEach(name => {
            const option = document.createElement('option');
            option.value = `CUSTOM_${name.replace(/\s+/g, '_')}`;
            option.textContent = `${name} (Custom)`;
            option.setAttribute('data-custom', 'true');
            dropdown.appendChild(option);
        });
    });
}

function loadCustomAircraft(customKey) {
    const customAircraft = JSON.parse(localStorage.getItem('wb_custom_aircraft') || '{}');
    const aircraftName = customKey.replace('CUSTOM_', '').replace(/_/g, ' ');
    const aircraft = customAircraft[aircraftName];
    
    if (aircraft) {
        // Add custom aircraft to aircraftSpecs for immediate use
        aircraftSpecs[customKey] = {
            name: aircraft.name,
            maxWeight: aircraft.maxWeight,
            maxTakeoffWeight: aircraft.maxWeight,
            forwardCG: aircraft.forwardCG,
            aftCG: aircraft.aftCG,
            maxLandingWeight: aircraft.maxLandingWeight,
            seats: aircraft.seats,
            frontSeatArm: aircraft.pilotArm,
            rearSeatArm: aircraft.seats === 2 ? null : aircraft.rearArm,
            baggage1Arm: aircraft.baggage1Arm,
            baggage2Arm: aircraft.baggage2Arm,
            fuelArm: aircraft.fuelArm || (aircraft.fuelTanks && aircraft.fuelTanks.length > 0 ? aircraft.fuelTanks[0].arm : 48.0),
            fuelWeight: aircraft.fuelWeight,
            fuelBurnRate: aircraft.fuelBurnRate,
            groundFuelUse: aircraft.groundFuelUse,
            maxCrosswind: aircraft.maxCrosswind,
            demoCrosswind: aircraft.maxCrosswind,
            fuelTanks: aircraft.fuelTanks,
            vspeeds: aircraft.vspeeds,
            cgEnvelope: aircraft.cgEnvelope || [],
            xAxisRange: aircraft.xAxisRange || '',
            yAxisRange: aircraft.yAxisRange || '',
            performance: aircraft.performance
        };

        // Populate Column B / dependent panels for this aircraft
        populateAircraftSpecificValues(customKey);
        populateVSpeedsPanel(customKey);
        drawCGChart();

        // Hide the custom aircraft builder
        hideCustomAircraftBuilder();
    }
}

function displayCustomAircraftInfo(aircraft) {
    // Update performance displays with custom aircraft data
    const performanceSection = document.querySelector('.info-grid');
    if (performanceSection && aircraft.vspeeds) {
        // Create custom performance display
        let customInfo = '<div style="background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%); padding: 15px; border-radius: 8px; margin-top: 10px;">';
        customInfo += `<h4 style="color: #4CAF50; margin-bottom: 10px;">${aircraft.name} - Custom Aircraft</h4>`;
        customInfo += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">';
        
        // V-speeds column
        customInfo += '<div><h5 style="color: #e0e0e0; margin-bottom: 8px;">V-Speeds</h5>';
        if (aircraft.vspeeds.vs0) customInfo += `<div style="color: #ccc; font-size: 12px;">Vs0: ${aircraft.vspeeds.vs0} kts</div>`;
        if (aircraft.vspeeds.vs1) customInfo += `<div style="color: #ccc; font-size: 12px;">Vs1: ${aircraft.vspeeds.vs1} kts</div>`;
        if (aircraft.vspeeds.vr) customInfo += `<div style="color: #ccc; font-size: 12px;">Vr: ${aircraft.vspeeds.vr} kts</div>`;
        if (aircraft.vspeeds.vx) customInfo += `<div style="color: #ccc; font-size: 12px;">Vx: ${aircraft.vspeeds.vx} kts</div>`;
        if (aircraft.vspeeds.vy) customInfo += `<div style="color: #ccc; font-size: 12px;">Vy: ${aircraft.vspeeds.vy} kts</div>`;
        if (aircraft.vspeeds.va) customInfo += `<div style="color: #ccc; font-size: 12px;">Va: ${aircraft.vspeeds.va} kts</div>`;
        if (aircraft.vspeeds.vno) customInfo += `<div style="color: #ccc; font-size: 12px;">Vno: ${aircraft.vspeeds.vno} kts</div>`;
        if (aircraft.vspeeds.vne) customInfo += `<div style="color: #ccc; font-size: 12px;">Vne: ${aircraft.vspeeds.vne} kts</div>`;
        customInfo += '</div>';
        
        // Limits column
        customInfo += '<div><h5 style="color: #e0e0e0; margin-bottom: 8px;">Limits</h5>';
        customInfo += `<div style="color: #ccc; font-size: 12px;">Max Weight: ${aircraft.maxWeight} lbs</div>`;
        customInfo += `<div style="color: #ccc; font-size: 12px;">Forward CG: ${aircraft.forwardCG} in</div>`;
        customInfo += `<div style="color: #ccc; font-size: 12px;">Aft CG: ${aircraft.aftCG} in</div>`;
        if (aircraft.performance.serviceCeiling) customInfo += `<div style="color: #ccc; font-size: 12px;">Service Ceiling: ${aircraft.performance.serviceCeiling} ft</div>`;
        if (aircraft.performance.rateOfClimb) customInfo += `<div style="color: #ccc; font-size: 12px;">Rate of Climb: ${aircraft.performance.rateOfClimb} fpm</div>`;
        customInfo += '</div>';
        
        customInfo += '</div></div>';
        
        // Insert after existing performance data
        const existingCustomInfo = document.getElementById('customAircraftInfo');
        if (existingCustomInfo) {
            existingCustomInfo.remove();
        }
        
        const customDiv = document.createElement('div');
        customDiv.id = 'customAircraftInfo';
        customDiv.innerHTML = customInfo;
        performanceSection.appendChild(customDiv);
    }
}

function showAircraftSavedPopup(aircraftName) {
    // Create popup element
    const popup = document.createElement('div');
    popup.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #4CAF50;
        color: white;
        padding: 20px 30px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: bold;
        z-index: 10000;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        text-align: center;
    `;
    popup.innerHTML = `‚úàÔ∏è Aircraft Saved!<br><span style="font-size: 14px; font-weight: normal;">${aircraftName}</span>`;
    
    document.body.appendChild(popup);
    
    // Auto-remove after 2 seconds
    setTimeout(() => {
        if (popup.parentNode) {
            popup.parentNode.removeChild(popup);
        }
    }, 2000);
}

function updateTailNumberDropdowns() {
    try {
        const savedAircraft = JSON.parse(localStorage.getItem('wb_saved_aircraft') || '{}');
        const aircraftNames = Object.keys(savedAircraft);
        
        // Only convert to dropdown if there are saved aircraft
        if (aircraftNames.length === 0) return;
        
        // Update desktop tail number field
        const desktopTailField = document.getElementById('tailNumber');
        if (desktopTailField && desktopTailField.tagName === 'INPUT') {
            // Create a wrapper div for the input + dropdown combo
            const wrapper = document.createElement('div');
            wrapper.style.position = 'relative';
            wrapper.style.width = '120px';
            wrapper.style.display = 'flex';
            
            // Keep the original input
            const input = desktopTailField.cloneNode(true);
            input.setAttribute('list', 'tailNumberList');
            
            // Ensure the input maintains its event listeners
            input.addEventListener('input', function() {
                updateDisplays();
                updateWeightBalanceCalculations();
            });
            
            // Create datalist for suggestions
            const datalist = document.createElement('datalist');
            datalist.id = 'tailNumberList';
            
            aircraftNames.forEach(name => {
                const aircraft = savedAircraft[name];
                const option = document.createElement('option');
                option.value = aircraft.tailNumber;
                option.textContent = name;
                option.setAttribute('data-aircraft', name);
                datalist.appendChild(option);
            });
            
            // Add event listeners to load aircraft when selecting from datalist
            function handleAircraftSelection() {
                const selectedOption = Array.from(datalist.options).find(opt => opt.value === this.value);
                if (selectedOption) {
                    const aircraftName = selectedOption.getAttribute('data-aircraft');
                    if (aircraftName) {
                        console.log('Loading aircraft:', aircraftName);
                        loadSavedAircraft(aircraftName);
                    }
                }
            }
            
            input.addEventListener('input', handleAircraftSelection);
            input.addEventListener('change', handleAircraftSelection);
            input.addEventListener('blur', handleAircraftSelection);
            
            // Ensure the input maintains its event listeners
            input.addEventListener('input', function() {
                updateDisplays();
                updateWeightBalanceCalculations();
            });
            
            wrapper.appendChild(input);
            wrapper.appendChild(datalist);
            desktopTailField.parentNode.replaceChild(wrapper, desktopTailField);
        }
        
        // Update mobile tail number field
        const mobileTailField = document.getElementById('tailNumber-mobile');
        if (mobileTailField && mobileTailField.tagName === 'INPUT') {
            // Create a wrapper div for the input + dropdown combo
            const wrapper = document.createElement('div');
            wrapper.style.position = 'relative';
            wrapper.style.width = '120px';
            wrapper.style.display = 'flex';
            
            // Keep the original input
            const input = mobileTailField.cloneNode(true);
            input.setAttribute('list', 'tailNumberListMobile');
            
            // Ensure the input maintains its event listeners
            input.addEventListener('input', function() {
                updateDisplays();
                updateWeightBalanceCalculations();
            });
            
            // Create datalist for suggestions
            const datalist = document.createElement('datalist');
            datalist.id = 'tailNumberListMobile';
            
            aircraftNames.forEach(name => {
                const aircraft = savedAircraft[name];
                const option = document.createElement('option');
                option.value = aircraft.tailNumber;
                option.textContent = name;
                option.setAttribute('data-aircraft', name);
                datalist.appendChild(option);
            });
            
            // Add event listeners to load aircraft when selecting from datalist (mobile)
            function handleMobileAircraftSelection() {
                const selectedOption = Array.from(datalist.options).find(opt => opt.value === this.value);
                if (selectedOption) {
                    const aircraftName = selectedOption.getAttribute('data-aircraft');
                    if (aircraftName) {
                        console.log('Loading aircraft (mobile):', aircraftName);
                        loadSavedAircraft(aircraftName);
                    }
                }
            }
            
            input.addEventListener('input', handleMobileAircraftSelection);
            input.addEventListener('change', handleMobileAircraftSelection);
            input.addEventListener('blur', handleMobileAircraftSelection);
            
            wrapper.appendChild(input);
            wrapper.appendChild(datalist);
            mobileTailField.parentNode.replaceChild(wrapper, mobileTailField);
        }
    } catch (error) {
        console.error('Error updating tail number dropdowns:', error);
    }
}

// CG Envelope Point Management Functions
function addCGPoint() {
    const container = document.getElementById('cgEnvelopePoints');
    const newRow = document.createElement('div');
    newRow.className = 'cg-point-row';
    newRow.style.cssText = 'display: flex; gap: 10px; margin-bottom: 8px; align-items: center;';
    
    newRow.innerHTML = `
        <div style="flex: 1;">
            <label class="input-label" style="font-size: 11px;">CG Position</label>
            <input type="number" class="input-field cg-position" placeholder="0.0" step="0.1" style="font-size: 12px; padding: 6px;">
        </div>
        <div style="flex: 1;">
            <label class="input-label" style="font-size: 11px;">Weight (lbs)</label>
            <input type="number" class="input-field cg-weight" placeholder="0" step="1" style="font-size: 12px; padding: 6px;">
        </div>
        <button type="button" onclick="removeCGPoint(this)" style="background-color: #f44336; color: white; border: none; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">√ó</button>
    `;
    
    container.appendChild(newRow);
}

// Toggle CG Envelope display in limits panel
function toggleCGEnvelope() {
    const container = document.getElementById('cgChartContainer');
    const button = document.getElementById('cgEnvelopeToggle');
    
    if (container.style.display === 'none') {
        // Show the CG envelope
        container.style.display = 'block';
        button.textContent = 'Hide CG Envelope';
        button.style.background = 'linear-gradient(135deg, rgba(255, 87, 34, 0.3) 0%, rgba(255, 87, 34, 0.1) 100%)';
        button.style.borderColor = '#FF5722';
        button.style.boxShadow = '0 2px 4px rgba(255, 87, 34, 0.2)';
        
        // Draw the CG chart
        drawCGChartInLimitsPanel();
    } else {
        // Hide the CG envelope
        container.style.display = 'none';
        button.textContent = 'Show CG Envelope';
        button.style.background = 'linear-gradient(135deg, rgba(76, 175, 80, 0.3) 0%, rgba(76, 175, 80, 0.1) 100%)';
        button.style.borderColor = '#4CAF50';
        button.style.boxShadow = '0 2px 4px rgba(76, 175, 80, 0.2)';
    }
}

// Draw CG chart in the limits panel
function drawCGChartInLimitsPanel() {
    const canvas = document.getElementById('cgChart');
    if (!canvas) return;
    
    // Use the existing CG chart drawing function
    drawCGChartOnCanvas(canvas);
}

function removeCGPoint(button) {
    const row = button.parentElement;
    const container = document.getElementById('cgEnvelopePoints');
    
    // Don't allow removing if it's the last row
    if (container.children.length > 1) {
        row.remove();
    }
}

async function fetchWeatherData(airportCode) {
    try {
        const upperCode = airportCode.toUpperCase();
        console.log(`Fetching weather data for: ${upperCode}`);
        
        // Fetch weather data and airport elevation in parallel
        const weatherPromise = fetchWeatherFromAPIs(upperCode);
        const elevationPromise = fetchAirportElevation(upperCode);
        
        // Wait for both requests to complete
        const [weatherData, elevationData] = await Promise.all([weatherPromise, elevationPromise]);
        
        // Update weather displays
        if (weatherData) {
            updateWeatherPanel(weatherData);
        } else {
            updateWeatherPanel(null, 'Unable to fetch weather data for this airport');
        }
        
        // Update elevation data (separate from weather)
        if (elevationData) {
            updateFieldElevationFromAirport(elevationData);
        } else {
            console.log('No elevation data available for this airport');
        }
        
    } catch (error) {
        console.error('Error in fetchWeatherData:', error);
        updateWeatherPanel(null, 'Error fetching airport data');
    }
}

async function fetchWeatherFromAPIs(airportCode) {
    try {
        const upperCode = airportCode.toUpperCase();
        let weatherData = null;
        
        // Try multiple CORS proxies with Aviation Weather Center
        const proxies = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?',
            'https://api.codetabs.com/v1/proxy?quest='
        ];
        
        const awcUrl = `https://aviationweather.gov/api/data/metar?ids=${upperCode}&format=json`;
        
        for (const proxy of proxies) {
            try {
                const response = await fetch(proxy + encodeURIComponent(awcUrl));
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        weatherData = convertAWCData(data[0]);
                        console.log('Current weather data from AWC via', proxy, ':', weatherData);
                        break;
                    }
                }
            } catch (proxyError) {
                console.log(`Proxy ${proxy} failed, trying next...`);
            }
        }
        
        // Try NOAA METAR text with proxies if AWC failed
        if (!weatherData) {
            const noaaUrl = `https://tgftp.nws.noaa.gov/data/observations/metar/stations/${upperCode}.TXT`;
            
            for (const proxy of proxies) {
                try {
                    const response = await fetch(proxy + encodeURIComponent(noaaUrl));
                    
                    if (response.ok) {
                        const metarText = await response.text();
                        const lines = metarText.trim().split('\n');
                        if (lines.length >= 2) {
                            const rawMetar = lines[1].trim();
                            weatherData = parseRawMETAR(rawMetar);
                            console.log('Current weather data from NOAA via', proxy, ':', weatherData);
                            break;
                        }
                    }
                } catch (noaaError) {
                    console.log(`NOAA via ${proxy} failed...`);
                }
            }
        }
        
        // Try direct fetch (might work for some browsers/environments)
        if (!weatherData) {
            try {
                const response = await fetch(awcUrl);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        weatherData = convertAWCData(data[0]);
                        console.log('Current weather data from AWC direct:', weatherData);
                    }
                }
            } catch (directError) {
                console.log('Direct AWC fetch failed...');
            }
        }
        
        // Try OpenWeatherMap API as fallback (free tier)
        if (!weatherData) {
            try {
                // Note: This requires a free API key from openweathermap.org
                // For now, we'll use it to demonstrate the structure
                const owmUrl = `https://api.openweathermap.org/data/2.5/weather?q=${upperCode}&appid=YOUR_API_KEY&units=metric`;
                console.log('OpenWeatherMap would require API key setup');
            } catch (owmError) {
                console.log('OpenWeatherMap not configured...');
            }
        }
        
        // Fallback: Enhanced mock data with disclaimer
        if (!weatherData) {
            weatherData = generateMockWeatherData(upperCode);
            console.log('Using sample weather data (APIs unavailable):', weatherData);
            updateWeatherPanel(weatherData, `Sample data for ${upperCode} - For current weather, check 1800wxbrief.com`);
            return;
        }
        
        return weatherData;
        
    } catch (error) {
        console.error('Error fetching weather from APIs:', error);
        return null;
    }
}

// Parse raw METAR text
function parseRawMETAR(rawMetar) {
    try {
        const parts = rawMetar.split(' ');
        const airportCode = parts[0];
        
        // Extract observation time (e.g., 080353Z)
        const timeMatch = rawMetar.match(/\s(\d{6}Z)\s/);
        const obsTime = timeMatch ? timeMatch[1] : 'N/A';
        
        // Extract wind data including gusts
        const windMatch = rawMetar.match(/(\d{3})(\d{2,3})(G(\d{2,3}))?KT|(\d{5})KT/);
        let windDir = 0, windSpeed = 0;
        if (windMatch) {
            if (windMatch[1] && windMatch[2]) {
                windDir = parseInt(windMatch[1]);
                windSpeed = parseInt(windMatch[2]);
                // Use gust speed if present
                if (windMatch[4]) {
                    windSpeed = parseInt(windMatch[4]);
                }
            } else if (windMatch[5]) {
                const windStr = windMatch[5];
                windDir = parseInt(windStr.substring(0, 3));
                windSpeed = parseInt(windStr.substring(3));
            }
        }
        
        // Extract visibility
        const visMatch = rawMetar.match(/\s(\d+)SM|\s(\d+\/\d+)SM/);
        const visibility = visMatch ? (visMatch[1] || visMatch[2]) : '10';
        
        // Extract weather conditions (CLR, BKN, SCT, OVC, etc.)
        const weatherConditions = [];
        const wxPatterns = [
            /\s(CLR)\s/,
            /\s(SKC)\s/,
            /\s(FEW\d{3})\s/,
            /\s(SCT\d{3})\s/,
            /\s(BKN\d{3})\s/,
            /\s(OVC\d{3})\s/,
            /\s(RA)\s/,
            /\s(SN)\s/,
            /\s(FG)\s/,
            /\s(BR)\s/,
            /\s(HZ)\s/
        ];
        
        wxPatterns.forEach(pattern => {
            const match = rawMetar.match(pattern);
            if (match) {
                weatherConditions.push(match[1]);
            }
        });
        
        const weather = weatherConditions.length > 0 ? weatherConditions.join(' ') : 'CLR';
        
        // Extract temperature and dewpoint
        const tempMatch = rawMetar.match(/\s(M?\d{2})\/(M?\d{2})\s/);
        let temp = null, dewpoint = null;
        if (tempMatch) {
            temp = tempMatch[1].startsWith('M') ? -parseInt(tempMatch[1].substring(1)) : parseInt(tempMatch[1]);
            dewpoint = tempMatch[2].startsWith('M') ? -parseInt(tempMatch[2].substring(1)) : parseInt(tempMatch[2]);
        }
        
        // Extract altimeter
        const altMatch = rawMetar.match(/A(\d{4})/);
        const altimeter = altMatch ? (parseInt(altMatch[1]) / 100).toFixed(2) : '30.00';
        
        return {
            raw: rawMetar,
            obsTime: obsTime,
            visibility: { repr: `${visibility} SM` },
            weather: { repr: weather },
            temperature: { 
                repr: temp !== null ? `${temp}¬∞C` : 'N/A',
                value: temp
            },
            dewpoint: { 
                repr: dewpoint !== null ? `${dewpoint}¬∞C` : 'N/A'
            },
            altimeter: { 
                repr: `${altimeter}"`,
                value: parseFloat(altimeter)
            },
            wind_direction: { 
                repr: windSpeed === 0 ? 'CALM' : `${windDir}¬∞`,
                value: windDir
            },
            wind_speed: { 
                repr: windSpeed === 0 ? 'CALM' : `${windSpeed} kts`,
                value: windSpeed
            },
            elevation: { repr: 'N/A' }
        };
    } catch (error) {
        console.error('Error parsing METAR:', error);
        return null;
    }
}

// Convert CheckWX API data format
function convertCheckWXData(data) {
    return {
        raw: data.raw_text || 'N/A',
        visibility: { repr: data.visibility?.miles_float ? `${data.visibility.miles_float} SM` : 'N/A' },
        temperature: { 
            repr: data.temperature?.celsius ? `${Math.round(data.temperature.celsius)}¬∞C` : 'N/A',
            value: data.temperature?.celsius || null
        },
        dewpoint: { 
            repr: data.dewpoint?.celsius ? `${Math.round(data.dewpoint.celsius)}¬∞C` : 'N/A' 
        },
        altimeter: { 
            repr: data.barometer?.hg ? `${data.barometer.hg}"` : 'N/A',
            value: data.barometer?.hg || null
        },
        wind_direction: { 
            repr: data.wind?.degrees ? `${data.wind.degrees}¬∞` : 'N/A',
            value: data.wind?.degrees || null
        },
        wind_speed: { 
            repr: data.wind?.speed_kts ? `${data.wind.speed_kts} kts` : 'N/A',
            value: data.wind?.speed_kts || null
        },
        elevation: { repr: data.elevation?.feet ? `${data.elevation.feet} ft` : 'N/A' }
    };
}

// Convert Aviation Weather Center data format
function convertAWCData(data) {
    // Extract weather conditions from raw METAR string
    let weatherConditions = 'N/A';
    let visibility = 'N/A';
    let altimeter = null;
    let temperature = null;
    let dewpoint = null;
    
    if (data.rawOb) {
        const rawMetar = data.rawOb;
        
        // Extract visibility from METAR (e.g., "10SM" or "1/2SM")
        const visMatch = rawMetar.match(/\s(\d+(?:\/\d+)?|\d+\+?)SM\s/);
        if (visMatch) {
            visibility = visMatch[1].replace('+', ''); // Remove + if present
        }
        
        // Extract altimeter from METAR (e.g., "A3016" -> 30.16)
        const altMatch = rawMetar.match(/\sA(\d{4})\s/);
        if (altMatch) {
            altimeter = (parseInt(altMatch[1]) / 100);
        }
        
        // Extract temperature and dewpoint from main METAR section (e.g., "13/01")
        const tempMatch = rawMetar.match(/\s(M?\d{2})\/(M?\d{2})\s/);
        if (tempMatch) {
            temperature = tempMatch[1].startsWith('M') ? -parseInt(tempMatch[1].substring(1)) : parseInt(tempMatch[1]);
            dewpoint = tempMatch[2].startsWith('M') ? -parseInt(tempMatch[2].substring(1)) : parseInt(tempMatch[2]);
        }
        
        // Extract weather conditions
        const weatherPatterns = [
            /\s(CLR)\s/,
            /\s(SKC)\s/,
            /\s(FEW\d{3})\s/,
            /\s(SCT\d{3})\s/,
            /\s(BKN\d{3})\s/,
            /\s(OVC\d{3})\s/,
            /\s(RA)\s/,
            /\s(SN)\s/,
            /\s(FG)\s/,
            /\s(BR)\s/,
            /\s(HZ)\s/
        ];
        
        const foundConditions = [];
        weatherPatterns.forEach(pattern => {
            const match = rawMetar.match(pattern);
            if (match) {
                foundConditions.push(match[1]);
            }
        });
        
        weatherConditions = foundConditions.length > 0 ? foundConditions.join(' ') : 'CLR';
    }
    
    return {
        raw: data.rawOb || 'N/A',
        obsTime: extractObsTime(data.rawOb),
        visibility: { repr: visibility !== 'N/A' ? `${visibility} SM` : 'N/A' },
        weather: { repr: weatherConditions },
        temperature: { 
            repr: temperature !== null ? `${temperature}¬∞C` : 'N/A',
            value: temperature
        },
        dewpoint: { 
            repr: dewpoint !== null ? `${dewpoint}¬∞C` : 'N/A',
            value: dewpoint
        },
        altimeter: { 
            repr: altimeter !== null ? `${altimeter.toFixed(2)}"` : 'N/A',
            value: altimeter
        },
        wind_direction: { 
            repr: data.wdir ? `${data.wdir}¬∞` : 'N/A',
            value: data.wdir || null
        },
        wind_speed: { 
            repr: data.wspd ? `${data.wspd} kts` : 'N/A',
            value: data.wspd || null
        },
        elevation: { repr: data.elev ? `${data.elev} ft` : 'N/A' }
    };
}

// Helper function to extract observation time from raw METAR
function extractObsTime(rawMetar) {
    if (!rawMetar) return 'N/A';
    const timeMatch = rawMetar.match(/\s(\d{6}Z)\s/);
    return timeMatch ? timeMatch[1] : 'N/A';
}

// Airport elevation lookup using OurAirports data
let airportElevationCache = null;

async function fetchAirportElevation(airportCode) {
    try {
        const upperCode = airportCode.toUpperCase();
        console.log(`Fetching elevation data for: ${upperCode}`);
        
        // Load airport data if not cached
        if (!airportElevationCache) {
            console.log('Loading OurAirports elevation database...');
            const response = await fetch('https://davidmegginson.github.io/ourairports-data/airports.csv');
            const csvText = await response.text();
            
            // Parse CSV and create lookup cache
            airportElevationCache = {};
            const lines = csvText.split('\n');
            const headers = lines[0].split(',');
            
            // Find column indices
            const icaoIndex = headers.findIndex(h => h.includes('ident'));
            const elevationIndex = headers.findIndex(h => h.includes('elevation_ft'));
            const nameIndex = headers.findIndex(h => h.includes('name'));
            
            // Parse data rows
            for (let i = 1; i < lines.length; i++) {
                const row = lines[i].split(',');
                if (row.length > Math.max(icaoIndex, elevationIndex)) {
                    const icao = row[icaoIndex]?.replace(/"/g, '').trim();
                    const elevation = row[elevationIndex]?.replace(/"/g, '').trim();
                    const name = row[nameIndex]?.replace(/"/g, '').trim();
                    
                    if (icao && elevation && !isNaN(elevation)) {
                        airportElevationCache[icao] = {
                            elevation: parseInt(elevation),
                            name: name || 'Unknown Airport'
                        };
                    }
                }
            }
            console.log(`Loaded ${Object.keys(airportElevationCache).length} airports into elevation cache`);
        }
        
        // Look up elevation for requested airport
        const airportData = airportElevationCache[upperCode];
        if (airportData) {
            console.log(`Found elevation for ${upperCode}: ${airportData.elevation} ft MSL`);
            return {
                icao: upperCode,
                elevation: airportData.elevation,
                name: airportData.name,
                source: 'OurAirports'
            };
        } else {
            console.log(`No elevation data found for ${upperCode}`);
            return null;
        }
        
    } catch (error) {
        console.error('Error fetching airport elevation:', error);
        return null;
    }
}

function updateFieldElevationFromAirport(elevationData) {
    try {
        if (!elevationData) return;
        
        // Update Field Elevation in Column A
        const fieldElevationInput = document.getElementById('fieldElevation');
        if (fieldElevationInput && elevationData.elevation) {
            fieldElevationInput.value = elevationData.elevation;
            console.log(`Updated Field Elevation: ${elevationData.elevation} ft MSL`);
        }
        
        // Update Airport Elevation display in Current Conditions panel
        const airportElevationElement = document.querySelector('[data-field="airportElevation"]');
        if (airportElevationElement && elevationData.elevation) {
            airportElevationElement.textContent = `${elevationData.elevation} ft`;
        }
        
        // Trigger pressure/density altitude calculations
        setTimeout(() => {
            if (typeof updatePerformanceCalculations === 'function') {
                updatePerformanceCalculations();
            }
            if (typeof updateDisplays === 'function') {
                updateDisplays();
            }
        }, 100);
        
    } catch (error) {
        console.error('Error updating field elevation:', error);
    }
}
function generateMockWeatherData(airportCode) {
    // Ensure airport code is uppercase
    const upperCode = airportCode.toUpperCase();
    
    const mockData = {
        'KDFW': {
            raw: 'KDFW 080253Z 18008KT 10SM FEW250 22/M02 A3012 RMK AO2 SLP220 T02221022',
            visibility: { repr: '10 SM' },
            temperature: { repr: '22¬∞C', value: 22 },
            dewpoint: { repr: '-2¬∞C' },
            altimeter: { repr: '30.12"', value: 30.12 },
            wind_direction: { repr: '180¬∞', value: 180 },
            wind_speed: { repr: '8 kts', value: 8 },
            elevation: { repr: '607 ft' }
        },
        'KDTO': {
            raw: 'KDTO 080253Z 14005KT 10SM CLR 13/00 A3015 RMK AO2 SLP208 T01330000 51002',
            visibility: { repr: '10 SM' },
            temperature: { repr: '13¬∞C', value: 13 },
            dewpoint: { repr: '0¬∞C' },
            altimeter: { repr: '30.15"', value: 30.15 },
            wind_direction: { repr: '140¬∞', value: 140 },
            wind_speed: { repr: '5 kts', value: 5 },
            elevation: { repr: '700 ft' }
        },
        'KLAX': {
            raw: 'KLAX 080253Z 25008KT 10SM FEW015 BKN250 18/14 A2995 RMK AO2 SLP142 T01830144',
            visibility: { repr: '10 SM' },
            temperature: { repr: '18¬∞C', value: 18 },
            dewpoint: { repr: '14¬∞C' },
            altimeter: { repr: '29.95"', value: 29.95 },
            wind_direction: { repr: '250¬∞', value: 250 },
            wind_speed: { repr: '8 kts', value: 8 },
            elevation: { repr: '125 ft' }
        },
        'KORD': {
            raw: 'KORD 080253Z 27012KT 10SM BKN025 OVC035 08/04 A3018 RMK AO2 SLP225 T00830044',
            visibility: { repr: '10 SM' },
            temperature: { repr: '8¬∞C', value: 8 },
            dewpoint: { repr: '4¬∞C' },
            altimeter: { repr: '30.18"', value: 30.18 },
            wind_direction: { repr: '270¬∞', value: 270 },
            wind_speed: { repr: '12 kts', value: 12 },
            elevation: { repr: '672 ft' }
        },
        'KJFK': {
            raw: 'KJFK 080253Z 28010KT 10SM FEW030 SCT250 12/07 A3020 RMK AO2 SLP230 T01220067',
            visibility: { repr: '10 SM' },
            temperature: { repr: '12¬∞C', value: 12 },
            dewpoint: { repr: '7¬∞C' },
            altimeter: { repr: '30.20"', value: 30.20 },
            wind_direction: { repr: '280¬∞', value: 280 },
            wind_speed: { repr: '10 kts', value: 10 },
            elevation: { repr: '13 ft' }
        }
    };
    
    // Return specific airport data or generate realistic generic data
    if (mockData[upperCode]) {
        return mockData[upperCode];
    }
    
    // Generate realistic generic data for unknown airports
    const currentTime = new Date();
    const day = String(currentTime.getUTCDate()).padStart(2, '0');
    const hour = String(currentTime.getUTCHours()).padStart(2, '0');
    const minute = String(currentTime.getUTCMinutes()).padStart(2, '0');
    const timeString = `${day}${hour}${minute}Z`;
    
    // Generate realistic but varied weather conditions
    const windDirs = [360, 90, 180, 270, 140, 220, 310];
    const windSpeeds = [0, 5, 8, 12, 15];
    const temps = [8, 12, 18, 22, 25];
    const altimeters = [29.92, 30.05, 30.12, 30.18, 30.25];
    
    const windDir = windDirs[Math.floor(Math.random() * windDirs.length)];
    const windSpeed = windSpeeds[Math.floor(Math.random() * windSpeeds.length)];
    const temp = temps[Math.floor(Math.random() * temps.length)];
    const dewpoint = temp - Math.floor(Math.random() * 8) - 2; // Realistic dewpoint spread
    const altimeter = altimeters[Math.floor(Math.random() * altimeters.length)];
    
    const windString = windSpeed === 0 ? '00000KT' : `${String(windDir).padStart(3, '0')}${String(windSpeed).padStart(2, '0')}KT`;
    
    return {
        raw: `${upperCode} ${timeString} ${windString} 10SM CLR ${String(temp).padStart(2, '0')}/${String(dewpoint).padStart(2, '0')} A${Math.round(altimeter * 100)} RMK AO2`,
        visibility: { repr: '10 SM' },
        temperature: { repr: `${temp}¬∞C`, value: temp },
        dewpoint: { repr: `${dewpoint}¬∞C` },
        altimeter: { repr: `${altimeter.toFixed(2)}"`, value: altimeter },
        wind_direction: { repr: windSpeed === 0 ? 'CALM' : `${windDir}¬∞`, value: windDir },
        wind_speed: { repr: windSpeed === 0 ? 'CALM' : `${windSpeed} kts`, value: windSpeed },
        elevation: { repr: '1000 ft' }
    };
}

function updateWeatherPanel(weatherData, errorMessage = null) {
    try {
        // Update METAR display panel
        const metarDisplay = document.getElementById('metarDisplay');
        if (metarDisplay) {
            if (errorMessage) {
                metarDisplay.textContent = errorMessage;
                metarDisplay.style.color = '#FF9800';
            } else if (weatherData && weatherData.raw) {
                metarDisplay.textContent = weatherData.raw;
                metarDisplay.style.color = '#4CAF50';
            }
        }
        
        // Update Current Conditions panel with combined fields
        if (weatherData) {
            // Aprt. Wx. Observation (Zulu date/time)
            const wxObsElement = document.querySelector('[data-field="wxObs"]');
            if (wxObsElement) {
                wxObsElement.textContent = weatherData.obsTime || 'N/A';
            }
            
            // Surface Wind (direction/speed combined)
            const surfaceWindElement = document.querySelector('[data-field="surfaceWind"]');
            if (surfaceWindElement && weatherData.wind_direction && weatherData.wind_speed) {
                const windDir = weatherData.wind_direction.repr;
                const windSpeed = weatherData.wind_speed.repr;
                surfaceWindElement.textContent = `${windDir} at ${windSpeed}`;
            }
            
            // Vis/Weather (visibility + weather combined)
            const visWeatherElement = document.querySelector('[data-field="visWeather"]');
            if (visWeatherElement) {
                const vis = weatherData.visibility?.repr || 'N/A';
                const weather = weatherData.weather?.repr || 'N/A';
                visWeatherElement.textContent = `${vis} ${weather}`;
            }
            
            // Temp/Dew Pt. (temperature and dewpoint combined)
            const tempDewPtElement = document.querySelector('[data-field="tempDewPt"]');
            if (tempDewPtElement) {
                const temp = weatherData.temperature?.repr || 'N/A';
                const dewpt = weatherData.dewpoint?.repr || 'N/A';
                tempDewPtElement.textContent = `${temp}/${dewpt}`;
            }
            
            // Altimeter Setting
            const altimeterElement = document.querySelector('[data-field="altimeterSetting"]');
            if (altimeterElement) {
                altimeterElement.textContent = weatherData.altimeter?.repr || 'N/A';
            }
        }
        
        // Note: Crosswind, Headwind, Airport Elevation, Pressure Altitude, and Density Altitude
        // are calculated values that will be updated by the updateDisplays function
        
        // Also update form fields if they exist
        updateFormFieldsFromWeather(weatherData);
        
        console.log('Current Conditions panel and METAR display updated successfully');
        
    } catch (error) {
        console.error('Error updating weather panel:', error);
    }
}

function updateFormFieldsFromWeather(weatherData) {
    try {
        if (!weatherData) return;
        
        // Update Weather Observation with Zulu time
        if (weatherData.obsTime && weatherData.obsTime !== 'N/A') {
            const weatherObsField = document.getElementById('weatherObs');
            if (weatherObsField) {
                weatherObsField.value = weatherData.obsTime;
            }
        }
        
        // Update wind direction
        if (weatherData.wind_direction?.value !== undefined) {
            const windDirField = document.getElementById('windDirection');
            if (windDirField) {
                windDirField.value = weatherData.wind_direction.value;
            }
        }
        
        // Update wind speed
        if (weatherData.wind_speed?.value !== undefined) {
            const windSpeedField = document.getElementById('windSpeed');
            if (windSpeedField) {
                windSpeedField.value = weatherData.wind_speed.value;
            }
        }
        
        // Update visibility
        if (weatherData.visibility?.repr) {
            const visibilityField = document.getElementById('visibility');
            if (visibilityField) {
                // Extract numeric value from "10 SM" format, removing SM and any +
                const visValue = weatherData.visibility.repr.replace(' SM', '').replace('SM', '').replace('+', '');
                visibilityField.value = visValue;
                console.log('Updated visibility field:', visValue);
            } else {
                console.log('Visibility field not found');
            }
        } else {
            console.log('No visibility data:', weatherData.visibility);
        }
        
        // Update weather conditions
        if (weatherData.weather?.repr) {
            const weatherField = document.getElementById('weather');
            if (weatherField) {
                weatherField.value = weatherData.weather.repr;
                console.log('Updated weather field:', weatherData.weather.repr);
            } else {
                console.log('Weather field not found');
            }
        } else {
            console.log('No weather data:', weatherData.weather);
        }
        
        // Update temperature (keep in Celsius)
        if (weatherData.temperature?.value !== null && weatherData.temperature?.value !== undefined) {
            const tempField = document.getElementById('temperature');
            if (tempField) {
                tempField.value = weatherData.temperature.value;
            }
        }
        
        // Update dewpoint (keep in Celsius)
        if (weatherData.dewpoint?.repr && weatherData.dewpoint.repr !== 'N/A') {
            const dewpointField = document.getElementById('dewpoint');
            if (dewpointField) {
                // Extract numeric value from "1¬∞C" format
                const dewpointC = parseInt(weatherData.dewpoint.repr.replace('¬∞C', ''));
                if (!isNaN(dewpointC)) {
                    dewpointField.value = dewpointC;
                }
            }
        }
        
        // Update altimeter
        if (weatherData.altimeter?.value !== undefined) {
            const altimeterField = document.getElementById('altimeter');
            if (altimeterField) {
                altimeterField.value = weatherData.altimeter.value.toFixed(2);
            }
        }
        
        // Auto-select runway heading based on wind direction for optimal headwind
        if (weatherData.wind_direction?.value !== undefined && weatherData.wind_direction.value !== null) {
            const windDir = weatherData.wind_direction.value;
            const runwayHeadingField = document.getElementById('runwayHeading');
            
            if (runwayHeadingField) {
                let optimalRunway;
                
                // Determine which runway (18 or 36) provides better headwind
                // Runway 18 = 180¬∞ heading, Runway 36 = 360¬∞/0¬∞ heading
                const runway18Diff = Math.abs(windDir - 180);
                const runway36Diff = Math.min(Math.abs(windDir - 360), Math.abs(windDir - 0));
                
                // Choose runway that minimizes angle difference (maximizes headwind)
                if (runway18Diff <= runway36Diff) {
                    optimalRunway = '18';
                } else {
                    optimalRunway = '36';
                }
                
                runwayHeadingField.value = optimalRunway;
                console.log(`Auto-selected runway ${optimalRunway} for wind direction ${windDir}¬∞`);
            }
        }
        
        // Trigger calculations after all fields are updated
        setTimeout(() => {
            if (typeof updatePerformanceCalculations === 'function') {
                updatePerformanceCalculations();
            }
            if (typeof updateDisplays === 'function') {
                updateDisplays();
            }
        }, 100);
        
        console.log('Column A weather fields populated from METAR data');
        
    } catch (error) {
        console.error('Error updating form fields from weather:', error);
    }
}

// Hyperspace Canvas Effect - Donut Origin + Longer Streaks
(() => {
    const canvas = document.getElementById("hyperspace-canvas");
    const ctx = canvas.getContext("2d", { alpha: false });

    const TAU = Math.PI * 2;
    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
    const lerp = (a, b, t) => a + (b - a) * t;
    const rand = (a, b) => a + Math.random() * (b - a);

    let W = 0, H = 0, CX = 0, CY = 0, R = 0, dpr = 1;
    let beams = [];

    // PERFORMANCE
    const MAX_BEAMS = 160;       // Reduced for mobile performance
    const SOFT_CLEAR = 0.10;     // LOWER = longer persistence
    const USE_GLOW = false;      // Keep off for performance
    const MAX_DPR = 1.5;

    // LOOK: push origins away from center (donut), and make streaks last longer
    const BIRTH_MIN = 0.07;      // Minimum spawn radius (fraction of R)
    const BIRTH_MAX = 0.28;      // Maximum spawn radius (fraction of R)
    const ANGLE_JITTER_DEG = 1.8;

    // Longer streaks:
    const TAIL_MIN = 0.14;       // Fraction of R
    const TAIL_MAX = 0.40;       // Fraction of R
    const DEATH_FADE_MIN = 0.25; // Seconds
    const DEATH_FADE_MAX = 0.55; // Seconds

    function resize() {
        dpr = Math.max(1, Math.min(MAX_DPR, window.devicePixelRatio || 1));
        W = Math.floor(innerWidth * dpr);
        H = Math.floor(innerHeight * dpr);
        canvas.width = W;
        canvas.height = H;
        canvas.style.width = innerWidth + "px";
        canvas.style.height = innerHeight + "px";

        CX = W / 2;
        CY = H / 2;
        R = Math.hypot(CX, CY);

        for (const b of beams) b.target = R * rand(1.02, 1.18);

        // Adjust beam count for mobile
        const targetBeams = window.innerWidth < 768 ? 100 : MAX_BEAMS;
        while (beams.length < targetBeams) beams.push(newBeam());
        if (beams.length > targetBeams) beams.length = targetBeams;
    }
    window.addEventListener("resize", resize);

    function randomStartBlue() {
        return {
            r: Math.round(rand(70, 150)),
            g: Math.round(rand(130, 205)),
            b: Math.round(rand(220, 255))
        };
    }

    function birthRadius() {
        // Uniform in area for a donut (prevents "too many near center")
        // Area-uniform: sqrt(lerp(rmin^2, rmax^2, u))
        const rmin = BIRTH_MIN * R;
        const rmax = BIRTH_MAX * R;
        const u = Math.random();
        return Math.sqrt(lerp(rmin * rmin, rmax * rmax, u));
    }

    function newBeam() {
        const jitter = (ANGLE_JITTER_DEG * Math.PI / 180) * rand(-1, 1);
        const ang = rand(0, TAU) + jitter;

        const depth = Math.pow(Math.random(), 1.7); // Far dominates

        const edgeW = lerp(2, 20, 1 - depth) * (Math.random() < 0.10 ? rand(1.4, 2.1) : 1);
        const startW = Math.max(0.35, edgeW * rand(0.02, 0.07));

        const target = R * rand(1.02, 1.18);

        // Slightly slower overall => rays persist longer before edge
        const speed = lerp(520, 1650, 1 - depth) * rand(0.85, 1.10); // Reduced for performance

        const tailPx = lerp(R * TAIL_MIN, R * TAIL_MAX, 1 - depth) * rand(0.85, 1.15);
        const deathFade = rand(DEATH_FADE_MIN, DEATH_FADE_MAX);

        const startCol = randomStartBlue();
        const alpha = lerp(0.08, 0.20, 1 - depth); // Reduced for performance
        const glow = lerp(4, 12, 1 - depth); // Reduced for performance

        const birth = birthRadius();

        return {
            ang, depth,
            startW, edgeW,
            startCol,
            alpha, glow,

            birth,
            head: birth,
            speed,
            tailPx,
            target,

            dead: false,
            deathT: 0,
            deathFade
        };
    }

    function softClear() {
        ctx.globalCompositeOperation = "source-over";
        ctx.fillStyle = `rgba(0,0,0,${SOFT_CLEAR})`;
        ctx.fillRect(0, 0, W, H);
    }

    function centerBloom() {
        // Keep subtle so it doesn't read as "everything starts at center"
        const g = ctx.createRadialGradient(CX, CY, 0, CX, CY, R * 0.18);
        g.addColorStop(0, "rgba(20,40,90,0.05)");
        g.addColorStop(1, "rgba(0,0,0,0)");
        ctx.globalCompositeOperation = "source-over";
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, W, H);
    }

    function drawBeam(b, dt, t) {
        const ca = Math.cos(b.ang), sa = Math.sin(b.ang);
        const px = -sa, py = ca;

        if (!b.dead) {
            b.head += b.speed * dt;
            if (b.head >= b.target) {
                b.dead = true;
                b.deathT = 0;
            }
        } else {
            b.deathT += dt;
        }

        const head = Math.min(b.head, b.target);

        let deathK = 1;
        if (b.dead) {
            const u = clamp(b.deathT / b.deathFade, 0, 1);
            deathK = 1 - u;
        }

        const tailLen = b.tailPx * deathK;
        let tail = head - tailLen;

        // Critical: never draw behind the birth radius -> prevents hard convergence to center
        tail = Math.max(b.birth, tail);

        if (b.dead && deathK <= 0.001) {
            Object.assign(b, newBeam());
            return;
        }

        if (head - tail < 1) return;

        const x0 = CX + ca * tail, y0 = CY + sa * tail;
        const x1 = CX + ca * head, y1 = CY + sa * head;

        const r0 = tail / b.target;
        const r1 = head / b.target;
        const w0 = lerp(b.startW, b.edgeW, clamp(r0, 0, 1));
        const w1 = lerp(b.startW, b.edgeW, clamp(r1, 0, 1));

        // Color to white at edge
        const { r, g, b: bb } = b.startCol;
        const whiten = clamp(r1 * 1.25, 0, 1);
        const er = Math.round(lerp(r, 255, whiten));
        const eg = Math.round(lerp(g, 255, whiten));
        const eb = Math.round(lerp(bb, 255, whiten));

        const pulse = 0.90 + 0.10 * Math.sin(t * 5.5 + b.ang * 2.4);
        const a = b.alpha * pulse * deathK;

        const grad = ctx.createLinearGradient(x0, y0, x1, y1);
        grad.addColorStop(0.0, `rgba(${r},${g},${bb},0)`);
        grad.addColorStop(0.18, `rgba(${r},${g},${bb},${a * 0.55})`);
        grad.addColorStop(0.80, `rgba(${er},${eg},${eb},${a * 0.92})`);
        grad.addColorStop(1.0, `rgba(${er},${eg},${eb},${a})`);

        ctx.save();
        ctx.globalCompositeOperation = "lighter";
        if (USE_GLOW) {
            ctx.shadowBlur = b.glow;
            ctx.shadowColor = `rgba(${er},${eg},${eb},${Math.min(1, a * 1.4)})`;
        } else {
            ctx.shadowBlur = 0;
        }

        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.moveTo(x0 + px * w0, y0 + py * w0);
        ctx.lineTo(x1 + px * w1, y1 + py * w1);
        ctx.lineTo(x1 - px * w1, y1 - py * w1);
        ctx.lineTo(x0 - px * w0, y0 - py * w0);
        ctx.closePath();
        ctx.fill();
        ctx.restore();
    }

    let last = 0;
    function frame(ms) {
        const t = ms * 0.001;
        const dt = last ? Math.min(0.033, (ms - last) * 0.001) : 0.016;
        last = ms;

        softClear();
        centerBloom();

        // Cheap shuffle to break bands
        for (let i = 0; i < 3; i++) { // Reduced for performance
            const a = (Math.random() * beams.length) | 0;
            const b = (Math.random() * beams.length) | 0;
            const tmp = beams[a]; beams[a] = beams[b]; beams[b] = tmp;
        }

        for (const beam of beams) drawBeam(beam, dt, t);
        requestAnimationFrame(frame);
    }

    // Initialize
    resize();
    ctx.fillStyle = "#000";
    ctx.fillRect(0, 0, W, H);
    while (beams.length < MAX_BEAMS) beams.push(newBeam());
    requestAnimationFrame(frame);
})();

// Lightspeed Mode Toggle
(() => {
    // Default state: lightspeed mode OFF
    let lightspeedMode = false;
    
    // Set initial state
    document.body.classList.add('lightspeed-off');
    
    // Get the toggle element
    const toggle = document.getElementById('lightspeed-toggle');
    if (!toggle) return;
    
    // Get both canvases
    const hyperspaceCanvas = document.getElementById('hyperspace-canvas');
    const normalspaceCanvas = document.getElementById('normalspace-canvas');
    
    // Toggle function
    function toggleLightspeed() {
        lightspeedMode = !lightspeedMode;
        
        if (lightspeedMode) {
            // Turn ON lightspeed mode
            document.body.classList.remove('lightspeed-off');
            document.body.classList.add('lightspeed-on');
        } else {
            // Turn OFF lightspeed mode
            document.body.classList.remove('lightspeed-on');
            document.body.classList.add('lightspeed-off');
        }
    }
    
    // Add click event listener
    toggle.addEventListener('click', toggleLightspeed);
    
    // Add subtle hover effect
    toggle.addEventListener('mouseenter', () => {
        toggle.style.transform = 'scale(1.05)';
    });
    
    toggle.addEventListener('mouseleave', () => {
        toggle.style.transform = 'scale(1)';
    });
})();

// Normal Space Effect - Lightweight Stars
(() => {
    const canvas = document.getElementById("normalspace-canvas");
    const ctx = canvas.getContext("2d", { alpha: false });

    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
    const lerp = (a, b, t) => a + (b - a) * t;
    const rand = (a, b) => a + Math.random() * (b - a);

    let W = 0, H = 0, dpr = 1;
    let stars = [];

    // PERFORMANCE KNOBS (tune these first)
    const MAX_DPR = 1.25;       // cap retina cost hard (big perf win)
    const STAR_COUNT = 260;     // fewer stars
    const USE_GLOW = false;     // glow is expensive; keep off
    const TWINKLE = true;       // can turn off if needed
    const DRIFT = 10;           // px/sec (device px)

    function resize() {
        dpr = Math.max(1, Math.min(MAX_DPR, window.devicePixelRatio || 1));
        W = Math.floor(innerWidth * dpr);
        H = Math.floor(innerHeight * dpr);
        canvas.width = W;
        canvas.height = H;
        canvas.style.width = innerWidth + "px";
        canvas.style.height = innerHeight + "px";
        initStars();
    }
    window.addEventListener("resize", resize);

    function randomBlueWhite() {
        // mostly white, sometimes blue-ish
        if (Math.random() < 0.65) return { r: 255, g: 255, b: 255 };
        return {
            r: Math.round(rand(140, 210)),
            g: Math.round(rand(170, 235)),
            b: 255
        };
    }

    function initStars() {
        stars = new Array(STAR_COUNT).fill(0).map(() => {
            const depth = Math.pow(Math.random(), 2.2); // far dominates
            const sizeNorm = 1 - depth;

            const r = lerp(0.6, 2.4, Math.pow(sizeNorm, 1.1)) * (Math.random() < 0.03 ? rand(1.8, 2.8) : 1);
            const a = lerp(0.18, 0.95, Math.pow(sizeNorm, 0.9));

            // simple parallax drift
            const sp = DRIFT * lerp(0.35, 1.4, sizeNorm) * rand(0.8, 1.2);
            const ang = rand(0, Math.PI * 2);
            const vx = Math.cos(ang) * sp;
            const vy = Math.sin(ang) * sp;

            return {
                x: rand(0, W),
                y: rand(0, H),
                vx, vy,
                r,
                a,
                col: randomBlueWhite(),
                twSpeed: rand(0.5, 1.3),
                twPhase: rand(0, Math.PI * 2)
            };
        });
    }

    function wrap(s) {
        const pad = s.r * 4;
        if (s.x < -pad) s.x = W + pad;
        else if (s.x > W + pad) s.x = -pad;

        if (s.y < -pad) s.y = H + pad;
        else if (s.y > H + pad) s.y = -pad;
    }

    // Precompute a single background gradient per resize (cheaper than remaking every frame)
    let bg = null;
    function rebuildBg() {
        bg = ctx.createRadialGradient(W * 0.5, H * 0.45, 0, W * 0.5, H * 0.45, Math.hypot(W, H) * 0.6);
        // keep it simple/cheap
        bg.addColorStop(0, "rgb(2,4,10)");
        bg.addColorStop(1, "rgb(0,0,0)");
    }

    let last = 0;
    function frame(ms) {
        const t = ms * 0.001;
        const dt = last ? Math.min(0.05, (ms - last) * 0.001) : 0.016;
        last = ms;

        // background
        ctx.globalCompositeOperation = "source-over";
        ctx.fillStyle = bg;
        ctx.fillRect(0, 0, W, H);

        // stars
        ctx.globalCompositeOperation = "lighter";
        ctx.shadowBlur = 0;

        for (const s of stars) {
            s.x += s.vx * dt;
            s.y += s.vy * dt;
            wrap(s);

            const tw = TWINKLE ? (0.85 + 0.15 * Math.sin(s.twPhase + t * s.twSpeed)) : 1;
            const a = clamp(s.a * tw, 0, 1);

            const { r, g, b } = s.col;

            if (USE_GLOW) {
                ctx.shadowBlur = Math.min(8, s.r * 5);
                ctx.shadowColor = `rgba(${r},${g},${b},${a})`;
            }

            ctx.fillStyle = `rgba(${r},${g},${b},${a})`;
            ctx.beginPath();
            ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
            ctx.fill();
        }

        ctx.globalCompositeOperation = "source-over";
        requestAnimationFrame(frame);
    }

    resize();
    rebuildBg();
    requestAnimationFrame(frame);

    // rebuild gradient after resize
    window.addEventListener("resize", () => {
        rebuildBg();
    });
})();
</script>
</body>
</html>
